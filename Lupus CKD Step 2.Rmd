---
title: "LUPUS CKD Step 2"
author: "Iftach, Itamar, Oshrat"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: yes
    number_sections: yes
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 3
    theme: simplex
    code_download: yes
---
#Packeges
```{r, message = FALSE,echo=FALSE,warning = FALSE}
knitr::opts_chunk$set(dpi=300,fig.width=7)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
library("readr")
library("gtsummary")
library(survey) # Add this line to load the required package
library("tidyverse")
library("dplyr")
library("ggplot2")
library("survival")
library("survminer")
library("ggfortify")
library("broom")
library("ggsurvfit")
library("gt")
library("forcats")
library("gridExtra")
library("smd")
library("RColorBrewer")
library("lubridate")

library("flextable")
```

#P-v def
```{r}

custom_pvalue_fun <- function(x) {
  formatted_p <- vapply(x, function(p) {
    if (is.na(p)) {
      return(NA_character_)
    } else if (p < 0.001) {
      return("<0.001")
    } else if (p <= 0.05) {
      return(substr(sprintf("%.3f", p), 1, 5)) # Truncate to 3 decimals
    } else {
      return(substr(sprintf("%.3f", p), 1, 4)) # Truncate to 2 decimals
    }
  }, character(1))
  
  return(formatted_p)
}

```


#CHUNK 1: Setup and Helper Functions 

```{r}
## ============================================================================
##  CHUNK 1: Setup and Helper Functions (FIXED)
## ============================================================================

library(dplyr)
library(stringr)
library(lubridate)
library(purrr)
library(tidyr)
library(readr)

## -----------------------------
##  Helper Functions
## -----------------------------

# Fix column names: standardize separators AND remove special characters
fix_cols <- function(dt) {
  nm <- names(dt)
  nm <- gsub("-", "_", nm)
  nm <- gsub(" ", "_", nm)
  nm <- gsub("%", "pct", nm)
  nm <- gsub("\\(", "", nm)
  nm <- gsub("\\)", "", nm)
  nm <- gsub("\\[", "", nm)
  nm <- gsub("\\]", "", nm)
  nm <- gsub("\\$", "", nm)
  nm <- gsub("\\#", "", nm)
  nm <- gsub("&", "and", nm)
  nm <- gsub("\\+", "plus", nm)
  nm <- gsub("\\*", "star", nm)
  nm <- gsub("/", "_", nm)
  nm <- gsub("\\\\", "_", nm)
  nm <- gsub("\\?", "", nm)
  nm <- gsub("!", "", nm)
  nm <- gsub("@", "at", nm)
  nm <- gsub("\\^", "", nm)
  nm <- gsub("~", "", nm)
  nm <- gsub("`", "", nm)
  nm <- gsub("'", "", nm)
  nm <- gsub('"', "", nm)
  nm <- gsub(",", "", nm)
  nm <- gsub(";", "", nm)
  nm <- gsub(":", "", nm)
  nm <- gsub("\\|", "_", nm)
  nm <- gsub("<", "lt", nm)
  nm <- gsub(">", "gt", nm)
  nm <- gsub("=", "eq", nm)
  nm <- gsub("__+", "_", nm, perl = TRUE)
  nm <- gsub("^_", "", nm)
  nm <- gsub("_$", "", nm)
  names(dt) <- nm
  dt
}

# FIXED: Normalize ID - remove X prefix that R adds, DON'T strip hex format
norm_id <- function(x) {
  x <- as.character(x)
  x <- trimws(x)
  # Remove the X prefix that R adds automatically when reading IDs
  x <- sub("^X", "", x)
  # DON'T remove leading zeros - this corrupts hex IDs like 0x...
  x[x == ""] <- NA
  x
}

# Safe reducers
min_na <- function(x) if (all(is.na(x))) NA_real_ else suppressWarnings(min(x, na.rm = TRUE))
pmin2  <- function(a,b) ifelse(is.na(a) & is.na(b), NA_real_, pmin(a,b, na.rm = TRUE))

cat("✓ Chunk 1 complete: Libraries and FIXED helpers loaded\n")
```




#CHUNK 2: Load Data and FIX Column Names 
```{r}
## ============================================================================
##  CHUNK 2: Load Data and Standardize Column Names (CORRECTED)
## ============================================================================
cat("\n=== CHUNK 2: Loading and standardizing data ===\n\n")

lupus_original_file=read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/all_data.csv",  locale = locale(encoding = "UTF-8"))

lupus_original_file <- fix_cols(lupus_original_file)

GFR_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][GFR][v-ruthsm_nat][qe_34041][20251120_163116908_6658].csv",  locale = locale(encoding = "UTF-8"))

ALBUMIN_CR_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][ALBUMIN_CREATININE_RATIO][v-ruthsm_nat][qe_34041][20251120_163116896_7041].csv",  locale = locale(encoding = "UTF-8"))

PROTEINURIA_24HR_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][PROTEINURIA_24hr][v-ruthsm_nat][qe_34041][20251120_163116886_8203].csv",  locale = locale(encoding = "UTF-8"))


PROTEINURIA_ALBUMIN_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][PROTEINURIA_albumin][v-ruthsm_nat][qe_34041][20251120_163116890_1591].csv",  locale = locale(encoding = "UTF-8"))


PROTEINE_CREATININE_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][Proteinuria_proteincreatinine][v-ruthsm_nat][qe_34041][20251120_163116900_1219].csv",  locale = locale(encoding = "UTF-8"))


PROTERIN_URINE_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][PROTEINURIA_urine_sample][v-ruthsm_nat][qe_34041][20251120_163116904_7738].csv",  locale = locale(encoding = "UTF-8"))

Baseline <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[46456][CUSTOMIZED][v-ruthsm_nat][qe_34041][20251120_163116881_3588].csv",  locale = locale(encoding = "UTF-8"))

lupus_file <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/Lupus_360_Itamar.csv")


HYDROXY_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[47088][Hydroxychloroquine_first_99][v-ruthsm_nat][qe_34479][20251207_164037266_1904].csv",  locale = locale(encoding = "UTF-8"))
PREDNISONE_FIRST_99 <- read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/itamarIftach- LupusSGLT2 Second step 201125/[47088][Prednisone_first_99][v-ruthsm_nat][qe_34479][20251207_164037271_5869].csv",  locale = locale(encoding = "UTF-8"))

HYDROXY_FIRST_99 <- fix_cols(HYDROXY_FIRST_99)
PREDNISONE_FIRST_99 <- fix_cols(PREDNISONE_FIRST_99)

lupus_file <- fix_cols(lupus_file)


PROTERIN_URINE_FIRST_99 <- fix_cols(PROTERIN_URINE_FIRST_99)
PROTEINE_CREATININE_FIRST_99 <- fix_cols(PROTEINE_CREATININE_FIRST_99)
PROTEINURIA_ALBUMIN_FIRST_99 <- fix_cols(PROTEINURIA_ALBUMIN_FIRST_99)
PROTEINURIA_24HR_FIRST_99 <- fix_cols(PROTEINURIA_24HR_FIRST_99)
ALBUMIN_CR_FIRST_99 <- fix_cols(ALBUMIN_CR_FIRST_99)
GFR_FIRST_99 <- fix_cols(GFR_FIRST_99)
Baseline <- fix_cols(Baseline)


colnames(PROTERIN_URINE_FIRST_99)
colnames(PROTEINE_CREATININE_FIRST_99)
colnames(PROTEINURIA_ALBUMIN_FIRST_99)
colnames(PROTEINURIA_24HR_FIRST_99)
colnames(ALBUMIN_CR_FIRST_99)
colnames(GFR_FIRST_99)


colnames(HYDROXY_FIRST_99)

colnames(PREDNISONE_FIRST_99)



```

#CHUNK 3: Merge Baseline + Lupus file and Prepare GFR Data
```{r}
# ============================================================================
# CHUNK 3: Merge Baseline + Lupus file and Prepare GFR Data (±1 year)
# ============================================================================

cat("\n=== CHUNK 3: Merging data and preparing baseline GFR (±1 year) ===\n\n")

merged <- Baseline %>%
  inner_join(
    lupus_file %>% dplyr::select(patient_id, matched_lupus_start_date, Lupus),
    by = "patient_id",
    suffix = c("", "_lupus")
  ) %>%
  mutate(
    # Index date = matched lupus start date for EVERYONE
    index_date = as.Date(matched_lupus_start_date),
    year = year(index_date),
    
    # Convert important dates
    birth_date = as.Date(birth_date),
    death_date = as.Date(death_deceased_date),
    eskd_date = as.Date(eskd_start_date),
    
    # MACE - now using days from reference
    mace_date = index_date + mace_without_death_start_date_days_from_reference,
    
    stroke_date = as.Date(stroke_start_date),
    
    # Calculate age at index
    age_at_index = as.numeric(difftime(index_date, birth_date, units = "days")) / 365.25
  ) %>%
  filter(year >= 2015 & year <= 2023)

cat("Total patients (2015-2023):", nrow(merged), "\n")
cat("Lupus cases:", sum(merged$Lupus == 1), "\n")
cat("Controls:", sum(merged$Lupus == 0), "\n\n")

```

```{r}

# Step 3.2: Get baseline GFR (±1 year from index)
# If multiple measurements within 90 days of each other, average them
baseline_gfr_prep <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    GFR_FIRST_99 %>% dplyr::select(mdcinternalpatientid, gfr_ckd_epi, gfr_gfr_category, gfr_start_date),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    gfr_date = as.Date(gfr_start_date),
    days_diff = as.numeric(difftime(gfr_date, index_date, units = "days"))
  ) %>%
  # Keep measurements from 365 days before to 365 days after index
  filter(days_diff >= -365 & days_diff <= 365) %>%
  arrange(mdcinternalpatientid, gfr_date)

# For each patient, group measurements within 90 days and average them
baseline_gfr <- baseline_gfr_prep %>%
  group_by(mdcinternalpatientid) %>%
  mutate(
    # Calculate days between consecutive measurements
    days_since_prev = c(NA, diff(as.numeric(gfr_date))),
    # Create groups: new group if >90 days since previous measurement
    measurement_group = cumsum(is.na(days_since_prev) | days_since_prev > 90)
  ) %>%
  # Average within each measurement group
  group_by(mdcinternalpatientid, measurement_group) %>%
  summarise(
    baseline_gfr = mean(gfr_ckd_epi, na.rm = TRUE),
    baseline_gfr_date = min(gfr_date),  # Use earliest date in group
    n_measurements_averaged = n(),
    days_diff = mean(days_diff),
    .groups = "drop"
  ) %>%
  # For each patient, keep the measurement group closest to index
  group_by(mdcinternalpatientid) %>%
  arrange(abs(days_diff)) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_gfr_category = case_when(
      baseline_gfr >= 90 ~ "G1",
      baseline_gfr >= 60 ~ "G2",
      baseline_gfr >= 45 ~ "G3a",
      baseline_gfr >= 30 ~ "G3b",
      baseline_gfr >= 15 ~ "G4",
      TRUE ~ "G5"
    ),
    baseline_gfr_days_from_index = days_diff
  ) %>%
  dplyr::select(mdcinternalpatientid, baseline_gfr, baseline_gfr_category, 
                baseline_gfr_date, baseline_gfr_days_from_index, n_measurements_averaged)

# Merge baseline GFR
merged <- merged %>%
  left_join(baseline_gfr, by = "mdcinternalpatientid")

# Summary
cat("=== Baseline GFR Summary (±1 year, averaged if <90 days apart) ===\n")
cat("Patients with baseline GFR:", sum(!is.na(merged$baseline_gfr)), "\n")
cat("Patients with GFR > 60:", sum(merged$baseline_gfr > 60, na.rm = TRUE), "\n")
cat("Patients with GFR <= 60:", sum(merged$baseline_gfr <= 60, na.rm = TRUE), "\n\n")

cat("Mean baseline GFR:", round(mean(merged$baseline_gfr, na.rm = TRUE), 1), "\n")
cat("Median baseline GFR:", round(median(merged$baseline_gfr, na.rm = TRUE), 1), "\n")
cat("Mean days from index to GFR:", round(mean(merged$baseline_gfr_days_from_index, na.rm = TRUE), 1), "\n")
cat("Median days from index to GFR:", round(median(merged$baseline_gfr_days_from_index, na.rm = TRUE), 1), "\n\n")

cat("Measurements averaged:\n")
print(table(merged$n_measurements_averaged, useNA = "ifany"))

cat("\nBaseline GFR categories:\n")
print(table(merged$baseline_gfr_category, useNA = "ifany"))

cat("\nTiming of GFR measurements:\n")
cat("Before index:", sum(merged$baseline_gfr_days_from_index < 0, na.rm = TRUE), "\n")
cat("After index:", sum(merged$baseline_gfr_days_from_index > 0, na.rm = TRUE), "\n")

# Step 3.3: Create Ever Smoker Variable
cat("\n=== Creating smoking variable ===\n")

merged <- merged %>%
  mutate(
    ever_smoker = case_when(
      smoking_by_life_style_smoking_status == "מעולם לא" ~ 0,  # Never Smoker
      TRUE ~ 1  # All other categories (Current, Past, etc.) are Ever Smoker
    )
  )

# Verify the result
cat("Ever smoker distribution:\n")
print(table(merged$ever_smoker, useNA = "always"))

cat("\n✓ Chunk 3 complete\n")
```







#CHUNK 4: Prepare Proteinuria Data - Identify Baseline ACR and PCR
```{r}
# ============================================================================
# CHUNK 4 ENHANCED: Maximum Proteinuria Detection (±1 year)
# ============================================================================

cat("\n=== CHUNK 4 ENHANCED: Preparing baseline proteinuria from ALL sources (±1 year) ===\n\n")

# ============================================================================
# Source 1: ACR (Albumin-to-Creatinine Ratio) - PRIMARY SOURCE
# ============================================================================

cat("Processing ACR data...\n")

baseline_acr_prep <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    ALBUMIN_CR_FIRST_99 %>% dplyr::select(mdcinternalpatientid, 
                                           albumin_creatinine_ratio_result_as_number,
                                           albumin_creatinine_ratio_result_date,
                                           albumin_creatinine_ratio_result_unit),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    acr_date = as.Date(albumin_creatinine_ratio_result_date, origin = "1970-01-01"),
    days_diff = as.numeric(difftime(acr_date, index_date, units = "days")),
    # Standardize to mg/g
    acr_mg_g = case_when(
      albumin_creatinine_ratio_result_unit %in% c("mg/g", "mg/g Crea", "mg/g creat", "mg/gr", "mg/gr Cr") ~ 
        albumin_creatinine_ratio_result_as_number,
      albumin_creatinine_ratio_result_unit %in% c("µg/mg", "µg/mg cr", "µg/mg creat", "mcg/mg", "ug/mg CREA", "µG/mg cr") ~ 
        albumin_creatinine_ratio_result_as_number,  # µg/mg = mg/g
      albumin_creatinine_ratio_result_unit %in% c("mg/mg", "mg/mg cr", "mg/mg creat") ~ 
        albumin_creatinine_ratio_result_as_number * 1000,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(days_diff >= -365 & days_diff <= 365, !is.na(acr_mg_g), acr_mg_g >= 0) %>%
  arrange(mdcinternalpatientid, acr_date)

baseline_acr <- baseline_acr_prep %>%
  group_by(mdcinternalpatientid) %>%
  mutate(
    days_since_prev = c(NA, diff(as.numeric(acr_date))),
    measurement_group = cumsum(is.na(days_since_prev) | days_since_prev > 90)
  ) %>%
  group_by(mdcinternalpatientid, measurement_group) %>%
  summarise(
    baseline_acr = mean(acr_mg_g, na.rm = TRUE),
    baseline_acr_date = min(acr_date),
    n_acr_averaged = n(),
    days_diff = mean(days_diff),
    .groups = "drop"
  ) %>%
  group_by(mdcinternalpatientid) %>%
  arrange(abs(days_diff)) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_acr_days_from_index = days_diff,
    acr_proteinuria = ifelse(baseline_acr >= 30, 1, 0)
  ) %>%
  dplyr::select(mdcinternalpatientid, baseline_acr, baseline_acr_date, 
                baseline_acr_days_from_index, n_acr_averaged, acr_proteinuria)

cat("ACR processed:", nrow(baseline_acr), "patients\n")

# ============================================================================
# Source 2: PCR (Protein-to-Creatinine Ratio)
# ============================================================================

cat("Processing PCR data...\n")

baseline_pcr_prep <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    PROTEINE_CREATININE_FIRST_99 %>% dplyr::select(mdcinternalpatientid, 
                                                    proteinuria_protein_creatinine_result_as_number,
                                                    proteinuria_protein_creatinine_result_date,
                                                    proteinuria_protein_creatinine_result_unit),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    pcr_date = as.Date(proteinuria_protein_creatinine_result_date, origin = "1970-01-01"),
    days_diff = as.numeric(difftime(pcr_date, index_date, units = "days")),
    # Standardize to mg/g
    pcr_mg_g = case_when(
      proteinuria_protein_creatinine_result_unit %in% c("mg/g", "mg/g Crea", "mg/g creat", "mg/gr", "mg/gr creat") ~ 
        proteinuria_protein_creatinine_result_as_number,
      proteinuria_protein_creatinine_result_unit %in% c("mg/mg", "mg/mg") ~ 
        proteinuria_protein_creatinine_result_as_number * 1000,
      proteinuria_protein_creatinine_result_unit %in% c("grP/grC") ~ 
        proteinuria_protein_creatinine_result_as_number * 1000,
      proteinuria_protein_creatinine_result_unit %in% c("mcg/mg") ~ 
        proteinuria_protein_creatinine_result_as_number,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(days_diff >= -365 & days_diff <= 365, !is.na(pcr_mg_g), pcr_mg_g >= 0) %>%
  arrange(mdcinternalpatientid, pcr_date)

baseline_pcr <- baseline_pcr_prep %>%
  group_by(mdcinternalpatientid) %>%
  mutate(
    days_since_prev = c(NA, diff(as.numeric(pcr_date))),
    measurement_group = cumsum(is.na(days_since_prev) | days_since_prev > 90)
  ) %>%
  group_by(mdcinternalpatientid, measurement_group) %>%
  summarise(
    baseline_pcr = mean(pcr_mg_g, na.rm = TRUE),
    baseline_pcr_date = min(pcr_date),
    n_pcr_averaged = n(),
    days_diff = mean(days_diff),
    .groups = "drop"
  ) %>%
  group_by(mdcinternalpatientid) %>%
  arrange(abs(days_diff)) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_pcr_days_from_index = days_diff,
    pcr_proteinuria = ifelse(baseline_pcr >= 150, 1, 0)
  ) %>%
  dplyr::select(mdcinternalpatientid, baseline_pcr, baseline_pcr_date, 
                baseline_pcr_days_from_index, n_pcr_averaged, pcr_proteinuria)

cat("PCR processed:", nrow(baseline_pcr), "patients\n")

# ============================================================================
# Source 3: 24-hour Protein (use numeric values only)
# ============================================================================

cat("Processing 24-hour protein data...\n")

baseline_24hr_prep <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    PROTEINURIA_24HR_FIRST_99 %>% dplyr::select(mdcinternalpatientid, 
                                                 proteinuria_24hr_result_as_number,
                                                 proteinuria_24hr_result_date),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    protein_24hr_date = as.Date(proteinuria_24hr_result_date, origin = "1970-01-01"),
    days_diff = as.numeric(difftime(protein_24hr_date, index_date, units = "days"))
  ) %>%
  filter(days_diff >= -365 & days_diff <= 365, 
         !is.na(proteinuria_24hr_result_as_number), 
         proteinuria_24hr_result_as_number >= 0,
         proteinuria_24hr_result_as_number < 50000) %>%  # Remove extreme outliers
  arrange(mdcinternalpatientid, protein_24hr_date)

baseline_24hr <- baseline_24hr_prep %>%
  group_by(mdcinternalpatientid) %>%
  mutate(
    days_since_prev = c(NA, diff(as.numeric(protein_24hr_date))),
    measurement_group = cumsum(is.na(days_since_prev) | days_since_prev > 90)
  ) %>%
  group_by(mdcinternalpatientid, measurement_group) %>%
  summarise(
    baseline_24hr_protein = mean(proteinuria_24hr_result_as_number, na.rm = TRUE),
    baseline_24hr_date = min(protein_24hr_date),
    n_24hr_averaged = n(),
    days_diff = mean(days_diff),
    .groups = "drop"
  ) %>%
  group_by(mdcinternalpatientid) %>%
  arrange(abs(days_diff)) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_24hr_days_from_index = days_diff,
    protein_24hr_proteinuria = ifelse(baseline_24hr_protein >= 150, 1, 0)
  ) %>%
  dplyr::select(mdcinternalpatientid, baseline_24hr_protein, baseline_24hr_date, 
                baseline_24hr_days_from_index, n_24hr_averaged, protein_24hr_proteinuria)

cat("24-hour protein processed:", nrow(baseline_24hr), "patients\n")

# ============================================================================
# Source 4: Spot Albumin (convert mg/L to estimated ACR where beneficial)
# ============================================================================

cat("Processing spot albumin data...\n")

baseline_spot_alb_prep <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    PROTEINURIA_ALBUMIN_FIRST_99 %>% dplyr::select(mdcinternalpatientid, 
                                                    proteinuria_albumin_result_as_number,
                                                    proteinuria_albumin_result_date,
                                                    proteinuria_albumin_result_unit),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    spot_alb_date = as.Date(proteinuria_albumin_result_date, origin = "1970-01-01"),
    days_diff = as.numeric(difftime(spot_alb_date, index_date, units = "days")),
    # Convert all to mg/L
    albumin_mg_l = case_when(
      proteinuria_albumin_result_unit %in% c("mg/L", "Mg/L", "MG/L", "mg/l") ~ 
        proteinuria_albumin_result_as_number,
      proteinuria_albumin_result_unit %in% c("µg/ml", "µg/mL", "ug/ml") ~ 
        proteinuria_albumin_result_as_number,  # µg/ml = mg/L
      proteinuria_albumin_result_unit %in% c("mg/dL", "mg/dl") ~ 
        proteinuria_albumin_result_as_number * 10,
      TRUE ~ NA_real_
    ),
    # Rough conversion: albumin >20 mg/L suggests elevated (corresponds to ACR ~30)
    # This is rough but allows us to include more patients
    estimated_acr_elevated = albumin_mg_l > 20
  ) %>%
  filter(days_diff >= -365 & days_diff <= 365, !is.na(albumin_mg_l), albumin_mg_l >= 0) %>%
  arrange(mdcinternalpatientid, spot_alb_date)

baseline_spot_alb <- baseline_spot_alb_prep %>%
  group_by(mdcinternalpatientid) %>%
  mutate(
    days_since_prev = c(NA, diff(as.numeric(spot_alb_date))),
    measurement_group = cumsum(is.na(days_since_prev) | days_since_prev > 90)
  ) %>%
  group_by(mdcinternalpatientid, measurement_group) %>%
  summarise(
    baseline_spot_albumin = mean(albumin_mg_l, na.rm = TRUE),
    baseline_spot_alb_date = min(spot_alb_date),
    n_spot_alb_averaged = n(),
    days_diff = mean(days_diff),
    .groups = "drop"
  ) %>%
  group_by(mdcinternalpatientid) %>%
  arrange(abs(days_diff)) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_spot_alb_days_from_index = days_diff,
    spot_alb_proteinuria = ifelse(baseline_spot_albumin > 20, 1, 0)
  ) %>%
  dplyr::select(mdcinternalpatientid, baseline_spot_albumin, baseline_spot_alb_date, 
                baseline_spot_alb_days_from_index, n_spot_alb_averaged, spot_alb_proteinuria)

cat("Spot albumin processed:", nrow(baseline_spot_alb), "patients\n")

# ============================================================================
# Source 5: Spot Urine Protein
# ============================================================================

cat("Processing spot urine protein data...\n")

baseline_spot_prot_prep <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    PROTERIN_URINE_FIRST_99 %>% dplyr::select(mdcinternalpatientid, 
                                               proteinuria_urine_sample_result_as_number,
                                               proteinuria_urine_sample_result_date,
                                               proteinuria_urine_sample_result_unit),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    spot_prot_date = as.Date(proteinuria_urine_sample_result_date, origin = "1970-01-01"),
    days_diff = as.numeric(difftime(spot_prot_date, index_date, units = "days")),
    # Convert to mg/dL
    protein_mg_dl = case_when(
      proteinuria_urine_sample_result_unit %in% c("mg/dL", "mg/dl", "mg%") ~ 
        proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_unit %in% c("mg/L", "mg/l", "MG/L") ~ 
        proteinuria_urine_sample_result_as_number / 10,
      proteinuria_urine_sample_result_unit %in% c("g/L", "g/l") ~ 
        proteinuria_urine_sample_result_as_number * 100,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(days_diff >= -365 & days_diff <= 365, !is.na(protein_mg_dl), protein_mg_dl >= 0, protein_mg_dl < 1000) %>%
  arrange(mdcinternalpatientid, spot_prot_date)

baseline_spot_prot <- baseline_spot_prot_prep %>%
  group_by(mdcinternalpatientid) %>%
  mutate(
    days_since_prev = c(NA, diff(as.numeric(spot_prot_date))),
    measurement_group = cumsum(is.na(days_since_prev) | days_since_prev > 90)
  ) %>%
  group_by(mdcinternalpatientid, measurement_group) %>%
  summarise(
    baseline_spot_protein = mean(protein_mg_dl, na.rm = TRUE),
    baseline_spot_prot_date = min(spot_prot_date),
    n_spot_prot_averaged = n(),
    days_diff = mean(days_diff),
    .groups = "drop"
  ) %>%
  group_by(mdcinternalpatientid) %>%
  arrange(abs(days_diff)) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_spot_prot_days_from_index = days_diff,
    spot_prot_proteinuria = ifelse(baseline_spot_protein >= 30, 1, 0)
  ) %>%
  dplyr::select(mdcinternalpatientid, baseline_spot_protein, baseline_spot_prot_date, 
                baseline_spot_prot_days_from_index, n_spot_prot_averaged, spot_prot_proteinuria)

cat("Spot protein processed:", nrow(baseline_spot_prot), "patients\n\n")

# ============================================================================
# Merge ALL sources
# ============================================================================

merged <- merged %>%
  left_join(baseline_acr, by = "mdcinternalpatientid") %>%
  left_join(baseline_pcr, by = "mdcinternalpatientid") %>%
  left_join(baseline_24hr, by = "mdcinternalpatientid") %>%
  left_join(baseline_spot_alb, by = "mdcinternalpatientid") %>%
  left_join(baseline_spot_prot, by = "mdcinternalpatientid")

# Define comprehensive baseline proteinuria
merged <- merged %>%
  mutate(
    baseline_proteinuria = case_when(
      acr_proteinuria == 1 | pcr_proteinuria == 1 | 
        protein_24hr_proteinuria == 1 | spot_alb_proteinuria == 1 | 
        spot_prot_proteinuria == 1 ~ 1,
      !is.na(acr_proteinuria) | !is.na(pcr_proteinuria) | 
        !is.na(protein_24hr_proteinuria) | !is.na(spot_alb_proteinuria) | 
        !is.na(spot_prot_proteinuria) ~ 0,
      TRUE ~ NA_real_
    )
  )

# Summary
cat("=== COMPREHENSIVE PROTEINURIA SUMMARY (ALL 5 SOURCES, ±1 year) ===\n\n")

cat("Data availability:\n")
cat("  ACR:", sum(!is.na(merged$baseline_acr)), "\n")
cat("  PCR:", sum(!is.na(merged$baseline_pcr)), "\n")
cat("  24-hour protein:", sum(!is.na(merged$baseline_24hr_protein)), "\n")
cat("  Spot albumin:", sum(!is.na(merged$baseline_spot_albumin)), "\n")
cat("  Spot protein:", sum(!is.na(merged$baseline_spot_protein)), "\n")
cat("  ANY proteinuria data:", sum(!is.na(merged$baseline_proteinuria)), "\n\n")

cat("Proteinuria detected by source:\n")
cat("  ACR ≥30:", sum(merged$acr_proteinuria == 1, na.rm = TRUE), "\n")
cat("  PCR ≥150:", sum(merged$pcr_proteinuria == 1, na.rm = TRUE), "\n")
cat("  24hr ≥150:", sum(merged$protein_24hr_proteinuria == 1, na.rm = TRUE), "\n")
cat("  Spot albumin >20 mg/L:", sum(merged$spot_alb_proteinuria == 1, na.rm = TRUE), "\n")
cat("  Spot protein ≥30 mg/dL:", sum(merged$spot_prot_proteinuria == 1, na.rm = TRUE), "\n\n")

cat("FINAL COMBINED:\n")
cat("  WITH proteinuria (ANY positive):", sum(merged$baseline_proteinuria == 1, na.rm = TRUE), "\n")
cat("  WITHOUT proteinuria (all negative):", sum(merged$baseline_proteinuria == 0, na.rm = TRUE), "\n")

cat("\n✓ Chunk 4 ENHANCED complete\n")

```


# CHUNK 4B: Convert Albumin to Estimated Protein Values
```{r}
# ============================================================================
# CHUNK 4B: Convert Albumin to Estimated Protein for Better Coverage
# ============================================================================

cat("\n=== CHUNK 4B: Converting albumin measurements to estimated protein ===\n\n")

# Rationale:
# - Albumin is the major component of proteinuria (60-80% typically)
# - ACR can be converted to estimated PCR
# - Spot albumin can be converted to estimated spot protein
# - This allows us to have more complete protein estimates

# ============================================================================
# Convert ACR to estimated PCR
# ============================================================================

cat("Converting ACR to estimated PCR...\n")

# Typical albumin-to-total protein ratio in proteinuria is ~0.6-0.7
# Conservative estimate: multiply ACR by 1.5 to get estimated PCR
# More liberal estimate: multiply by 1.3-2.0 depending on disease

merged <- merged %>%
  mutate(
    # Conservative conversion: ACR × 1.5 = estimated PCR
    estimated_pcr_from_acr = baseline_acr * 1.5,
    
    # Use measured PCR if available, otherwise use estimated from ACR
    pcr_combined = coalesce(baseline_pcr, estimated_pcr_from_acr),
    
    # Flag which source was used
    pcr_source = case_when(
      !is.na(baseline_pcr) ~ "measured",
      !is.na(estimated_pcr_from_acr) ~ "estimated_from_acr",
      TRUE ~ NA_character_
    ),
    
    # Recalculate proteinuria threshold using combined PCR
    pcr_combined_proteinuria = ifelse(pcr_combined >= 150, 1, 0)
  )

cat("PCR availability after conversion:\n")
cat("  Measured PCR:", sum(!is.na(merged$baseline_pcr)), "\n")
cat("  Estimated from ACR:", sum(!is.na(merged$estimated_pcr_from_acr) & is.na(merged$baseline_pcr)), "\n")
cat("  Combined PCR total:", sum(!is.na(merged$pcr_combined)), "\n\n")

# ============================================================================
# Convert Spot Albumin to estimated Spot Protein
# ============================================================================

cat("Converting spot albumin to estimated spot protein...\n")

# Spot albumin (mg/L) can be converted to estimated spot protein
# Typical ratio: albumin is ~60-70% of total protein in urine
# Conservative: multiply by 1.5

merged <- merged %>%
  mutate(
    # Convert mg/L albumin to estimated mg/dL protein
    # First convert mg/L to mg/dL (÷10), then adjust for albumin fraction (×1.5)
    estimated_spot_protein_from_albumin = (baseline_spot_albumin / 10) * 1.5,
    
    # Use measured spot protein if available, otherwise estimated
    spot_protein_combined = coalesce(baseline_spot_protein, estimated_spot_protein_from_albumin),
    
    # Flag source
    spot_protein_source = case_when(
      !is.na(baseline_spot_protein) ~ "measured",
      !is.na(estimated_spot_protein_from_albumin) ~ "estimated_from_albumin",
      TRUE ~ NA_character_
    ),
    
    # Recalculate proteinuria threshold
    spot_protein_combined_proteinuria = ifelse(spot_protein_combined >= 30, 1, 0)
  )

cat("Spot protein availability after conversion:\n")
cat("  Measured spot protein:", sum(!is.na(merged$baseline_spot_protein)), "\n")
cat("  Estimated from albumin:", sum(!is.na(merged$estimated_spot_protein_from_albumin) & is.na(merged$baseline_spot_protein)), "\n")
cat("  Combined spot protein total:", sum(!is.na(merged$spot_protein_combined)), "\n\n")

# ============================================================================
# Recalculate comprehensive proteinuria using converted values
# ============================================================================

cat("Recalculating comprehensive proteinuria with conversions...\n")

merged <- merged %>%
  mutate(
    # Original sources
    acr_positive = ifelse(!is.na(baseline_acr) & baseline_acr >= 30, 1, 0),
    pcr_measured_positive = ifelse(!is.na(baseline_pcr) & baseline_pcr >= 150, 1, 0),
    hr24_positive = ifelse(!is.na(baseline_24hr_protein) & baseline_24hr_protein >= 150, 1, 0),
    spot_alb_positive = ifelse(!is.na(baseline_spot_albumin) & baseline_spot_albumin > 20, 1, 0),
    spot_prot_measured_positive = ifelse(!is.na(baseline_spot_protein) & baseline_spot_protein >= 30, 1, 0),
    
    # Combined/converted sources
    pcr_combined_positive = ifelse(!is.na(pcr_combined) & pcr_combined >= 150, 1, 0),
    spot_prot_combined_positive = ifelse(!is.na(spot_protein_combined) & spot_protein_combined >= 30, 1, 0),
    
    # Updated comprehensive proteinuria: positive if ANY source positive
    baseline_proteinuria_enhanced = case_when(
      acr_positive == 1 | pcr_combined_positive == 1 | hr24_positive == 1 | 
        spot_alb_positive == 1 | spot_prot_combined_positive == 1 ~ 1,
      !is.na(baseline_acr) | !is.na(pcr_combined) | !is.na(baseline_24hr_protein) | 
        !is.na(baseline_spot_albumin) | !is.na(spot_protein_combined) ~ 0,
      TRUE ~ NA_real_
    )
  )

# Summary comparison
cat("\n=== COMPARISON: Original vs Enhanced Proteinuria Detection ===\n\n")

cat("Patients with ANY proteinuria measurement:\n")
cat("  ORIGINAL (5 separate sources):", sum(!is.na(merged$baseline_proteinuria)), "\n")
cat("  ENHANCED (with conversions):", sum(!is.na(merged$baseline_proteinuria_enhanced)), "\n")
cat("  Additional patients captured:", 
    sum(!is.na(merged$baseline_proteinuria_enhanced)) - sum(!is.na(merged$baseline_proteinuria)), "\n\n")

cat("Patients WITH proteinuria:\n")
cat("  ORIGINAL:", sum(merged$baseline_proteinuria == 1, na.rm = TRUE), "\n")
cat("  ENHANCED:", sum(merged$baseline_proteinuria_enhanced == 1, na.rm = TRUE), "\n")
cat("  Additional cases detected:", 
    sum(merged$baseline_proteinuria_enhanced == 1, na.rm = TRUE) - 
    sum(merged$baseline_proteinuria == 1, na.rm = TRUE), "\n\n")

cat("Patients WITHOUT proteinuria:\n")
cat("  ORIGINAL:", sum(merged$baseline_proteinuria == 0, na.rm = TRUE), "\n")
cat("  ENHANCED:", sum(merged$baseline_proteinuria_enhanced == 0, na.rm = TRUE), "\n\n")

cat("Breakdown of proteinuria detection by source:\n")
detection_summary <- data.frame(
  Source = c("ACR", "PCR (measured)", "PCR (combined with ACR conversion)", 
             "24-hour protein", "Spot albumin", 
             "Spot protein (measured)", "Spot protein (combined with albumin conversion)"),
  N_Available = c(
    sum(!is.na(merged$baseline_acr)),
    sum(!is.na(merged$baseline_pcr)),
    sum(!is.na(merged$pcr_combined)),
    sum(!is.na(merged$baseline_24hr_protein)),
    sum(!is.na(merged$baseline_spot_albumin)),
    sum(!is.na(merged$baseline_spot_protein)),
    sum(!is.na(merged$spot_protein_combined))
  ),
  N_Positive = c(
    sum(merged$acr_positive == 1, na.rm = TRUE),
    sum(merged$pcr_measured_positive == 1, na.rm = TRUE),
    sum(merged$pcr_combined_positive == 1, na.rm = TRUE),
    sum(merged$hr24_positive == 1, na.rm = TRUE),
    sum(merged$spot_alb_positive == 1, na.rm = TRUE),
    sum(merged$spot_prot_measured_positive == 1, na.rm = TRUE),
    sum(merged$spot_prot_combined_positive == 1, na.rm = TRUE)
  )
)
print(detection_summary)

# Optional: Replace original with enhanced version
# Uncomment the line below if you want to use the enhanced version going forward
# merged$baseline_proteinuria <- merged$baseline_proteinuria_enhanced

cat("\n✓ Chunk 4B complete: Albumin-to-protein conversions applied\n")
cat("NOTE: Use 'baseline_proteinuria_enhanced' for maximum sensitivity\n")
```

```{r}
# ============================================================================
# CHUNK 4C: Baseline Spot Urine Protein - Refined Definition
# ============================================================================

cat("\n=== CHUNK 4C: Processing baseline spot urine protein (refined) ===\n\n")

# Step 1: Standardize units to mg/L
baseline_spot_protein_refined <- merged %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date) %>%
  left_join(
    PROTERIN_URINE_FIRST_99 %>% dplyr::select(
      mdcinternalpatientid,
      proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_date,
      proteinuria_urine_sample_result_unit
    ),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    spot_protein_date = as.Date(proteinuria_urine_sample_result_date),
    days_diff = as.numeric(difftime(spot_protein_date, index_date, units = "days")),
    
    # Standardize ALL units to mg/L
    protein_mg_l = case_when(
      proteinuria_urine_sample_result_unit == "mg/L" ~ proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_unit %in% c("mg/dL", "mg/dl", "mg%") ~ 
        proteinuria_urine_sample_result_as_number * 10,  # mg/dL to mg/L
      proteinuria_urine_sample_result_unit %in% c("µg/ml", "µg/mL", "ug/ml") ~ 
        proteinuria_urine_sample_result_as_number,  # µg/ml = mg/L
      proteinuria_urine_sample_result_unit %in% c("g/L", "g/l") ~ 
        proteinuria_urine_sample_result_as_number * 1000,  # g/L to mg/L
      proteinuria_urine_sample_result_unit %in% c("mg/g Crea", "mg/g", "mg/g creat") ~ 
        proteinuria_urine_sample_result_as_number,  # Assumed normalized, keep as is
      TRUE ~ NA_real_
    )
  ) %>%
  # Filter for baseline period: -365 to +365 days from index
  filter(days_diff >= -365 & days_diff <= 365, 
         !is.na(protein_mg_l), 
         protein_mg_l >= 0,
         protein_mg_l < 100000)  # Remove extreme outliers

# Step 2: Calculate mean and max per patient
baseline_spot_protein_summary <- baseline_spot_protein_refined %>%
  group_by(mdcinternalpatientid) %>%
  summarise(
    baseline_spot_protein_mean = mean(protein_mg_l, na.rm = TRUE),
    baseline_spot_protein_max = max(protein_mg_l, na.rm = TRUE),
    baseline_spot_protein_date = first(spot_protein_date[order(abs(days_diff))]),  # Closest to index
    n_spot_protein_measurements = n(),
    .groups = "drop"
  ) %>%
  mutate(
    # Binary: proteinuria >500 mg/L at baseline
    baseline_spot_protein_binary = case_when(
      is.na(baseline_spot_protein_max) ~ NA_real_,
      baseline_spot_protein_max > 500 ~ 1,
      TRUE ~ 0
    )
  )

# Step 3: Merge back to cohort
merged <- merged %>%
  left_join(baseline_spot_protein_summary, by = "mdcinternalpatientid")

cat("=== Baseline Spot Urine Protein Summary (mg/L, ±1 year) ===\n")
cat("Patients with spot protein data:", sum(!is.na(merged$baseline_spot_protein_max)), "\n")
cat("Mean spot protein:", round(mean(merged$baseline_spot_protein_mean, na.rm = TRUE), 1), "mg/L\n")
cat("Median spot protein:", round(median(merged$baseline_spot_protein_mean, na.rm = TRUE), 1), "mg/L\n")
cat("Patients with protein >500 mg/L:", sum(merged$baseline_spot_protein_binary == 1, na.rm = TRUE), "\n\n")

cat("✓ Chunk 4C complete: Baseline spot protein refined\n")
```


# EXPLORATION: All Proteinuria/Albumin/Creatinine Sources

```{r}
# ============================================================================
# EXPLORATION: All Proteinuria/Albumin/Creatinine Sources
# ============================================================================

cat("\n=== EXPLORING ALL PROTEINURIA SOURCES ===\n\n")

# List all available datasets
cat("Available datasets:\n")
cat("1. ALBUMIN_CR_FIRST_99 (ACR - Albumin/Creatinine Ratio)\n")
cat("2. PROTEINE_CREATININE_FIRST_99 (PCR - Protein/Creatinine Ratio)\n")
cat("3. PROTEINURIA_24HR_FIRST_99 (24-hour urine protein)\n")
cat("4. PROTEINURIA_ALBUMIN_FIRST_99 (Spot albumin)\n")
cat("5. PROTERIN_URINE_FIRST_99 (Spot urine protein)\n\n")

# ============================================================================
# Dataset 1: ALBUMIN_CR_FIRST_99 (ACR)
# ============================================================================

cat("=== 1. ALBUMIN_CR_FIRST_99 (ACR) ===\n")
cat("Total measurements:", nrow(ALBUMIN_CR_FIRST_99), "\n")
cat("Unique patients:", n_distinct(ALBUMIN_CR_FIRST_99$mdcinternalpatientid), "\n")
cat("Overlap with merged cohort:", 
    sum(merged$mdcinternalpatientid %in% ALBUMIN_CR_FIRST_99$mdcinternalpatientid), "\n\n")

cat("Value distribution:\n")
print(summary(ALBUMIN_CR_FIRST_99$albumin_creatinine_ratio_result_as_number))

cat("\nUnits:\n")
print(table(ALBUMIN_CR_FIRST_99$albumin_creatinine_ratio_result_unit, useNA = "ifany"))

cat("\nDate range:\n")
acr_dates <- as.Date(ALBUMIN_CR_FIRST_99$albumin_creatinine_ratio_result_date)
cat("Min:", min(acr_dates, na.rm = TRUE), "\n")
cat("Max:", max(acr_dates, na.rm = TRUE), "\n\n")

# ============================================================================
# Dataset 2: PROTEINE_CREATININE_FIRST_99 (PCR)
# ============================================================================

cat("=== 2. PROTEINE_CREATININE_FIRST_99 (PCR) ===\n")
cat("Total measurements:", nrow(PROTEINE_CREATININE_FIRST_99), "\n")
cat("Unique patients:", n_distinct(PROTEINE_CREATININE_FIRST_99$mdcinternalpatientid), "\n")
cat("Overlap with merged cohort:", 
    sum(merged$mdcinternalpatientid %in% PROTEINE_CREATININE_FIRST_99$mdcinternalpatientid), "\n\n")

cat("Value distribution:\n")
print(summary(PROTEINE_CREATININE_FIRST_99$proteinuria_protein_creatinine_result_as_number))

cat("\nUnits:\n")
print(table(PROTEINE_CREATININE_FIRST_99$proteinuria_protein_creatinine_result_unit, useNA = "ifany"))

cat("\nDate range:\n")
pcr_dates <- as.Date(PROTEINE_CREATININE_FIRST_99$proteinuria_protein_creatinine_result_date)
cat("Min:", min(pcr_dates, na.rm = TRUE), "\n")
cat("Max:", max(pcr_dates, na.rm = TRUE), "\n\n")

# ============================================================================
# Dataset 3: PROTEINURIA_24HR_FIRST_99
# ============================================================================

cat("=== 3. PROTEINURIA_24HR_FIRST_99 (24-hour protein) ===\n")
cat("Total measurements:", nrow(PROTEINURIA_24HR_FIRST_99), "\n")
cat("Unique patients:", n_distinct(PROTEINURIA_24HR_FIRST_99$mdcinternalpatientid), "\n")
cat("Overlap with merged cohort:", 
    sum(merged$mdcinternalpatientid %in% PROTEINURIA_24HR_FIRST_99$mdcinternalpatientid), "\n\n")

cat("Value distribution:\n")
print(summary(PROTEINURIA_24HR_FIRST_99$proteinuria_24hr_result_as_number))

cat("\nCheck for string results:\n")
cat("String results available:", sum(!is.na(PROTEINURIA_24HR_FIRST_99$proteinuria_24hr_result_as_string)), "\n")
print(head(table(PROTEINURIA_24HR_FIRST_99$proteinuria_24hr_result_as_string), 20))

cat("\nDate range:\n")
hr24_dates <- as.Date(PROTEINURIA_24HR_FIRST_99$proteinuria_24hr_result_date)
cat("Min:", min(hr24_dates, na.rm = TRUE), "\n")
cat("Max:", max(hr24_dates, na.rm = TRUE), "\n\n")

# ============================================================================
# Dataset 4: PROTEINURIA_ALBUMIN_FIRST_99
# ============================================================================

cat("=== 4. PROTEINURIA_ALBUMIN_FIRST_99 (Spot albumin) ===\n")
cat("Total measurements:", nrow(PROTEINURIA_ALBUMIN_FIRST_99), "\n")
cat("Unique patients:", n_distinct(PROTEINURIA_ALBUMIN_FIRST_99$mdcinternalpatientid), "\n")
cat("Overlap with merged cohort:", 
    sum(merged$mdcinternalpatientid %in% PROTEINURIA_ALBUMIN_FIRST_99$mdcinternalpatientid), "\n\n")

cat("Value distribution:\n")
print(summary(PROTEINURIA_ALBUMIN_FIRST_99$proteinuria_albumin_result_as_number))

cat("\nUnits distribution:\n")
print(table(PROTEINURIA_ALBUMIN_FIRST_99$proteinuria_albumin_result_unit, useNA = "ifany"))

cat("\nDate range:\n")
alb_dates <- as.Date(PROTEINURIA_ALBUMIN_FIRST_99$proteinuria_albumin_result_date)
cat("Min:", min(alb_dates, na.rm = TRUE), "\n")
cat("Max:", max(alb_dates, na.rm = TRUE), "\n\n")

# Analyze units - can we standardize?
cat("Unit analysis for PROTEINURIA_ALBUMIN:\n")
unit_summary <- PROTEINURIA_ALBUMIN_FIRST_99 %>%
  group_by(proteinuria_albumin_result_unit) %>%
  summarise(
    n = n(),
    mean_value = mean(proteinuria_albumin_result_as_number, na.rm = TRUE),
    median_value = median(proteinuria_albumin_result_as_number, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(n))
print(unit_summary)

# ============================================================================
# Dataset 5: PROTERIN_URINE_FIRST_99
# ============================================================================

cat("\n=== 5. PROTERIN_URINE_FIRST_99 (Spot urine protein) ===\n")
cat("Total measurements:", nrow(PROTERIN_URINE_FIRST_99), "\n")
cat("Unique patients:", n_distinct(PROTERIN_URINE_FIRST_99$mdcinternalpatientid), "\n")
cat("Overlap with merged cohort:", 
    sum(merged$mdcinternalpatientid %in% PROTERIN_URINE_FIRST_99$mdcinternalpatientid), "\n\n")

cat("Value distribution:\n")
print(summary(PROTERIN_URINE_FIRST_99$proteinuria_urine_sample_result_as_number))

cat("\nUnits distribution:\n")
print(table(PROTERIN_URINE_FIRST_99$proteinuria_urine_sample_result_unit, useNA = "ifany"))

cat("\nDate range:\n")
urine_dates <- as.Date(PROTERIN_URINE_FIRST_99$proteinuria_urine_sample_result_date)
cat("Min:", min(urine_dates, na.rm = TRUE), "\n")
cat("Max:", max(urine_dates, na.rm = TRUE), "\n\n")

# ============================================================================
# OVERLAP ANALYSIS
# ============================================================================

cat("=== OVERLAP ANALYSIS: How many patients have each combination? ===\n\n")

overlap_analysis <- merged %>%
  mutate(
    has_acr = mdcinternalpatientid %in% ALBUMIN_CR_FIRST_99$mdcinternalpatientid,
    has_pcr = mdcinternalpatientid %in% PROTEINE_CREATININE_FIRST_99$mdcinternalpatientid,
    has_24hr = mdcinternalpatientid %in% PROTEINURIA_24HR_FIRST_99$mdcinternalpatientid,
    has_spot_alb = mdcinternalpatientid %in% PROTEINURIA_ALBUMIN_FIRST_99$mdcinternalpatientid,
    has_spot_protein = mdcinternalpatientid %in% PROTERIN_URINE_FIRST_99$mdcinternalpatientid
  )

cat("Patients with each test type:\n")
cat("  ACR:", sum(overlap_analysis$has_acr), "\n")
cat("  PCR:", sum(overlap_analysis$has_pcr), "\n")
cat("  24-hour:", sum(overlap_analysis$has_24hr), "\n")
cat("  Spot albumin:", sum(overlap_analysis$has_spot_alb), "\n")
cat("  Spot protein:", sum(overlap_analysis$has_spot_protein), "\n\n")

cat("Patients with ANY test:", 
    sum(overlap_analysis$has_acr | overlap_analysis$has_pcr | 
        overlap_analysis$has_24hr | overlap_analysis$has_spot_alb | 
        overlap_analysis$has_spot_protein), "\n\n")

# Most common combinations
cat("Most common test combinations:\n")
combo_summary <- overlap_analysis %>%
  group_by(has_acr, has_pcr, has_24hr, has_spot_alb, has_spot_protein) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(desc(n)) %>%
  head(10)
print(combo_summary)

cat("\n=== EXPLORATION COMPLETE ===\n")
cat("Next steps:\n")
cat("1. Decide which tests to include\n")
cat("2. Define thresholds for each test\n")
cat("3. Handle unit conversions where needed\n")
cat("4. Update CHUNK 4 accordingly\n")
```



# CHUNK 5: Apply Inclusion Criteria - Create Study Cohort


```{r}
# ============================================================================
# CHUNK 5: Apply Inclusion Criteria - GFR ONLY (NO PROTEINURIA FILTER)
# ============================================================================

cat("\n=== CHUNK 5: Applying inclusion criteria (GFR only) ===\n\n")

# INCLUSION:
# 1. Must have baseline GFR
# 2. GFR > 60 at baseline
# NO PROTEINURIA FILTER

cohort <- merged %>%
  filter(
    # Must have baseline GFR data
    !is.na(baseline_gfr),
    
    # GFR must be > 60 at baseline
    baseline_gfr > 60
    
    # NO PROTEINURIA FILTER - REMOVED!
  )

# Detailed flowchart
cat("=== INCLUSION FLOWCHART (GFR only, no proteinuria filter) ===\n\n")

cat("Starting cohort (2015-2023):", nrow(merged), "\n")
cat("  - Lupus:", sum(merged$Lupus == 1), "\n")
cat("  - Controls:", sum(merged$Lupus == 0), "\n\n")

cat("Step 1: Has baseline GFR data\n")
step1 <- merged %>% filter(!is.na(baseline_gfr))
cat("  Remaining:", nrow(step1), 
    "(Lupus:", sum(step1$Lupus == 1), ", Controls:", sum(step1$Lupus == 0), ")\n")
cat("  Excluded:", nrow(merged) - nrow(step1), "\n\n")

cat("Step 2: GFR > 60 at baseline\n")
step2 <- step1 %>% filter(baseline_gfr > 60)
cat("  Remaining:", nrow(step2),
    "(Lupus:", sum(step2$Lupus == 1), ", Controls:", sum(step2$Lupus == 0), ")\n")
cat("  Excluded:", nrow(step1) - nrow(step2), "\n\n")

cat("=== FINAL STUDY COHORT ===\n")
cat("Total patients:", nrow(cohort), "\n")
cat("  - Lupus patients:", sum(cohort$Lupus == 1), "\n")
cat("  - Control patients:", sum(cohort$Lupus == 0), "\n\n")

# Proteinuria status in final cohort (for descriptive purposes)
cat("=== PROTEINURIA STATUS IN FINAL COHORT (descriptive only) ===\n")
cat("Patients with proteinuria data:\n")
cat("  WITH proteinuria:", sum(cohort$baseline_proteinuria == 1, na.rm = TRUE), "\n")
cat("  WITHOUT proteinuria:", sum(cohort$baseline_proteinuria == 0, na.rm = TRUE), "\n")
cat("  Missing proteinuria data:", sum(is.na(cohort$baseline_proteinuria)), "\n\n")

# Baseline characteristics
cat("=== BASELINE CHARACTERISTICS ===\n\n")

cat("Age at index:\n")
cat("  Mean (SD):", round(mean(cohort$age_at_index, na.rm = TRUE), 1), 
    "(", round(sd(cohort$age_at_index, na.rm = TRUE), 1), ")\n\n")

cat("Baseline GFR:\n")
cat("  Mean (SD):", round(mean(cohort$baseline_gfr, na.rm = TRUE), 1), 
    "(", round(sd(cohort$baseline_gfr, na.rm = TRUE), 1), ")\n\n")

cat("Gender distribution:\n")
print(table(cohort$gender, cohort$Lupus, dnn = c("Gender", "Lupus")))

cat("\n✓ Chunk 5 complete\n")
cat("\nFinal study cohort ready for outcome analysis!\n")
cat("NOTE: Proteinuria was NOT used as exclusion criterion.\n")
```


```{r}
# ============================================================================
# CHECK: GFR DISTRIBUTION IN ORIGINAL LUPUS PATIENTS
# ============================================================================

cat("\n=== Checking GFR Distribution in Original Lupus Cohort ===\n\n")

library(dplyr)

# ============================================================================
# STEP 1: Check lupus patients BEFORE any GFR filtering
# ============================================================================

cat("=== ORIGINAL LUPUS COHORT (from lupus_file, 2015-2023) ===\n\n")

# Get all lupus patients from initial merge (before GFR filtering)
original_lupus_check <- Baseline %>%
  inner_join(
    lupus_file %>% dplyr::select(patient_id, matched_lupus_start_date, Lupus),
    by = "patient_id"
  ) %>%
  mutate(
    index_date = as.Date(matched_lupus_start_date),
    year = year(index_date)
  ) %>%
  filter(year >= 2015 & year <= 2023, Lupus == 1)

cat("Total lupus patients (2015-2023, BEFORE any filtering):", nrow(original_lupus_check), "\n\n")

# ============================================================================
# STEP 2: Check which lupus patients have baseline GFR data
# ============================================================================

cat("=== STEP 2: Lupus Patients with Baseline GFR Data ===\n\n")

# Check in merged dataset (after GFR data is added in Chunk 3)
lupus_with_gfr <- merged %>%
  filter(Lupus == 1, !is.na(baseline_gfr))

cat("Lupus patients WITH baseline GFR:", nrow(lupus_with_gfr), "\n")
cat("Lupus patients WITHOUT baseline GFR:", 
    sum(merged$Lupus == 1 & is.na(merged$baseline_gfr)), "\n\n")

# ============================================================================
# STEP 3: GFR DISTRIBUTION in lupus patients (those with GFR data)
# ============================================================================

cat("=== STEP 3: GFR Distribution in Lupus Patients (who have GFR data) ===\n\n")

cat("Summary statistics:\n")
print(summary(lupus_with_gfr$baseline_gfr))
cat("\n")

cat("GFR categories:\n")
print(table(lupus_with_gfr$baseline_gfr_category, useNA = "always"))
cat("\n")

cat("Distribution:\n")
cat("  GFR > 60 (preserved function):", sum(lupus_with_gfr$baseline_gfr > 60), 
    "(", round(100 * sum(lupus_with_gfr$baseline_gfr > 60) / nrow(lupus_with_gfr), 1), "%)\n")
cat("  GFR 45-60 (mild reduction):", sum(lupus_with_gfr$baseline_gfr >= 45 & lupus_with_gfr$baseline_gfr <= 60), 
    "(", round(100 * sum(lupus_with_gfr$baseline_gfr >= 45 & lupus_with_gfr$baseline_gfr <= 60) / nrow(lupus_with_gfr), 1), "%)\n")
cat("  GFR 30-44 (moderate reduction):", sum(lupus_with_gfr$baseline_gfr >= 30 & lupus_with_gfr$baseline_gfr < 45), 
    "(", round(100 * sum(lupus_with_gfr$baseline_gfr >= 30 & lupus_with_gfr$baseline_gfr < 45) / nrow(lupus_with_gfr), 1), "%)\n")
cat("  GFR < 30 (severe reduction):", sum(lupus_with_gfr$baseline_gfr < 30), 
    "(", round(100 * sum(lupus_with_gfr$baseline_gfr < 30) / nrow(lupus_with_gfr), 1), "%)\n\n")

# ============================================================================
# STEP 4: What happens when we filter for GFR > 60?
# ============================================================================

cat("=== STEP 4: Effect of GFR > 60 Filter ===\n\n")

lupus_gfr_gt60 <- lupus_with_gfr %>%
  filter(baseline_gfr > 60)

lupus_gfr_le60 <- lupus_with_gfr %>%
  filter(baseline_gfr <= 60)

cat("Lupus patients with GFR > 60:", nrow(lupus_gfr_gt60), "\n")
cat("Lupus patients with GFR ≤ 60 (EXCLUDED):", nrow(lupus_gfr_le60), "\n\n")

cat("You are EXCLUDING these lupus patients:\n")
cat("  N excluded:", nrow(lupus_gfr_le60), "\n")
cat("  Mean GFR of excluded:", round(mean(lupus_gfr_le60$baseline_gfr), 1), "\n")
cat("  GFR range of excluded:", round(min(lupus_gfr_le60$baseline_gfr), 1), "-", 
    round(max(lupus_gfr_le60$baseline_gfr), 1), "\n\n")

# ============================================================================
# STEP 5: Complete flow from original lupus to final cohort
# ============================================================================

cat("=== COMPLETE FLOW: Original Lupus → Final Cohort ===\n\n")

flow_summary <- data.frame(
  Stage = c(
    "Original lupus patients (2015-2023)",
    "After requiring baseline GFR data",
    "After GFR > 60 filter",
    "LOST: No GFR data",
    "LOST: GFR ≤ 60"
  ),
  N = c(
    nrow(original_lupus_check),
    nrow(lupus_with_gfr),
    nrow(lupus_gfr_gt60),
    nrow(original_lupus_check) - nrow(lupus_with_gfr),
    nrow(lupus_gfr_le60)
  ),
  Percent_of_Original = c(
    100,
    round(100 * nrow(lupus_with_gfr) / nrow(original_lupus_check), 1),
    round(100 * nrow(lupus_gfr_gt60) / nrow(original_lupus_check), 1),
    round(100 * (nrow(original_lupus_check) - nrow(lupus_with_gfr)) / nrow(original_lupus_check), 1),
    round(100 * nrow(lupus_gfr_le60) / nrow(original_lupus_check), 1)
  )
)

print(flow_summary)

cat("\n")

# ============================================================================
# STEP 6: Is GFR > 60 realistic for lupus patients?
# ============================================================================

cat("=== INTERPRETATION ===\n\n")

cat("Is it realistic that lupus patients have GFR > 60?\n")
cat("YES, if you're studying EARLY/MILD lupus patients:\n")
cat("  - Many lupus patients have preserved kidney function\n")
cat("  - You're specifically selecting lupus WITHOUT advanced kidney disease\n")
cat("  - This is the RIGHT cohort to study CKD PROGRESSION\n\n")

cat("The question is: Do you WANT to exclude lupus patients with GFR ≤ 60?\n")
cat("  - If YES: Keep current filter (studying progression from normal to CKD)\n")
cat("  - If NO: Remove GFR > 60 filter (include all lupus patients with GFR data)\n\n")

cat("✓ GFR distribution check complete\n")
```






# TABLE 1: Baseline Characteristics by Lupus Status (ONLY EXISTING VARS)


```{r}
# ============================================================================
# TABLE 1: Baseline Characteristics by Lupus Status (WITH P-VALUES)
# ============================================================================

cat("\n=== Creating TABLE 1: Baseline Characteristics ===\n\n")

library(gtsummary)
library(flextable)
library(officer)

# Prepare data for Table 1
cohort_tbl1 <- cohort %>%
  mutate(
    # Convert Lupus to factor for grouping
    lupus_group = factor(Lupus, levels = c(0, 1), labels = c("Control", "Lupus")),
    
    # Convert gender to factor
    gender = factor(gender, levels = c("Male", "Female")),
    
    # Socioeconomic status as factor
    ses_category = factor(
      socioeconomic_score_three_level_scale,
      levels = c("Low", "Medium", "High")
    ),
    
    # BMI - use coalesced value
    bmi = coalesce(bmi_first_hospital_bmi_numeric, bmi_first_community_bmi),
    
    # Fix CCI variables: 0 = 0, anything else = 1
    cci_cerebrovascular_disease = case_when(
      is.na(cci_cerebrovascular_disease) ~ NA_real_,
      cci_cerebrovascular_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_chronic_pulmonary_disease = case_when(
      is.na(cci_chronic_pulmonary_disease) ~ NA_real_,
      cci_chronic_pulmonary_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_dementia = case_when(
      is.na(cci_dementia) ~ NA_real_,
      cci_dementia == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_malignancy = case_when(
      is.na(cci_malignancy) ~ NA_real_,
      cci_malignancy == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_renal_disease = case_when(
      is.na(cci_renal_disease) ~ NA_real_,
      cci_renal_disease == 0 ~ 0,
      TRUE ~ 1
    )
  )

# Custom p-value function
custom_pvalue_fun <- function(x) {
  formatted_p <- vapply(x, function(p) {
    if (is.na(p)) {
      return(NA_character_)
    } else if (p < 0.001) {
      return("<0.001")
    } else if (p <= 0.05) {
      return(substr(sprintf("%.3f", p), 1, 5))
    } else {
      return(substr(sprintf("%.3f", p), 1, 4))
    }
  }, character(1))
  return(formatted_p)
}

# Variables list
table1_vars <- c(
  "age_at_index",
  "gender",
  "ses_category",
  "bmi",
  "ever_smoker",
  "baseline_gfr",
  "baseline_gfr_category",
  "baseline_acr",
  "baseline_pcr",
  "baseline_24hr_protein",
  "baseline_spot_albumin",
  "baseline_spot_protein",
  "cci_charlson_score_total",
  "diabetes_diagnosis",
  "hypertension_diagnosis",
  "ischemic_heart_disease_diagnosis",
  "chf_diagnosis",
  "cci_cerebrovascular_disease",
  "cci_chronic_pulmonary_disease",
  "cci_dementia",
  "cci_malignancy",
  "cci_renal_disease",
  "hydroxychloroquine_medication",
  "azathioprine_medication",
  "mycophenolate_medication",
  "methotrexate_medication",
  "prednisone_medication",
  "rituximab_medication",
  "belimumab_medication",
  "cyclophosphamide_medication",
  "tacrolimus_medication",
  "ciclosporin_medication",
  "ace_medication",
  "arbs_medication",
  "statins_medication",
  "aspirin_medication",
  "beta_blockers_medication",
  "calcium_channel_blockers_medication",
  "diuretics_medication",
  "sglt_2_medication",
  "glp_1_medication",
  "metformin_medication",
  "insulin_medication"
)

cat("Variables in Table 1:", length(table1_vars), "\n")

# Build Table 1
table1 <- cohort_tbl1 %>%
  dplyr::select(lupus_group, all_of(table1_vars)) %>%
  tbl_summary(
    by = lupus_group,
    missing = "no",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    
    # Specify which value to display
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      rituximab_medication ~ "1",
      belimumab_medication ~ "1",
      cyclophosphamide_medication ~ "1",
      tacrolimus_medication ~ "1",
      ciclosporin_medication ~ "1",
      ace_medication ~ "1",
      arbs_medication ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      beta_blockers_medication ~ "1",
      calcium_channel_blockers_medication ~ "1",
      diuretics_medication ~ "1",
      sglt_2_medication ~ "1",
      glp_1_medication ~ "1",
      metformin_medication ~ "1",
      insulin_medication ~ "1"
    ),
    
    label = list(
      # Demographics
      age_at_index ~ "Age at Index (years)",
      gender ~ "Sex (Female)",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      
      # Baseline kidney function
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_acr ~ "Baseline Albumin-to-Creatinine Ratio (mg/g)",
      baseline_pcr ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      baseline_24hr_protein ~ "Baseline 24-hour Urine Protein (mg/day)",
      baseline_spot_albumin ~ "Baseline Spot Urine Albumin (mg/L)",
      baseline_spot_protein ~ "Baseline Spot Urine Protein (mg/dL)",
      
      # Charlson
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      
      # Comorbidities
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      
      # Lupus medications
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      rituximab_medication ~ "Rituximab",
      belimumab_medication ~ "Belimumab",
      cyclophosphamide_medication ~ "Cyclophosphamide",
      tacrolimus_medication ~ "Tacrolimus",
      ciclosporin_medication ~ "Ciclosporin",
      
      # Cardiovascular medications
      ace_medication ~ "Angiotensin-Converting Enzyme Inhibitors",
      arbs_medication ~ "Angiotensin Receptor Blockers",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      beta_blockers_medication ~ "Beta Blockers",
      calcium_channel_blockers_medication ~ "Calcium Channel Blockers",
      diuretics_medication ~ "Diuretics",
      
      # Diabetes medications
      sglt_2_medication ~ "Sodium-Glucose Cotransporter-2 Inhibitors",
      glp_1_medication ~ "Glucagon-Like Peptide-1 Agonists",
      metformin_medication ~ "Metformin",
      insulin_medication ~ "Insulin"
    )
  )  %>%
  add_n() %>%
  add_difference(everything() ~ "smd") %>%
  add_p(
    pvalue_fun = custom_pvalue_fun,
    test = list(all_continuous() ~ "t.test")
  ) %>%
  modify_column_hide(ci)

cat("\n✓ Table 1 created successfully!\n")

# Save to Word
ft_table1 <- table1 %>%
  as_flex_table() %>%
  autofit()

doc_table1 <- read_docx() %>%
  body_add_par("Table 1: Baseline Characteristics by Lupus Status", style = "heading 1") %>%
  body_add_flextable(ft_table1)

print(doc_table1, target = "Table1_Baseline_Characteristics_Lupus.docx")

cat("Table 1 saved to: Table1_Baseline_Characteristics_Lupus.docx\n")

# Display the table
table1
```

# CHUNK 6: Propensity Score Weighting (IPTW)

```{r}
# ============================================================================
# CHUNK 6 REVISED: Propensity Score Weighting (IPTW) with BMI CLEANING
# ============================================================================

cat("\n=== CHUNK 6 REVISED: Creating IPTW weights with additional covariates ===\n\n")

library(WeightIt)
library(cobalt)

# Prepare data for weighting
cohort_weighted <- cohort %>%
  mutate(
    # Create birth year from birth_date
    birth_year = year(birth_date),
    
    # Ensure variables are numeric
    gender_numeric = as.numeric(gender == "Female"),
    baseline_gfr_numeric = as.numeric(baseline_gfr),
    cci_numeric = as.numeric(cci_charlson_score_total),
    
    # BMI - prioritize hospital over community, then CLEAN outliers
    bmi_raw = coalesce(bmi_first_hospital_bmi_numeric, bmi_first_community_bmi),
    
    # Clean BMI: set values outside 10-50 range to NA
    bmi = case_when(
      bmi_raw < 10 ~ NA_real_,
      bmi_raw > 55 ~ NA_real_,
      TRUE ~ bmi_raw
    ),
    
    # Smoking - convert to binary (ever smoker)
    ever_smoker = case_when(
      smoking_by_life_style_smoking_status == "מעולם לא" ~ 0,
      is.na(smoking_by_life_style_smoking_status) ~ NA_real_,
      TRUE ~ 1
    ),
    
    # Diabetes - ensure numeric
    diabetes_numeric = as.numeric(diabetes_diagnosis),
    
    # Hypertension - ensure numeric
    hypertension_numeric = as.numeric(hypertension_diagnosis)
  )

# Check BMI cleaning
cat("=== BMI Cleaning Summary ===\n")
cat("Raw BMI range:", round(min(cohort_weighted$bmi_raw, na.rm = TRUE), 1), "-", 
    round(max(cohort_weighted$bmi_raw, na.rm = TRUE), 1), "\n")
cat("Cleaned BMI range:", round(min(cohort_weighted$bmi, na.rm = TRUE), 1), "-", 
    round(max(cohort_weighted$bmi, na.rm = TRUE), 1), "\n")
cat("BMI values excluded (outside 10-50):", sum(is.na(cohort_weighted$bmi) & !is.na(cohort_weighted$bmi_raw)), "\n")
cat("BMI values retained:", sum(!is.na(cohort_weighted$bmi)), "\n\n")

# Summary of cleaned BMI
cat("Cleaned BMI summary:\n")
print(summary(cohort_weighted$bmi))

# Now filter for complete cases
cohort_weighted <- cohort_weighted %>%
  filter(
    !is.na(gender_numeric),
    !is.na(birth_year),
    !is.na(cci_numeric),
    !is.na(baseline_gfr_numeric),
    !is.na(bmi),
    !is.na(ever_smoker),
    !is.na(diabetes_numeric),
    !is.na(hypertension_numeric)
  )

cat("Cohort for weighting:", nrow(cohort_weighted), "\n")
cat("  Lupus:", sum(cohort_weighted$Lupus == 1), "\n")
cat("  Control:", sum(cohort_weighted$Lupus == 0), "\n\n")

# Check how many excluded due to missing data
cat("Patients excluded due to missing data:\n")
cat("  Total in cohort:", nrow(cohort), "\n")
cat("  Excluded:", nrow(cohort) - nrow(cohort_weighted), "\n")
cat("  Included:", nrow(cohort_weighted), "\n\n")

# Create IPTW weights with ATT - NOW WITH 8 COVARIATES
cat("Creating IPTW weights (ATT) with 8 covariates...\n")

W <- weightit(
  Lupus ~ gender_numeric + birth_year + cci_numeric + baseline_gfr_numeric + 
          bmi + ever_smoker + diabetes_numeric + hypertension_numeric,
  data = cohort_weighted,
  method = "ps",
  estimand = "ATT"
)

# Add weights to cohort
cohort_weighted$iptw <- W$weights

# Summary of weights
cat("\n=== Weight Summary ===\n")
cat("Mean weight:", round(mean(cohort_weighted$iptw), 3), "\n")
cat("Median weight:", round(median(cohort_weighted$iptw), 3), "\n")
cat("Min weight:", round(min(cohort_weighted$iptw), 3), "\n")
cat("Max weight:", round(max(cohort_weighted$iptw), 3), "\n")
cat("SD weight:", round(sd(cohort_weighted$iptw), 3), "\n\n")

cat("Weight distribution by group:\n")
cat("Lupus - Mean:", round(mean(cohort_weighted$iptw[cohort_weighted$Lupus == 1]), 3), 
    "Median:", round(median(cohort_weighted$iptw[cohort_weighted$Lupus == 1]), 3), "\n")
cat("Control - Mean:", round(mean(cohort_weighted$iptw[cohort_weighted$Lupus == 0]), 3),
    "Median:", round(median(cohort_weighted$iptw[cohort_weighted$Lupus == 0]), 3), "\n\n")

# Check balance with cobalt
cat("=== Checking Covariate Balance ===\n\n")

# Balance before weighting
bal_unweighted <- bal.tab(
  Lupus ~ gender_numeric + birth_year + cci_numeric + baseline_gfr_numeric + 
          bmi + ever_smoker + diabetes_numeric + hypertension_numeric,
  data = cohort_weighted,
  un = TRUE,
  stats = c("m", "v"),
  thresholds = c(m = 0.1)
)

cat("Balance BEFORE weighting:\n")
print(bal_unweighted)

# Balance after weighting
bal_weighted <- bal.tab(
  Lupus ~ gender_numeric + birth_year + cci_numeric + baseline_gfr_numeric + 
          bmi + ever_smoker + diabetes_numeric + hypertension_numeric,
  data = cohort_weighted,
  weights = cohort_weighted$iptw,
  un = TRUE,
  stats = c("m", "v"),
  thresholds = c(m = 0.1)
)

cat("\n\nBalance AFTER weighting:\n")
print(bal_weighted)

# Love plot with absolute SMD
cat("\n\nCreating balance plot...\n")

pdf("Balance_Plot_IPTW.pdf", width = 12, height = 8)
love.plot(
  W,
  stats = "mean.diffs",
  thresholds = c(m = 0.1),
  var.order = "unadjusted",
  abs = TRUE,
  drop.distance = TRUE,
  var.names = c(
    gender_numeric = "Female Sex",
    birth_year = "Birth Year",
    cci_numeric = "Charlson Comorbidity Index",
    baseline_gfr_numeric = "Baseline GFR (mL/min/1.73m²)",
    bmi = "Body Mass Index (kg/m²)",
    ever_smoker = "Ever Smoker",
    diabetes_numeric = "Diabetes Mellitus",
    hypertension_numeric = "Hypertension"
  ),
  colors = c("black", "gray60"),
  shapes = c("square", "circle"),
  sample.names = c("Unweighted", "IPTW Weighted (ATT)"),
  title = "Covariate Balance Before and After IPTW",
  line = FALSE,
  stars = "none"
)
dev.off()

cat("Balance plot saved to: Balance_Plot_IPTW.pdf\n")

# Effective sample size
ess_lupus <- sum(cohort_weighted$iptw[cohort_weighted$Lupus == 1])^2 / 
  sum(cohort_weighted$iptw[cohort_weighted$Lupus == 1]^2)
ess_control <- sum(cohort_weighted$iptw[cohort_weighted$Lupus == 0])^2 / 
  sum(cohort_weighted$iptw[cohort_weighted$Lupus == 0]^2)

cat("\n=== Effective Sample Size ===\n")
cat("Original Lupus:", sum(cohort_weighted$Lupus == 1), 
    "→ Effective:", round(ess_lupus, 1), "\n")
cat("Original Control:", sum(cohort_weighted$Lupus == 0), 
    "→ Effective:", round(ess_control, 1), "\n")

# Summary table of balance
cat("\n=== Balance Summary ===\n")
balance_summary <- data.frame(
  Variable = c("Female Sex", "Birth Year", "Charlson Comorbidity Index", "Baseline GFR",
               "BMI", "Ever Smoker", "Diabetes", "Hypertension"),
  SMD_Unweighted = abs(bal_unweighted$Balance$Diff.Un),
  SMD_Weighted = abs(bal_weighted$Balance$Diff.Adj),
  Balanced = ifelse(abs(bal_weighted$Balance$Diff.Adj) < 0.1, "Yes", "No")
)
print(balance_summary)

cat("\n✓ Chunk 6 REVISED complete\n")
cat("\nWeighted cohort ready for analysis!\n")
cat("Covariates balanced: Sex, Birth Year, CCI, Baseline GFR, BMI (10-50), Smoking, Diabetes, Hypertension\n")
```






# Save weighted cohort back to main cohort

```{r}
# ============================================================================
# Save weighted cohort back to main cohort
# ============================================================================

cat("\n=== Merging weights back to full cohort ===\n")

# Merge weights back to the full cohort
cohort <- cohort %>%
  left_join(
    cohort_weighted %>% dplyr::select(mdcinternalpatientid, iptw, gender_numeric, birth_year, cci_numeric, baseline_gfr_numeric),
    by = "mdcinternalpatientid"
  )

cat("Full cohort with weights:", nrow(cohort), "\n")
cat("Patients with weights:", sum(!is.na(cohort$iptw)), "\n")
cat("Patients without weights (missing covariates):", sum(is.na(cohort$iptw)), "\n")

cat("\n✓ Weights merged to cohort\n")
```
# TABLE 1: Baseline Characteristics - UNWEIGHTED + WEIGHTED

```{r}
# ============================================================================
# TABLE 1: Baseline Characteristics - UNWEIGHTED + WEIGHTED
# ============================================================================

cat("\n=== Creating TABLE 1: Baseline Characteristics (Unweighted + Weighted) ===\n\n")

library(gtsummary)
library(flextable)
library(officer)

# Prepare data for Table 1 - use cohort_weighted (complete cases for weighting)
cohort_tbl1 <- cohort_weighted %>%
  mutate(
    # Convert Lupus to factor for grouping
    lupus_group = factor(Lupus, levels = c(0, 1), labels = c("Control", "Lupus")),
    
    # Convert gender to factor
    gender = factor(ifelse(gender_numeric == 1, "Female", "Male"), levels = c("Male", "Female")),
    
    # Socioeconomic status as factor
    ses_category = factor(
      socioeconomic_score_three_level_scale,
      levels = c("Low", "Medium", "High")
    ),
    
    # BMI - use coalesced value
    bmi = coalesce(bmi_first_hospital_bmi_numeric, bmi_first_community_bmi),
    
    # Fix CCI variables: 0 = 0, anything else = 1
    cci_cerebrovascular_disease = case_when(
      is.na(cci_cerebrovascular_disease) ~ NA_real_,
      cci_cerebrovascular_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_chronic_pulmonary_disease = case_when(
      is.na(cci_chronic_pulmonary_disease) ~ NA_real_,
      cci_chronic_pulmonary_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_dementia = case_when(
      is.na(cci_dementia) ~ NA_real_,
      cci_dementia == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_malignancy = case_when(
      is.na(cci_malignancy) ~ NA_real_,
      cci_malignancy == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_renal_disease = case_when(
      is.na(cci_renal_disease) ~ NA_real_,
      cci_renal_disease == 0 ~ 0,
      TRUE ~ 1
    )
  )

# Custom p-value function
custom_pvalue_fun <- function(x) {
  formatted_p <- vapply(x, function(p) {
    if (is.na(p)) {
      return(NA_character_)
    } else if (p < 0.001) {
      return("<0.001")
    } else if (p <= 0.05) {
      return(substr(sprintf("%.3f", p), 1, 5))
    } else {
      return(substr(sprintf("%.3f", p), 1, 4))
    }
  }, character(1))
  return(formatted_p)
}

# Variables list
table1_vars <- c(
  "age_at_index",
  "gender",
  "birth_year",
  "ses_category",
  "bmi",
  "ever_smoker",
  "baseline_gfr",
  "baseline_gfr_category",
  "baseline_acr",
  "baseline_pcr",
  "baseline_24hr_protein",
  "baseline_spot_albumin",
  "baseline_spot_protein",
  "cci_charlson_score_total",
  "diabetes_diagnosis",
  "hypertension_diagnosis",
  "ischemic_heart_disease_diagnosis",
  "chf_diagnosis",
  "cci_cerebrovascular_disease",
  "cci_chronic_pulmonary_disease",
  "cci_dementia",
  "cci_malignancy",
  "cci_renal_disease",
  "hydroxychloroquine_medication",
  "azathioprine_medication",
  "mycophenolate_medication",
  "methotrexate_medication",
  "prednisone_medication",
  "rituximab_medication",
  "belimumab_medication",
  "cyclophosphamide_medication",
  "tacrolimus_medication",
  "ciclosporin_medication",
  "ace_medication",
  "arbs_medication",
  "statins_medication",
  "aspirin_medication",
  "beta_blockers_medication",
  "calcium_channel_blockers_medication",
  "diuretics_medication",
  "sglt_2_medication",
  "glp_1_medication",
  "metformin_medication",
  "insulin_medication"
)

cat("Variables in Table 1:", length(table1_vars), "\n")

# Create UNWEIGHTED table
table1_unweighted <- cohort_tbl1 %>%
  dplyr::select(lupus_group, all_of(table1_vars)) %>%
  tbl_summary(
    by = lupus_group,
    missing = "no",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      rituximab_medication ~ "1",
      belimumab_medication ~ "1",
      cyclophosphamide_medication ~ "1",
      tacrolimus_medication ~ "1",
      ciclosporin_medication ~ "1",
      ace_medication ~ "1",
      arbs_medication ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      beta_blockers_medication ~ "1",
      calcium_channel_blockers_medication ~ "1",
      diuretics_medication ~ "1",
      sglt_2_medication ~ "1",
      glp_1_medication ~ "1",
      metformin_medication ~ "1",
      insulin_medication ~ "1"
    ),
    
    label = list(
      age_at_index ~ "Age at Index (years)",
      gender ~ "Sex (Female)",
      birth_year ~ "Birth Year",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_acr ~ "Baseline Albumin-to-Creatinine Ratio (mg/g)",
      baseline_pcr ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      baseline_24hr_protein ~ "Baseline 24-hour Urine Protein (mg/day)",
      baseline_spot_albumin ~ "Baseline Spot Urine Albumin (mg/L)",
      baseline_spot_protein ~ "Baseline Spot Urine Protein (mg/dL)",
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      rituximab_medication ~ "Rituximab",
      belimumab_medication ~ "Belimumab",
      cyclophosphamide_medication ~ "Cyclophosphamide",
      tacrolimus_medication ~ "Tacrolimus",
      ciclosporin_medication ~ "Ciclosporin",
      ace_medication ~ "Angiotensin-Converting Enzyme Inhibitors",
      arbs_medication ~ "Angiotensin Receptor Blockers",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      beta_blockers_medication ~ "Beta Blockers",
      calcium_channel_blockers_medication ~ "Calcium Channel Blockers",
      diuretics_medication ~ "Diuretics",
      sglt_2_medication ~ "Sodium-Glucose Cotransporter-2 Inhibitors",
      glp_1_medication ~ "Glucagon-Like Peptide-1 Agonists",
      metformin_medication ~ "Metformin",
      insulin_medication ~ "Insulin"
    )
  ) %>%
  add_n() %>%
  add_difference(everything() ~ "smd") %>%
  add_p(
    pvalue_fun = custom_pvalue_fun,
    test = list(all_continuous() ~ "t.test")
  ) %>%
  modify_column_hide(ci) %>%
  modify_header(estimate ~ "**SMD (Unweighted)**")

# Create survey design object for weighted analysis
# Create survey design object for weighted analysis
svy_design <- svydesign(
  ids = ~1,
  weights = ~iptw,
  data = cohort_tbl1
)

# Create WEIGHTED table using survey design - SAME vars, values, and labels
table1_weighted <- svy_design %>%
  tbl_svysummary(
    by = lupus_group,
    missing = "no",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    include = all_of(table1_vars),
    
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      rituximab_medication ~ "1",
      belimumab_medication ~ "1",
      cyclophosphamide_medication ~ "1",
      tacrolimus_medication ~ "1",
      ciclosporin_medication ~ "1",
      ace_medication ~ "1",
      arbs_medication ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      beta_blockers_medication ~ "1",
      calcium_channel_blockers_medication ~ "1",
      diuretics_medication ~ "1",
      sglt_2_medication ~ "1",
      glp_1_medication ~ "1",
      metformin_medication ~ "1",
      insulin_medication ~ "1"
    ),
    
    label = list(
      age_at_index ~ "Age at Index (years)",
      gender ~ "Sex (Female)",
      birth_year ~ "Birth Year",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_acr ~ "Baseline Albumin-to-Creatinine Ratio (mg/g)",
      baseline_pcr ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      baseline_24hr_protein ~ "Baseline 24-hour Urine Protein (mg/day)",
      baseline_spot_albumin ~ "Baseline Spot Urine Albumin (mg/L)",
      baseline_spot_protein ~ "Baseline Spot Urine Protein (mg/dL)",
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      rituximab_medication ~ "Rituximab",
      belimumab_medication ~ "Belimumab",
      cyclophosphamide_medication ~ "Cyclophosphamide",
      tacrolimus_medication ~ "Tacrolimus",
      ciclosporin_medication ~ "Ciclosporin",
      ace_medication ~ "Angiotensin-Converting Enzyme Inhibitors",
      arbs_medication ~ "Angiotensin Receptor Blockers",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      beta_blockers_medication ~ "Beta Blockers",
      calcium_channel_blockers_medication ~ "Calcium Channel Blockers",
      diuretics_medication ~ "Diuretics",
      sglt_2_medication ~ "Sodium-Glucose Cotransporter-2 Inhibitors",
      glp_1_medication ~ "Glucagon-Like Peptide-1 Agonists",
      metformin_medication ~ "Metformin",
      insulin_medication ~ "Insulin"
    )
  ) %>%
  add_difference(everything() ~ "smd") %>%
  modify_column_hide(ci) %>%
  modify_header(estimate ~ "**SMD (Weighted)**")

# Merge unweighted and weighted tables
table1_combined <- tbl_merge(
  tbls = list(table1_unweighted, table1_weighted),
  tab_spanner = c("**Unweighted**", "**IPTW Weighted (ATT)**")
)

cat("\n✓ Combined Table 1 created successfully!\n")

# Save to Word
ft_table1 <- table1_combined %>%
  as_flex_table() %>%
  autofit()

doc_table1 <- read_docx() %>%
  body_add_par("Table 1: Baseline Characteristics by Lupus Status", style = "heading 1") %>%
  body_add_par("Unweighted and Inverse Probability of Treatment Weighted (IPTW) comparison using Average Treatment Effect on the Treated (ATT)", 
               style = "Normal") %>%
  body_add_flextable(ft_table1)

print(doc_table1, target = "Table1_Baseline_Characteristics_Lupus_Combined.docx")

cat("Combined Table 1 saved to: Table1_Baseline_Characteristics_Lupus_Combined.docx\n")

# Display the table
table1_combined
```



#chunck 7 




```{r}
# ============================================================================
# CHUNK: Drug Load Imputation for Prednisone and Hydroxychloroquine
# Complete workflow from raw data to yearly aggregated wide format
# FIXED: All select() calls now use dplyr::select() to avoid masking issues
# ============================================================================

cat("\n=== DRUG LOAD IMPUTATION: Prednisone & Hydroxychloroquine ===\n\n")

library(dplyr)
library(tidyr)
library(readr)
library(lubridate)

# ============================================================================
# STEP 0: Load raw dispensing data
# ============================================================================

cat("STEP 0: Loading raw dispensing data...\n")

# Load prednisone data
PREDNISONE_FIRST_99 <- read_csv(
  "//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47631][Prednisone_first_99][v-ruthsm_nat][qe_34863][20251224_165858558_2926].csv",
  locale = locale(encoding = "UTF-8")
)
PREDNISONE_FIRST_99 <- fix_cols(PREDNISONE_FIRST_99)

# Load hydroxychloroquine data
HYDROXYCHLOROQUINE_FIRST_99 <- read_csv(
  "//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47631][Hydroxychloroquine_first_99][v-ruthsm_nat][qe_34863][20251224_165858551_836].csv",
  locale = locale(encoding = "UTF-8")
)
HYDROXYCHLOROQUINE_FIRST_99 <- fix_cols(HYDROXYCHLOROQUINE_FIRST_99)

cat("✓ Data loaded\n")
cat("  Prednisone records:", nrow(PREDNISONE_FIRST_99), "\n")
cat("  Hydroxychloroquine records:", nrow(HYDROXYCHLOROQUINE_FIRST_99), "\n\n")



# ============================================================================
# STEP 1: Filter to study period (2015-2023) and identify missing DDD
# ============================================================================

cat("STEP 1: Filtering to study period (2015-2023)...\n")

# Filter prednisone to study period
PREDNISONE_STUDY_PERIOD <- PREDNISONE_FIRST_99 %>%
  mutate(
    year = lubridate::year(prednisone_first_99_date_dispensed)
  ) %>%
  filter(year >= 2015 & year <= 2023)

cat("  Prednisone 2015-2023:", nrow(PREDNISONE_STUDY_PERIOD), "records\n")

# Check missing DDD
prednisone_missing_ddd <- PREDNISONE_STUDY_PERIOD %>%
  filter(prednisone_first_99_dispensed_quantity_ddd == 0 | is.na(prednisone_first_99_dispensed_quantity_ddd))

cat("  Missing DDD:", nrow(prednisone_missing_ddd), 
    sprintf("(%.1f%%)", 100 * nrow(prednisone_missing_ddd) / nrow(PREDNISONE_STUDY_PERIOD)), "\n\n")

# Filter hydroxychloroquine to study period
HYDROXY_STUDY_PERIOD <- HYDROXYCHLOROQUINE_FIRST_99 %>%
  mutate(
    year = lubridate::year(hydroxychloroquine_first_99_date_dispensed)
  ) %>%
  filter(year >= 2015 & year <= 2023)

cat("  Hydroxychloroquine 2015-2023:", nrow(HYDROXY_STUDY_PERIOD), "records\n")

# Check missing DDD
hydroxy_missing_ddd <- HYDROXY_STUDY_PERIOD %>%
  filter(hydroxychloroquine_first_99_dispensed_quantity_ddd == 0 | is.na(hydroxychloroquine_first_99_dispensed_quantity_ddd))

cat("  Missing DDD:", nrow(hydroxy_missing_ddd), 
    sprintf("(%.1f%%)", 100 * nrow(hydroxy_missing_ddd) / nrow(HYDROXY_STUDY_PERIOD)), "\n\n")

# ============================================================================
# STEP 1B: Create imputation lookup tables (median DDD by medication)
# ============================================================================

cat("STEP 1B: Creating imputation lookup tables...\n")

# Prednisone: Calculate median DDD for each medication (excluding zeros)
prednisone_imputation_lookup <- PREDNISONE_STUDY_PERIOD %>%
  filter(prednisone_first_99_dispensed_quantity_ddd > 0) %>%
  group_by(prednisone_first_99_medication) %>%
  summarise(
    median_ddd = median(prednisone_first_99_dispensed_quantity_ddd, na.rm = TRUE),
    n_observations = n(),
    .groups = "drop"
  )

cat("  Prednisone medications with lookup values:", nrow(prednisone_imputation_lookup), "\n")

# Hydroxychloroquine: Calculate median DDD for each medication (excluding zeros)
hydroxy_imputation_lookup <- HYDROXY_STUDY_PERIOD %>%
  filter(hydroxychloroquine_first_99_dispensed_quantity_ddd > 0) %>%
  group_by(hydroxychloroquine_first_99_medication) %>%
  summarise(
    median_ddd = median(hydroxychloroquine_first_99_dispensed_quantity_ddd, na.rm = TRUE),
    n_observations = n(),
    .groups = "drop"
  )

cat("  Hydroxychloroquine medications with lookup values:", nrow(hydroxy_imputation_lookup), "\n\n")

# ============================================================================
# STEP 2: Apply imputation to create corrected datasets - FIXED
# ============================================================================

cat("STEP 2: Applying imputation...\n")

# Impute PREDNISONE
PREDNISONE_IMPUTED <- PREDNISONE_STUDY_PERIOD %>%
  left_join(
    prednisone_imputation_lookup %>%
      dplyr::select(prednisone_first_99_medication, median_ddd),
    by = "prednisone_first_99_medication"
  ) %>%
  mutate(
    ddd_corrected = case_when(
      prednisone_first_99_dispensed_quantity_ddd > 0 ~ prednisone_first_99_dispensed_quantity_ddd,
      prednisone_first_99_dispensed_quantity_ddd == 0 & !is.na(median_ddd) ~ median_ddd,
      TRUE ~ 0
    ),
    was_imputed = (prednisone_first_99_dispensed_quantity_ddd == 0 & ddd_corrected > 0)
  ) %>%
  dplyr::select(-median_ddd)

# Impute HYDROXYCHLOROQUINE
HYDROXY_IMPUTED <- HYDROXY_STUDY_PERIOD %>%
  left_join(
    hydroxy_imputation_lookup %>%
      dplyr::select(hydroxychloroquine_first_99_medication, median_ddd),
    by = "hydroxychloroquine_first_99_medication"
  ) %>%
  mutate(
    ddd_corrected = case_when(
      hydroxychloroquine_first_99_dispensed_quantity_ddd > 0 ~ hydroxychloroquine_first_99_dispensed_quantity_ddd,
      hydroxychloroquine_first_99_dispensed_quantity_ddd == 0 & !is.na(median_ddd) ~ median_ddd,
      TRUE ~ 0
    ),
    was_imputed = (hydroxychloroquine_first_99_dispensed_quantity_ddd == 0 & ddd_corrected > 0)
  ) %>%
  dplyr::select(-median_ddd)

cat("✓ Imputation complete\n")
cat("  Prednisone imputed:", sum(PREDNISONE_IMPUTED$was_imputed, na.rm = TRUE), "records\n")
cat("  Hydroxychloroquine imputed:", sum(HYDROXY_IMPUTED$was_imputed, na.rm = TRUE), "records\n\n")

# ============================================================================
# STEP 3: Validation - Compare before and after imputation
# ============================================================================

cat("STEP 3: Validation...\n")

# Prednisone validation
cat("\nPreднisone:\n")
cat("  Before imputation - Zero DDD:", sum(PREDNISONE_STUDY_PERIOD$prednisone_first_99_dispensed_quantity_ddd == 0, na.rm = TRUE), "\n")
cat("  After imputation  - Zero DDD:", sum(PREDNISONE_IMPUTED$ddd_corrected == 0, na.rm = TRUE), "\n")
cat("  Total DDD before:", sum(PREDNISONE_STUDY_PERIOD$prednisone_first_99_dispensed_quantity_ddd, na.rm = TRUE), "\n")
cat("  Total DDD after: ", sum(PREDNISONE_IMPUTED$ddd_corrected, na.rm = TRUE), "\n")

# Hydroxychloroquine validation
cat("\nHydroxychloroquine:\n")
cat("  Before imputation - Zero DDD:", sum(HYDROXY_STUDY_PERIOD$hydroxychloroquine_first_99_dispensed_quantity_ddd == 0, na.rm = TRUE), "\n")
cat("  After imputation  - Zero DDD:", sum(HYDROXY_IMPUTED$ddd_corrected == 0, na.rm = TRUE), "\n")
cat("  Total DDD before:", sum(HYDROXY_STUDY_PERIOD$hydroxychloroquine_first_99_dispensed_quantity_ddd, na.rm = TRUE), "\n")
cat("  Total DDD after: ", sum(HYDROXY_IMPUTED$ddd_corrected, na.rm = TRUE), "\n\n")

# ============================================================================
# STEP 4: Add patient ID column
# ============================================================================

cat("STEP 4: Adding patient ID column...\n")

PREDNISONE_IMPUTED <- PREDNISONE_IMPUTED %>%
  mutate(mdcinternalpatientid = prednisone_first_99_patient_id)

HYDROXY_IMPUTED <- HYDROXY_IMPUTED %>%
  mutate(mdcinternalpatientid = hydroxychloroquine_first_99_patient_id)

cat("✓ Patient ID column added\n\n")

# ============================================================================
# STEP 5: Save imputed datasets (long format)
# ============================================================================

cat("STEP 5: Saving imputed datasets...\n")

write_csv(PREDNISONE_IMPUTED, "prednisone_imputed_2015_2023.csv")
write_csv(HYDROXY_IMPUTED, "hydroxychloroquine_imputed_2015_2023.csv")

cat("✓ Saved:\n")
cat("  - prednisone_imputed_2015_2023.csv\n")
cat("  - hydroxychloroquine_imputed_2015_2023.csv\n\n")

# ============================================================================
# STEP 6: Calculate total cumulative DDD per patient (entire study period)
# ============================================================================

cat("STEP 6: Calculating cumulative DDD per patient (2015-2023)...\n")

# Prednisone cumulative
prednisone_cumulative <- PREDNISONE_IMPUTED %>%
  group_by(mdcinternalpatientid) %>%
  summarise(
    total_prednisone_ddd = sum(ddd_corrected, na.rm = TRUE),
    n_dispensings_pred = n(),
    .groups = "drop"
  )

# Hydroxychloroquine cumulative
hydroxy_cumulative <- HYDROXY_IMPUTED %>%
  group_by(mdcinternalpatientid) %>%
  summarise(
    total_hydroxy_ddd = sum(ddd_corrected, na.rm = TRUE),
    n_dispensings_hydroxy = n(),
    .groups = "drop"
  )

# Combine
drug_exposure_cumulative <- prednisone_cumulative %>%
  full_join(hydroxy_cumulative, by = "mdcinternalpatientid") %>%
  mutate(
    total_prednisone_ddd = replace_na(total_prednisone_ddd, 0),
    total_hydroxy_ddd = replace_na(total_hydroxy_ddd, 0),
    n_dispensings_pred = replace_na(n_dispensings_pred, 0),
    n_dispensings_hydroxy = replace_na(n_dispensings_hydroxy, 0)
  )

cat("✓ Cumulative DDD calculated\n")
cat("  Unique patients:", nrow(drug_exposure_cumulative), "\n\n")

# Save cumulative
write_csv(drug_exposure_cumulative, "drug_exposure_cumulative_2015_2023.csv")
cat("✓ Saved: drug_exposure_cumulative_2015_2023.csv\n\n")

# ============================================================================
# STEP 7: Create yearly wide format (patient-year level)
# ============================================================================

cat("STEP 7: Creating wide format (patient-year level, 2015-2023)...\n")

# Aggregate by patient and year for prednisone
prednisone_yearly <- PREDNISONE_IMPUTED %>%
  group_by(mdcinternalpatientid, year) %>%
  summarise(
    prednisone_yearly_ddd = sum(ddd_corrected, na.rm = TRUE),
    prednisone_n_dispensings = n(),
    .groups = "drop"
  )

# Aggregate by patient and year for hydroxychloroquine
hydroxy_yearly <- HYDROXY_IMPUTED %>%
  group_by(mdcinternalpatientid, year) %>%
  summarise(
    hydroxy_yearly_ddd = sum(ddd_corrected, na.rm = TRUE),
    hydroxy_n_dispensings = n(),
    .groups = "drop"
  )

# Create wide format
yearly_wide <- prednisone_yearly %>%
  full_join(
    hydroxy_yearly,
    by = c("mdcinternalpatientid", "year")
  ) %>%
  mutate(
    prednisone_yearly_ddd = replace_na(prednisone_yearly_ddd, 0),
    hydroxy_yearly_ddd = replace_na(hydroxy_yearly_ddd, 0),
    prednisone_n_dispensings = replace_na(prednisone_n_dispensings, 0),
    hydroxy_n_dispensings = replace_na(hydroxy_n_dispensings, 0),
    
    # Flags
    received_prednisone = prednisone_yearly_ddd > 0,
    received_hydroxy = hydroxy_yearly_ddd > 0,
    received_both = received_prednisone & received_hydroxy
  ) %>%
  arrange(mdcinternalpatientid, year)

cat("✓ Wide format created\n")
cat("  Rows:", nrow(yearly_wide), "\n")
cat("  Unique patients:", n_distinct(yearly_wide$mdcinternalpatientid), "\n")
cat("  Years covered:", paste(range(yearly_wide$year), collapse = " to "), "\n\n")

# Save the wide format
write_csv(yearly_wide, "drug_exposure_yearly_wide_2015_2023.csv")

cat("✓ Saved: drug_exposure_yearly_wide_2015_2023.csv\n\n")

# ============================================================================
# STEP 8: Summary statistics
# ============================================================================

cat("STEP 8: Summary statistics by year...\n\n")

yearly_summary <- yearly_wide %>%
  group_by(year) %>%
  summarise(
    n_patients = n_distinct(mdcinternalpatientid),
    n_prednisone = sum(received_prednisone),
    n_hydroxy = sum(received_hydroxy),
    n_both = sum(received_both),
    mean_pred_ddd = mean(prednisone_yearly_ddd[prednisone_yearly_ddd > 0], na.rm = TRUE),
    mean_hydroxy_ddd = mean(hydroxy_yearly_ddd[hydroxy_yearly_ddd > 0], na.rm = TRUE),
    median_pred_ddd = median(prednisone_yearly_ddd[prednisone_yearly_ddd > 0], na.rm = TRUE),
    median_hydroxy_ddd = median(hydroxy_yearly_ddd[hydroxy_yearly_ddd > 0], na.rm = TRUE),
    .groups = "drop"
  )

print(yearly_summary)

# ============================================================================
# STEP 9: Overall summary
# ============================================================================

cat("\n\n", rep("=", 80), "\n", sep = "")
cat("DRUG LOAD IMPUTATION SUMMARY\n")
cat(rep("=", 80), "\n\n", sep = "")

cat("PREDNISONE:\n")
cat("  Total records (2015-2023):", nrow(PREDNISONE_IMPUTED), "\n")
cat("  Records imputed:", sum(PREDNISONE_IMPUTED$was_imputed), "\n")
cat("  Unique patients:", n_distinct(PREDNISONE_IMPUTED$mdcinternalpatientid), "\n")
cat("  Total DDD (after imputation):", sum(PREDNISONE_IMPUTED$ddd_corrected), "\n\n")

cat("HYDROXYCHLOROQUINE:\n")
cat("  Total records (2015-2023):", nrow(HYDROXY_IMPUTED), "\n")
cat("  Records imputed:", sum(HYDROXY_IMPUTED$was_imputed), "\n")
cat("  Unique patients:", n_distinct(HYDROXY_IMPUTED$mdcinternalpatientid), "\n")
cat("  Total DDD (after imputation):", sum(HYDROXY_IMPUTED$ddd_corrected), "\n\n")

cat("FILES CREATED:\n")
cat("  1. prednisone_imputed_2015_2023.csv (long format, dispensing-level)\n")
cat("  2. hydroxychloroquine_imputed_2015_2023.csv (long format, dispensing-level)\n")
cat("  3. drug_exposure_cumulative_2015_2023.csv (patient-level, total DDD)\n")
cat("  4. drug_exposure_yearly_wide_2015_2023.csv (patient-year level)\n\n")

cat("✓ DRUG LOAD IMPUTATION COMPLETE!\n")
cat(rep("=", 80), "\n\n", sep = "")
```






# TABLE 1 FINAL: Baseline Characteristics (REVISED)

```{r}
# ============================================================================
# TABLE 1 FINAL: Baseline Characteristics (REVISED)
# ============================================================================

cat("\n=== Creating TABLE 1 FINAL: Baseline Characteristics (REVISED) ===\n\n")

library(gtsummary)
library(flextable)
library(officer)
library(survey)
library(lubridate)

# Prepare cohort_tbl1 with all variables
cohort_tbl1 <- cohort_weighted %>%
  mutate(
    # Convert Lupus to factor
    lupus_group = factor(Lupus, levels = c(0, 1), labels = c("Control", "Lupus")),
    
    # Calculate current age (from birth_date to today)
    current_age = as.numeric(difftime(Sys.Date(), birth_date, units = "days")) / 365.25,
    
    # Convert gender to factor
    gender = factor(ifelse(gender_numeric == 1, "Female", "Male"), levels = c("Male", "Female")),
    
    # Socioeconomic status
    ses_category = factor(
      socioeconomic_score_three_level_scale,
      levels = c("Low", "Medium", "High")
    ),
    
    # BMI
    bmi = coalesce(bmi_first_hospital_bmi_numeric, bmi_first_community_bmi),
    
    # Fix CCI variables: 0 = 0, anything else = 1
    cci_cerebrovascular_disease = case_when(
      is.na(cci_cerebrovascular_disease) ~ NA_real_,
      cci_cerebrovascular_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_chronic_pulmonary_disease = case_when(
      is.na(cci_chronic_pulmonary_disease) ~ NA_real_,
      cci_chronic_pulmonary_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_dementia = case_when(
      is.na(cci_dementia) ~ NA_real_,
      cci_dementia == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_malignancy = case_when(
      is.na(cci_malignancy) ~ NA_real_,
      cci_malignancy == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_renal_disease = case_when(
      is.na(cci_renal_disease) ~ NA_real_,
      cci_renal_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    
    # PROTEIN VARIABLE ONLY
    baseline_protein = pcr_combined,  # PCR in mg/g (includes converted from ACR)
    
    # NEW COMBINED MEDICATION VARIABLES
    # 2. Biologic Treatments (Rituximab + Belimumab)
    biologic_treatments = ifelse(rituximab_medication == 1 | belimumab_medication == 1, 1, 0),
    
    # 3. Calcineurin Inhibitors (Tacrolimus + Ciclosporin)
    calcineurin_inhibitors = ifelse(tacrolimus_medication == 1 | ciclosporin_medication == 1, 1, 0),
    
    # 4. RAAS Inhibitors (ACE + ARB)
    raas_inhibitors = ifelse(ace_medication == 1 | arbs_medication == 1, 1, 0),
    
    # 5. Antihypertensive Medications (Beta blockers + Calcium channel blockers + Diuretics)
    antihypertensive_medications = ifelse(
      beta_blockers_medication == 1 | 
      calcium_channel_blockers_medication == 1 | 
      diuretics_medication == 1, 
      1, 0
    ),
    
    # 6. Diabetes Medications (SGLT2i + GLP1RA + Metformin + Insulin)
    diabetes_medications = ifelse(
      sglt_2_medication == 1 | 
      glp_1_medication == 1 | 
      metformin_medication == 1 | 
      insulin_medication == 1,
      1, 0
    )
  )

# Define all variables - REVISED LIST
table1_vars <- c(
  "current_age",              # CHANGED: from age_at_index to current_age
  "gender",
  "birth_year",
  "ses_category",
  "bmi",
  "ever_smoker",
  "baseline_gfr",
  "baseline_gfr_category",
  "baseline_protein",
  "cci_charlson_score_total",
  "diabetes_diagnosis",
  "hypertension_diagnosis",
  "ischemic_heart_disease_diagnosis",
  "chf_diagnosis",
  "cci_cerebrovascular_disease",
  "cci_chronic_pulmonary_disease",
  "cci_dementia",
  "cci_malignancy",
  "cci_renal_disease",
  # Lupus medications
  "hydroxychloroquine_medication",
  "azathioprine_medication",
  "mycophenolate_medication",
  "methotrexate_medication",
  "prednisone_medication",
  "biologic_treatments",           # NEW: Combined RTX + Belimumab
  "calcineurin_inhibitors",        # NEW: Combined Tacrolimus + Ciclosporin
  # Cardiovascular medications
  "raas_inhibitors",               # NEW: Combined ACE + ARB
  "statins_medication",            # KEPT ALONE
  "aspirin_medication",            # KEPT ALONE
  "antihypertensive_medications",  # NEW: Beta blockers + CCB + Diuretics
  # Diabetes medications
  "diabetes_medications"           # NEW: All diabetes meds combined
)

cat("Building unweighted table...\n")

# Build UNWEIGHTED table
table1_unweighted <- cohort_tbl1 %>%
  dplyr::select(lupus_group, all_of(table1_vars)) %>%
  tbl_summary(
    by = lupus_group,
    missing = "no",
    
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      biologic_treatments ~ "1",
      calcineurin_inhibitors ~ "1",
      raas_inhibitors ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      antihypertensive_medications ~ "1",
      diabetes_medications ~ "1"
    ),
    
    label = list(
      current_age ~ "Current Age (years)",
      gender ~ "Sex (Female)",
      birth_year ~ "Birth Year",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_protein ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      biologic_treatments ~ "Biologic Treatments",
      calcineurin_inhibitors ~ "Calcineurin Inhibitors",
      raas_inhibitors ~ "Renin-Angiotensin-Aldosterone System Inhibitors",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      antihypertensive_medications ~ "Antihypertensive Medications",
      diabetes_medications ~ "Diabetes Medications"
    )
  ) %>%
  add_n() %>%
  add_difference(everything() ~ "smd") %>%
  modify_column_hide(ci) %>%
  modify_header(estimate ~ "**SMD**")

cat("Building weighted table (SMD only)...\n")

# Create survey design for weighted analysis
svy_design <- svydesign(
  ids = ~1,
  weights = ~iptw,
  data = cohort_tbl1
)

# Build WEIGHTED table (SMD only)
table1_weighted_smd <- svy_design %>%
  tbl_svysummary(
    by = lupus_group,
    missing = "no",
    include = all_of(table1_vars),
    
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      biologic_treatments ~ "1",
      calcineurin_inhibitors ~ "1",
      raas_inhibitors ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      antihypertensive_medications ~ "1",
      diabetes_medications ~ "1"
    ),
    
    label = list(
      current_age ~ "Current Age (years)",
      gender ~ "Sex (Female)",
      birth_year ~ "Birth Year",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_protein ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      biologic_treatments ~ "Biologic Treatments",
      calcineurin_inhibitors ~ "Calcineurin Inhibitors",
      raas_inhibitors ~ "Renin-Angiotensin-Aldosterone System Inhibitors",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      antihypertensive_medications ~ "Antihypertensive Medications",
      diabetes_medications ~ "Diabetes Medications"
    )
  ) %>%
  add_difference(everything() ~ "smd") %>%
  modify_column_hide(c(stat_1, stat_2, ci)) %>%
  modify_header(estimate ~ "**SMD (Weighted)**")

cat("Merging tables...\n")

# Merge unweighted and weighted SMD
table1_combined <- tbl_merge(
  tbls = list(table1_unweighted, table1_weighted_smd),
  tab_spanner = c("**Unweighted**", "**IPTW Weighted (ATT)**")
)

cat("\n✓ Table 1 FINAL (REVISED) created successfully!\n")

# Save to Word
ft_table1 <- table1_combined %>%
  as_flex_table() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  bg(bg = "#2C2C2C", part = "header") %>%
  color(color = "white", part = "header") %>%
  align(align = "center", part = "header") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_table1 <- read_docx() %>%
  body_add_par("Table 1: Baseline Characteristics by Lupus Status", style = "heading 1") %>%
  body_add_par(
    paste0(
      "Biologic Treatments include Rituximab and Belimumab. ",
      "Calcineurin Inhibitors include Tacrolimus and Ciclosporin. ",
      "RAAS Inhibitors include ACE inhibitors and ARBs. ",
      "Antihypertensive Medications include Beta blockers, Calcium channel blockers, and Diuretics. ",
      "Diabetes Medications include SGLT-2 inhibitors, GLP-1 agonists, Metformin, and Insulin."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_table1)

print(doc_table1, target = "Table1_Baseline_Characteristics_Lupus_Final_REVISED.docx")

cat("Table 1 saved to: Table1_Baseline_Characteristics_Lupus_Final_REVISED.docx\n")

# Display the table
table1_combined

# Print summary of changes
cat("\n=== SUMMARY OF CHANGES ===\n")
cat("1. ✓ Changed Age at Index → Current Age (calculated to today)\n")
cat("2. ✓ Dropped Cyclophosphamide\n")
cat("3. ✓ Combined Rituximab + Belimumab → Biologic Treatments\n")
cat("4. ✓ Combined Tacrolimus + Ciclosporin → Calcineurin Inhibitors\n")
cat("5. ✓ Combined ACE + ARB → RAAS Inhibitors\n")
cat("6. ✓ Combined Beta blockers + CCB + Diuretics → Antihypertensive Medications\n")
cat("7. ✓ Combined SGLT2i + GLP1RA + Metformin + Insulin → Diabetes Medications\n")
cat("8. ✓ Kept Statins and Aspirin as separate variables\n\n")

cat("New combined variable frequencies:\n")
cat("Biologic Treatments:", sum(cohort_tbl1$biologic_treatments == 1, na.rm = TRUE), "\n")
cat("Calcineurin Inhibitors:", sum(cohort_tbl1$calcineurin_inhibitors == 1, na.rm = TRUE), "\n")
cat("RAAS Inhibitors:", sum(cohort_tbl1$raas_inhibitors == 1, na.rm = TRUE), "\n")
cat("Antihypertensive Medications:", sum(cohort_tbl1$antihypertensive_medications == 1, na.rm = TRUE), "\n")
cat("Diabetes Medications:", sum(cohort_tbl1$diabetes_medications == 1, na.rm = TRUE), "\n")
```


#outcome def
```{r}
# ============================================================================
# CHUNK 9 REVISED: CKD Outcome = GFR < 60 OR Proteinuria > 500 mg/L
# ============================================================================

cat("\n=== CHUNK 9 REVISED: Defining CKD outcome (GFR + Proteinuria) ===\n\n")

# Start with cohort_weighted
cohort_with_outcomes <- cohort_weighted

# ============================================================================
# STEP 1: Define ESKD (unchanged)
# ============================================================================

cat("Defining ESKD outcome...\n")

cohort_with_outcomes <- cohort_with_outcomes %>%
  mutate(
    eskd_date_clean = as.Date(eskd_date),
    dialysis_diag_date_clean = as.Date(dialysis_diag_start_date),
    dialysis_proc_date_clean = as.Date(dialysis_procedure_procedure_date),
    transplant_start_date_clean = as.Date(kidney_transplant_start_date),
    transplant_proc_date_clean = as.Date(kidney_transplantation_proc_procedure_date),
    
    eskd_date_final = pmin(
      eskd_date_clean, dialysis_diag_date_clean, dialysis_proc_date_clean,
      transplant_start_date_clean, transplant_proc_date_clean, na.rm = TRUE
    ),
    
    eskd_event = case_when(
      eskd_diagnosis == 1 | dialysis_diag_diagnosis == 1 | 
      dialysis_procedure_procedure == 1 | kidney_transplant_diagnosis == 1 | 
      kidney_transplantation_proc_procedure == 1 ~ 1,
      TRUE ~ 0
    ),
    
    eskd_time = case_when(
      eskd_event == 1 & !is.na(eskd_date_final) & eskd_date_final > index_date ~ 
        as.numeric(eskd_date_final - index_date),
      eskd_event == 1 ~ 1,
      TRUE ~ NA_real_
    )
  )

cat("ESKD events:", sum(cohort_with_outcomes$eskd_event == 1), "\n\n")

# ============================================================================
# STEP 2: Define Death and MACE (unchanged)
# ============================================================================

cohort_with_outcomes <- cohort_with_outcomes %>%
  mutate(
    death_date_clean = as.Date(death_deceased_date),
    death_event = ifelse(!is.na(death_date_clean) & death_date_clean > index_date, 1, 0),
    death_time = as.numeric(death_date_clean - index_date),
    
    mace_date_clean = index_date + mace_without_death_start_date_days_from_reference,
    mace_event = case_when(
      mace_without_death_diagnosis == 1 & mace_date_clean > index_date ~ 1,
      TRUE ~ 0
    ),
    mace_time = as.numeric(mace_date_clean - index_date)
  )

# ============================================================================
# STEP 3: Define CKD - PART A: GFR < 60
# ============================================================================

cat("Defining CKD outcome - Part A: GFR < 60...\n")

gfr_followup <- cohort_with_outcomes %>%
  dplyr::select(mdcinternalpatientid, index_date, Lupus) %>%
  left_join(
    GFR_FIRST_99 %>% dplyr::select(mdcinternalpatientid, gfr_ckd_epi, gfr_start_date),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    gfr_date = as.Date(gfr_start_date),
    days_after_index = as.numeric(gfr_date - index_date)
  ) %>%
  filter(days_after_index > 0) %>%
  arrange(mdcinternalpatientid, gfr_date)

# Identify GFR-based CKD (GFR < 60 on 2+ occasions ≥90 days apart)
ckd_gfr_events <- gfr_followup %>%
  filter(gfr_ckd_epi < 60) %>%
  group_by(mdcinternalpatientid) %>%
  arrange(gfr_date) %>%
  mutate(
    days_since_prev = c(NA, diff(as.numeric(gfr_date))),
    eligible_second = days_since_prev >= 90
  ) %>%
  filter(!is.na(eligible_second) & eligible_second == TRUE) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(mdcinternalpatientid, ckd_gfr_date = gfr_date)

cat("Patients with CKD by GFR < 60:", nrow(ckd_gfr_events), "\n")

# ============================================================================
# STEP 4: Define CKD - PART B: Proteinuria > 500 mg/L
# ============================================================================

cat("Defining CKD outcome - Part B: Proteinuria > 500 mg/L...\n")

protein_followup <- cohort_with_outcomes %>%
  dplyr::select(mdcinternalpatientid, index_date, Lupus) %>%
  left_join(
    PROTERIN_URINE_FIRST_99 %>% dplyr::select(
      mdcinternalpatientid,
      proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_date,
      proteinuria_urine_sample_result_unit
    ),
    by = "mdcinternalpatientid"
  ) %>%
  mutate(
    protein_date = as.Date(proteinuria_urine_sample_result_date),
    days_after_index = as.numeric(protein_date - index_date),
    
    # Standardize to mg/L
    protein_mg_l = case_when(
      proteinuria_urine_sample_result_unit == "mg/L" ~ proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_unit %in% c("mg/dL", "mg/dl", "mg%") ~ 
        proteinuria_urine_sample_result_as_number * 10,
      proteinuria_urine_sample_result_unit %in% c("µg/ml", "µg/mL", "ug/ml") ~ 
        proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_unit %in% c("g/L", "g/l") ~ 
        proteinuria_urine_sample_result_as_number * 1000,
      proteinuria_urine_sample_result_unit %in% c("mg/g Crea", "mg/g", "mg/g creat") ~ 
        proteinuria_urine_sample_result_as_number,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(days_after_index > 0,  # AFTER index only
         !is.na(protein_mg_l),
         protein_mg_l >= 0,
         protein_mg_l < 100000) %>%
  arrange(mdcinternalpatientid, protein_date)

# Identify protein-based CKD (protein > 500 mg/L on ANY measurement)
ckd_protein_events <- protein_followup %>%
  filter(protein_mg_l > 500) %>%
  group_by(mdcinternalpatientid) %>%
  slice(1) %>%  # First occurrence of protein > 500
  ungroup() %>%
  dplyr::select(mdcinternalpatientid, ckd_protein_date = protein_date)

cat("Patients with CKD by proteinuria > 500 mg/L:", nrow(ckd_protein_events), "\n")

# ============================================================================
# STEP 5: Combine CKD definitions (GFR OR Proteinuria)
# ============================================================================

cat("Combining CKD definitions...\n")

# Merge both CKD sources
cohort_with_outcomes <- cohort_with_outcomes %>%
  left_join(ckd_gfr_events, by = "mdcinternalpatientid") %>%
  left_join(ckd_protein_events, by = "mdcinternalpatientid") %>%
  mutate(
    # CKD event = 1 if EITHER GFR < 60 OR protein > 500
    ckd_event = case_when(
      !is.na(ckd_gfr_date) | !is.na(ckd_protein_date) ~ 1,
      TRUE ~ 0
    ),
    
    # CKD date = earliest of GFR or protein event
    ckd_date = pmin(ckd_gfr_date, ckd_protein_date, na.rm = TRUE),
    
    # CKD time
    ckd_time = as.numeric(ckd_date - index_date),
    
    # Flag which criterion met
    ckd_by_gfr = ifelse(!is.na(ckd_gfr_date), 1, 0),
    ckd_by_protein = ifelse(!is.na(ckd_protein_date), 1, 0),
    ckd_by_both = ifelse(!is.na(ckd_gfr_date) & !is.na(ckd_protein_date), 1, 0)
  )

cat("\n=== CKD Event Summary ===\n")
cat("Total CKD events:", sum(cohort_with_outcomes$ckd_event == 1), "\n")
cat("  - By GFR < 60 only:", sum(cohort_with_outcomes$ckd_by_gfr == 1 & cohort_with_outcomes$ckd_by_protein == 0), "\n")
cat("  - By proteinuria > 500 only:", sum(cohort_with_outcomes$ckd_by_protein == 1 & cohort_with_outcomes$ckd_by_gfr == 0), "\n")
cat("  - By BOTH:", sum(cohort_with_outcomes$ckd_by_both == 1), "\n\n")

# ============================================================================
# STEP 6: Calculate follow-up times (with admin censoring at end of 2025)
# ============================================================================

cat("Calculating follow-up times...\n")

admin_censor_date <- as.Date("2025-12-31")

cohort_with_outcomes <- cohort_with_outcomes %>%
  mutate(
    admin_censor_time = as.numeric(admin_censor_date - index_date),
    
    # CKD follow-up: censored at ESKD, death, or admin censoring
    ckd_followup_time = pmin(
      ifelse(ckd_event == 1, ckd_time, Inf),
      ifelse(eskd_event == 1, eskd_time, Inf),
      ifelse(death_event == 1, death_time, Inf),
      admin_censor_time,
      na.rm = TRUE
    ),
    ckd_status = ifelse(ckd_event == 1 & ckd_time == ckd_followup_time, 1, 0),
    ckd_followup_years = ckd_followup_time / 365.25,
    
    # ESKD follow-up
    eskd_followup_time = case_when(
      eskd_event == 1 ~ eskd_time,
      death_event == 1 ~ death_time,
      TRUE ~ admin_censor_time
    ),
    eskd_status = eskd_event,
    eskd_followup_years = eskd_followup_time / 365.25,
    
    # MACE follow-up
    cvd_followup_time = pmin(
      ifelse(mace_event == 1, mace_time, Inf),
      ifelse(death_event == 1, death_time, Inf),
      admin_censor_time,
      na.rm = TRUE
    ),
    cvd_status = ifelse(mace_event == 1 & mace_time == cvd_followup_time, 1, 0),
    cvd_followup_years = cvd_followup_time / 365.25,
    
    # Death follow-up
    death_followup_time = pmin(
      ifelse(death_event == 1, death_time, Inf),
      admin_censor_time,
      na.rm = TRUE
    ),
    death_status = ifelse(death_event == 1 & death_time == death_followup_time, 1, 0),
    death_followup_years = death_followup_time / 365.25
  )

# ============================================================================
# STEP 7: Final outcome summary
# ============================================================================

cat("\n=== FINAL OUTCOME SUMMARY ===\n\n")

cat("CKD (GFR < 60 OR Proteinuria > 500 mg/L):\n")
cat("  Lupus:", sum(cohort_with_outcomes$ckd_status[cohort_with_outcomes$Lupus == 1], na.rm = TRUE), "/",
    sum(cohort_with_outcomes$Lupus == 1),
    "(", round(100*mean(cohort_with_outcomes$ckd_status[cohort_with_outcomes$Lupus == 1], na.rm = TRUE), 1), "%)\n")
cat("  Control:", sum(cohort_with_outcomes$ckd_status[cohort_with_outcomes$Lupus == 0], na.rm = TRUE), "/",
    sum(cohort_with_outcomes$Lupus == 0),
    "(", round(100*mean(cohort_with_outcomes$ckd_status[cohort_with_outcomes$Lupus == 0], na.rm = TRUE), 1), "%)\n")
cat("  Median follow-up:", round(median(cohort_with_outcomes$ckd_followup_years), 2), "years\n\n")

# Create survival dataset
cohort_surv <- cohort_with_outcomes %>%
  mutate(lupus_factor = factor(Lupus, levels = c(0, 1), labels = c("Control", "Lupus")))

cat("✓ Chunk 9 REVISED complete with combined CKD definition\n")
cat("CKD now defined as: GFR < 60 (confirmed) OR Proteinuria > 500 mg/L\n")
```









#Outcome analysis

```{r}
# ============================================================================
# CHUNK 13: Outcome counts + IPTW Cox HRs IN ONE TABLE (rows aligned)
# ============================================================================

cat("\n=== CHUNK 13: Creating combined outcome table ===\n\n")

# Packages --------------------------------------------------------------------
library(dplyr)
library(survival)
library(survey)
library(gtsummary)
library(flextable)
library(officer)

# ============================================================================
# 1. Event-count table (tbl_summary)
# ============================================================================

cat("\nCreating outcome summary table...\n")

outcomes_for_table <- cohort_surv %>%
  dplyr::select(
    lupus_factor,
    ckd_status,
    eskd_status,
    cvd_status,
    death_status
  )

tbl_outcomes_summary <-
  outcomes_for_table %>%
  tbl_summary(
    by        = lupus_factor,
    missing   = "no",
    statistic = all_dichotomous() ~ "{n} ({p}%)",
    label = list(
      ckd_status   ~ "CKD",
      eskd_status  ~ "ESKD",
      cvd_status   ~ "MACE",
      death_status ~ "All-Cause Mortality"
    ),
    value = list(
      ckd_status   ~ "1",
      eskd_status  ~ "1",
      cvd_status   ~ "1",
      death_status ~ "1"
    )
  ) %>%
  add_n() %>%
  add_p() %>%
  bold_labels() %>%
  modify_header(label ~ "**Outcome**")

# ============================================================================
# 2. IPTW-weighted Cox models + regression table
# ============================================================================

cat("\nCreating IPTW-weighted Cox regression table...\n")

svy_cox <- svydesign(
  ids     = ~1,
  weights = ~iptw,
  data    = cohort_surv
)

cox_ckd   <- svycoxph(Surv(ckd_followup_years,   ckd_status)   ~ Lupus, design = svy_cox)
cox_eskd  <- svycoxph(Surv(eskd_followup_years,  eskd_status)  ~ Lupus, design = svy_cox)
cox_cvd   <- svycoxph(Surv(cvd_followup_years,   cvd_status)   ~ Lupus, design = svy_cox)
cox_death <- svycoxph(Surv(death_followup_years, death_status) ~ Lupus, design = svy_cox)

# helper: build one-row regression table and align variable names
make_tbl_cox <- function(model, var_name, nice_label) {
  tbl_regression(
    model,
    exponentiate = TRUE
  ) %>%
    modify_header(label ~ "**Outcome**") %>%
    modify_table_body(
      ~ .x %>%
        dplyr::mutate(
          variable = var_name,   # must match tbl_summary variable
          label    = nice_label
        )
    )
}

tbl_ckd   <- make_tbl_cox(cox_ckd,   "ckd_status",   "CKD")
tbl_eskd  <- make_tbl_cox(cox_eskd,  "eskd_status",  "ESKD")
tbl_cvd   <- make_tbl_cox(cox_cvd,   "cvd_status",   "MACE")
tbl_death <- make_tbl_cox(cox_death, "death_status", "All-Cause Mortality")

tbl_cox_stacked <-
  tbl_stack(
    tbls = list(tbl_ckd, tbl_eskd, tbl_cvd, tbl_death)
  )

# ============================================================================
# 3. Merge counts + HRs SIDE BY SIDE (same row per outcome)
# ============================================================================

cat("\nMerging outcome summary and Cox regression tables...\n")

tbl_combined_outcomes <-
  tbl_merge(
    tbls = list(tbl_outcomes_summary, tbl_cox_stacked),
    tab_spanner = c(
      "**Frequencies**",
      "**Crude Weighted Cox analysis**"
    )
  )

# Preview
tbl_combined_outcomes

# ============================================================================
# 4. Export to Word
# ============================================================================

ft_outcomes_combined <-
  tbl_combined_outcomes %>%
  as_flex_table() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  autofit()

doc_outcomes <-
  read_docx() %>%
  body_add_par("Table 3: Frequencies and Crude Weighted Cox analysis",
               style = "heading 1") %>%
  body_add_par(
    paste0(
      "Event counts by group and hazard ratios (HR) with 95% CI from IPTW-weighted Cox regression. ",
      "Reference: Control (Lupus = 0). ",
      "MACE = Major Adverse Cardiovascular Events."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_outcomes_combined)

print(doc_outcomes, target = "Table3_Outcomes_Summary_and_Cox.docx")

cat("✓ Combined outcome table saved: Table3_Outcomes_Summary_and_Cox.docx\n")
cat("✓ Chunk 13 complete\n")

```


```{r}
# ============================================================================
# CHUNK 14: Create 4-Panel WEIGHTED KM Plots with MACE
# ============================================================================

cat("\n=== CHUNK 14: Creating 4-panel WEIGHTED KM plots ===\n\n")

library(survival)
library(survminer)
library(gridExtra)
library(grid)
library(ggsci)

# ============================================================================
# Create 4-Panel WEIGHTED KM Plot
# ============================================================================

cat("Creating updated 4-panel WEIGHTED KM plot with MACE...\n\n")

# CKD - Weighted
surv_ckd_weighted <- survfit(Surv(ckd_followup_years, ckd_status) ~ lupus_factor,
                              data = cohort_surv,
                              weights = iptw)

km1 <- ggsurvplot(
  surv_ckd_weighted,
  data = cohort_surv,
  risk.table = FALSE,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "CKD-free survival",
  title = "A. Chronic Kidney Disease",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = pal_jama("default")(2),
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9)
)

# Print individual plot
print(km1)

# ESKD - Weighted
surv_eskd_weighted <- survfit(Surv(eskd_followup_years, eskd_status) ~ lupus_factor,
                               data = cohort_surv,
                               weights = iptw)

km2 <- ggsurvplot(
  surv_eskd_weighted,
  data = cohort_surv,
  risk.table = FALSE,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "ESKD-free survival",
  title = "B. End-Stage Kidney Disease",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = pal_jama("default")(2),
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9)
)

# Print individual plot
print(km2)

# MACE - Weighted
surv_mace_weighted <- survfit(Surv(cvd_followup_years, cvd_status) ~ lupus_factor,
                              data = cohort_surv,
                              weights = iptw)

km3 <- ggsurvplot(
  surv_mace_weighted,
  data = cohort_surv,
  risk.table = FALSE,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "MACE-free survival",
  title = "C. Major Adverse Cardiovascular Events",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = pal_jama("default")(2),
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9)
)

# Print individual plot
print(km3)

# Death - Weighted
surv_death_weighted <- survfit(Surv(death_followup_years, death_status) ~ lupus_factor,
                                data = cohort_surv,
                                weights = iptw)

km4 <- ggsurvplot(
  surv_death_weighted,
  data = cohort_surv,
  risk.table = FALSE,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "Overall survival",
  title = "D. All-Cause Mortality",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = pal_jama("default")(2),
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9)
)

# Print individual plot
print(km4)

# ============================================================================
# Combine into 4-panel plot
# ============================================================================

cat("\nCombining into 4-panel plot...\n")

# Arrange plots in 2x2 grid
combined_km <- arrange_ggsurvplots(
  list(km1, km2, km3, km4),
  nrow = 2,
  ncol = 2,
  print = FALSE
)

# Print combined plot
print(combined_km)

# Save combined plot
ggsave("KM_Curves_4Panel_IPTW_Weighted_MACE.pdf", 
       plot = combined_km, 
       width = 12, 
       height = 10, 
       bg = "white")

cat("✓ 4-panel WEIGHTED KM plot saved: KM_Curves_4Panel_IPTW_Weighted_MACE.pdf\n\n")

cat("✓ Chunk 14 complete\n")
```



#subgroup analysis
##prepare data for drugs before CKD outcome. 
```{r}

SGLT2_FIRST_99=read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47617][SGLT-2_FIRST_99][v-itamar][qe_24336][20251223_211721687_2361].csv",  locale = locale(encoding = "UTF-8"))

SGLT2_FIRST_99 <- fix_cols(SGLT2_FIRST_99)


ARB_FIRST_99=read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47617][ARBS_FIRST_99][v-itamar][qe_24336][20251223_211721696_4416].csv",  locale = locale(encoding = "UTF-8"))

ARB_FIRST_99 <- fix_cols(ARB_FIRST_99)

ACE_FIRST_99=read_csv("//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47617][ACE_FIRST_99][v-itamar][qe_24336][20251223_211721691_7669].csv",  locale = locale(encoding = "UTF-8"))

ACE_FIRST_99 <- fix_cols(ACE_FIRST_99)

colnames(ACE_FIRST_99)
colnames(ARB_FIRST_99)

colnames(SGLT2_FIRST_99)

```



# CHUNK 15D-REVISED: Time-Varying Drug Exposure with ACTUAL QUARTILES

```{r}
# ============================================================================
# CHUNK 15D-COMPLETE: Time-Varying Drug Exposure Analysis
# Binary + Dose-Response Models for Prednisone and Hydroxychloroquine
# ============================================================================

cat("\n=== CHUNK 15D-COMPLETE: Time-Varying Drug Analysis ===\n\n")

library(survival)
library(dplyr)
library(tidyr)
library(readr)
library(flextable)
library(officer)

# ============================================================================
# STEP 1: Verify required data exists
# ============================================================================

if (!exists("cohort_surv")) {
  stop("Error: cohort_surv not found. Run previous chunks first.")
}

if (!file.exists("drug_exposure_yearly_wide_2015_2023.csv")) {
  stop("Error: drug_exposure_yearly_wide_2015_2023.csv not found. Run drug imputation chunk first.")
}

# ============================================================================
# STEP 2: Load drug exposure data and prepare cohort
# ============================================================================

cat("Loading drug exposure data...\n")

drug_exposure_yearly <- read_csv("drug_exposure_yearly_wide_2015_2023.csv")

cat("✓ Loaded", nrow(drug_exposure_yearly), "patient-year records\n\n")

# Get nephritis patients to exclude
nephritis_patients <- lupus_original_file %>%
  filter(!is.na(naparitis) & naparitis == 1) %>%
  pull(patient_id)

# Prepare cohort (Lupus WITHOUT nephritis)
cohort_lupus_no_neph <- cohort_surv %>%
  filter(Lupus == 1) %>%
  filter(!(patient_id %in% nephritis_patients))

cat("Lupus patients WITHOUT nephritis: N =", nrow(cohort_lupus_no_neph), "\n")
cat("CKD events:", sum(cohort_lupus_no_neph$ckd_status == 1), "\n\n")

# ============================================================================
# STEP 3: Create time-varying dataset
# ============================================================================

cat("Creating time-varying dataset...\n")

time_varying_data <- cohort_lupus_no_neph %>%
  mutate(
    max_year = floor(ckd_followup_years),
    years_list = purrr::map(max_year, ~0:.x)
  ) %>%
  unnest(years_list) %>%
  rename(year_index = years_list) %>%
  mutate(
    tstart = year_index,
    tstop = year_index + 1,
    tstop = ifelse(tstop > ckd_followup_years, ckd_followup_years, tstop),
    event = ifelse(tstop >= ckd_followup_years & ckd_status == 1, 1, 0),
    calendar_year = lubridate::year(index_date) + year_index
  )

cat("✓ Created", nrow(time_varying_data), "person-year intervals\n\n")

# ============================================================================
# STEP 4: Merge drug exposure
# ============================================================================

cat("Merging drug exposure...\n")

time_varying_with_drugs <- time_varying_data %>%
  left_join(
    drug_exposure_yearly %>%
      dplyr::select(mdcinternalpatientid, year, 
                   prednisone_yearly_ddd, hydroxy_yearly_ddd),
    by = c("patient_id" = "mdcinternalpatientid", "calendar_year" = "year")
  ) %>%
  mutate(
    prednisone_yearly_ddd = replace_na(prednisone_yearly_ddd, 0),
    hydroxy_yearly_ddd = replace_na(hydroxy_yearly_ddd, 0),
    
    # Binary exposure (any vs none)
    prednisone_any = as.integer(prednisone_yearly_ddd > 0),
    hydroxy_any = as.integer(hydroxy_yearly_ddd > 0),
    
    # Gender numeric
    gender_numeric = ifelse(gender == "Female", 1, 0)
  )

cat("✓ Drug exposure merged\n\n")

cat("Exposure summary:\n")
cat("  Prednisone person-years:", sum(time_varying_with_drugs$prednisone_any), "\n")
cat("  Hydroxychloroquine person-years:", sum(time_varying_with_drugs$hydroxy_any), "\n\n")

# ============================================================================
# STEP 5: BINARY MODELS (Any vs None)
# ============================================================================

cat("=== Running Binary Models (Any vs None) ===\n\n")

# Model 1: Prednisone Binary
cat("--- Prednisone: Any vs None ---\n")

model_pred_binary <- coxph(
  Surv(tstart, tstop, event) ~ prednisone_any + 
    age_at_index + gender_numeric + diabetes_diagnosis + 
    hypertension_diagnosis + baseline_gfr + cluster(patient_id),
  data = time_varying_with_drugs,
  weights = iptw
)

summary_pred_binary <- summary(model_pred_binary)
coef_pred_binary <- summary_pred_binary$coefficients

hr_pred_binary <- exp(coef_pred_binary["prednisone_any", "coef"])
ci_lower_pred_binary <- exp(coef_pred_binary["prednisone_any", "coef"] - 
                            1.96 * coef_pred_binary["prednisone_any", "robust se"])
ci_upper_pred_binary <- exp(coef_pred_binary["prednisone_any", "coef"] + 
                            1.96 * coef_pred_binary["prednisone_any", "robust se"])
p_pred_binary <- coef_pred_binary["prednisone_any", "Pr(>|z|)"]

cat(sprintf("HR = %.2f (%.2f-%.2f), p = %s\n\n", 
            hr_pred_binary, ci_lower_pred_binary, ci_upper_pred_binary,
            ifelse(p_pred_binary < 0.001, "<0.001", sprintf("%.3f", p_pred_binary))))

# Model 2: Hydroxychloroquine Binary
cat("--- Hydroxychloroquine: Any vs None ---\n")

model_hydroxy_binary <- coxph(
  Surv(tstart, tstop, event) ~ hydroxy_any + 
    age_at_index + gender_numeric + diabetes_diagnosis + 
    hypertension_diagnosis + baseline_gfr + cluster(patient_id),
  data = time_varying_with_drugs,
  weights = iptw
)

summary_hydroxy_binary <- summary(model_hydroxy_binary)
coef_hydroxy_binary <- summary_hydroxy_binary$coefficients

hr_hydroxy_binary <- exp(coef_hydroxy_binary["hydroxy_any", "coef"])
ci_lower_hydroxy_binary <- exp(coef_hydroxy_binary["hydroxy_any", "coef"] - 
                               1.96 * coef_hydroxy_binary["hydroxy_any", "robust se"])
ci_upper_hydroxy_binary <- exp(coef_hydroxy_binary["hydroxy_any", "coef"] + 
                               1.96 * coef_hydroxy_binary["hydroxy_any", "robust se"])
p_hydroxy_binary <- coef_hydroxy_binary["hydroxy_any", "Pr(>|z|)"]

cat(sprintf("HR = %.2f (%.2f-%.2f), p = %s\n\n", 
            hr_hydroxy_binary, ci_lower_hydroxy_binary, ci_upper_hydroxy_binary,
            ifelse(p_hydroxy_binary < 0.001, "<0.001", sprintf("%.3f", p_hydroxy_binary))))

# ============================================================================
# STEP 6: DOSE-RESPONSE MODELS (Quartiles among users)
# ============================================================================

cat("=== Running Dose-Response Models (Quartiles) ===\n\n")

# Prednisone quartiles (USERS ONLY)
cat("--- Prednisone Quartiles ---\n")

pred_users <- time_varying_with_drugs %>%
  filter(prednisone_yearly_ddd > 0)

if (nrow(pred_users) >= 100) {
  
  pred_q <- quantile(pred_users$prednisone_yearly_ddd, 
                    probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
  
  cat("Quartile ranges:\n")
  print(pred_q)
  cat("\n")
  
  pred_users <- pred_users %>%
    mutate(
      prednisone_quartile = cut(prednisone_yearly_ddd,
                               breaks = pred_q,
                               labels = c("Q1", "Q2", "Q3", "Q4"),
                               include.lowest = TRUE),
      prednisone_q_users = factor(prednisone_quartile, levels = c("Q1", "Q2", "Q3", "Q4"))
    )
  
  model_pred_quartile_tv <- coxph(
    Surv(tstart, tstop, event) ~ prednisone_q_users + 
      age_at_index + gender_numeric + diabetes_diagnosis + 
      hypertension_diagnosis + baseline_gfr + cluster(patient_id),
    data = pred_users,
    weights = iptw
  )
  
  print(summary(model_pred_quartile_tv))
  cat("\n")
  
  # Linear trend test
  pred_users_trend <- pred_users %>%
    mutate(pred_dose_100 = prednisone_yearly_ddd / 100)
  
  model_pred_trend <- coxph(
    Surv(tstart, tstop, event) ~ pred_dose_100 + 
      age_at_index + gender_numeric + diabetes_diagnosis + 
      hypertension_diagnosis + baseline_gfr + cluster(patient_id),
    data = pred_users_trend,
    weights = iptw
  )
  
  coef_trend <- summary(model_pred_trend)$coefficients
  hr_trend <- exp(coef_trend["pred_dose_100", "coef"])
  p_trend <- coef_trend["pred_dose_100", "Pr(>|z|)"]
  
  cat(sprintf("Linear trend: HR = %.2f per 100 DDD, p = %.3f\n\n", hr_trend, p_trend))
  
} else {
  cat("Insufficient prednisone users for quartile analysis\n\n")
  model_pred_quartile_tv <- NULL
}

# Hydroxychloroquine quartiles (USERS ONLY)
cat("--- Hydroxychloroquine Quartiles ---\n")

hydroxy_users <- time_varying_with_drugs %>%
  filter(hydroxy_yearly_ddd > 0)

if (nrow(hydroxy_users) >= 100) {
  
  hydroxy_q <- quantile(hydroxy_users$hydroxy_yearly_ddd,
                       probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
  
  cat("Quartile ranges:\n")
  print(hydroxy_q)
  cat("\n")
  
  hydroxy_users <- hydroxy_users %>%
    mutate(
      hydroxy_quartile = cut(hydroxy_yearly_ddd,
                            breaks = hydroxy_q,
                            labels = c("Q1", "Q2", "Q3", "Q4"),
                            include.lowest = TRUE),
      hydroxy_q_users = factor(hydroxy_quartile, levels = c("Q1", "Q2", "Q3", "Q4"))
    )
  
  model_hydroxy_quartile_tv <- coxph(
    Surv(tstart, tstop, event) ~ hydroxy_q_users + 
      age_at_index + gender_numeric + diabetes_diagnosis + 
      hypertension_diagnosis + baseline_gfr + cluster(patient_id),
    data = hydroxy_users,
    weights = iptw
  )
  
  print(summary(model_hydroxy_quartile_tv))
  cat("\n")
  
  # Linear trend test
  hydroxy_users_trend <- hydroxy_users %>%
    mutate(hydroxy_dose_100 = hydroxy_yearly_ddd / 100)
  
  model_hydroxy_trend <- coxph(
    Surv(tstart, tstop, event) ~ hydroxy_dose_100 + 
      age_at_index + gender_numeric + diabetes_diagnosis + 
      hypertension_diagnosis + baseline_gfr + cluster(patient_id),
    data = hydroxy_users_trend,
    weights = iptw
  )
  
  coef_trend_h <- summary(model_hydroxy_trend)$coefficients
  hr_trend_h <- exp(coef_trend_h["hydroxy_dose_100", "coef"])
  p_trend_h <- coef_trend_h["hydroxy_dose_100", "Pr(>|z|)"]
  
  cat(sprintf("Linear trend: HR = %.2f per 100 DDD, p = %.3f\n\n", hr_trend_h, p_trend_h))
  
} else {
  cat("Insufficient hydroxychloroquine users for quartile analysis\n\n")
  model_hydroxy_quartile_tv <- NULL
}

# ============================================================================
# STEP 7: Create Summary Tables
# ============================================================================

cat("\n=== Creating Manuscript-Ready Summary Tables ===\n\n")

# Table 1: Binary Models
binary_results <- data.frame(
  Medication = c("Prednisone", "Hydroxychloroquine"),
  Person_Years_Exposed = c(
    sum(time_varying_with_drugs$prednisone_any == 1),
    sum(time_varying_with_drugs$hydroxy_any == 1)
  ),
  Person_Years_Unexposed = c(
    sum(time_varying_with_drugs$prednisone_any == 0),
    sum(time_varying_with_drugs$hydroxy_any == 0)
  ),
  Events_Exposed = c(
    sum(time_varying_with_drugs$event[time_varying_with_drugs$prednisone_any == 1]),
    sum(time_varying_with_drugs$event[time_varying_with_drugs$hydroxy_any == 1])
  ),
  Events_Unexposed = c(
    sum(time_varying_with_drugs$event[time_varying_with_drugs$prednisone_any == 0]),
    sum(time_varying_with_drugs$event[time_varying_with_drugs$hydroxy_any == 0])
  ),
  HR = c(hr_pred_binary, hr_hydroxy_binary),
  CI_lower = c(ci_lower_pred_binary, ci_lower_hydroxy_binary),
  CI_upper = c(ci_upper_pred_binary, ci_upper_hydroxy_binary),
  P_value = c(p_pred_binary, p_hydroxy_binary),
  stringsAsFactors = FALSE
) %>%
  mutate(
    HR_CI = sprintf("%.2f (%.2f-%.2f)", HR, CI_lower, CI_upper),
    P_fmt = ifelse(P_value < 0.001, "<0.001", sprintf("%.3f", P_value)),
    Interpretation = ifelse(HR < 1 & P_value < 0.05, "Protective",
                            ifelse(HR > 1 & P_value < 0.05, "Harmful",
                                   "No significant effect"))
  )

print(binary_results %>% dplyr::select(Medication, Person_Years_Exposed, HR_CI, P_fmt, Interpretation))

# Table 2: Prednisone Dose-Response
if (!is.null(model_pred_quartile_tv)) {
  pred_quartile_results <- data.frame(
    Quartile = c("Q1 [ref]", "Q2", "Q3", "Q4"),
    Range_DDD = c(
      sprintf("%.0f-%.0f", pred_q[1], pred_q[2]),
      sprintf("%.0f-%.0f", pred_q[2], pred_q[3]),
      sprintf("%.0f-%.0f", pred_q[3], pred_q[4]),
      sprintf("%.0f-%.0f", pred_q[4], pred_q[5])
    ),
    HR = c(1.00, NA, NA, NA),
    CI_lower = c(NA, NA, NA, NA),
    CI_upper = c(NA, NA, NA, NA),
    P_value = c(NA, NA, NA, NA)
  )
  
  coef_pred_q <- summary(model_pred_quartile_tv)$coefficients
  
  for (i in 2:4) {
    var_name <- paste0("prednisone_q_usersQ", i)
    if (var_name %in% rownames(coef_pred_q)) {
      pred_quartile_results$HR[i] <- exp(coef_pred_q[var_name, "coef"])
      pred_quartile_results$CI_lower[i] <- exp(coef_pred_q[var_name, "coef"] - 
                                              1.96 * coef_pred_q[var_name, "robust se"])
      pred_quartile_results$CI_upper[i] <- exp(coef_pred_q[var_name, "coef"] + 
                                              1.96 * coef_pred_q[var_name, "robust se"])
      pred_quartile_results$P_value[i] <- coef_pred_q[var_name, "Pr(>|z|)"]
    }
  }
  
  pred_quartile_results <- pred_quartile_results %>%
    mutate(
      HR_CI = ifelse(is.na(HR) | Quartile == "Q1 [ref]", "1.00 [ref]",
                     sprintf("%.2f (%.2f-%.2f)", HR, CI_lower, CI_upper)),
      P_fmt = ifelse(is.na(P_value), "-",
                     ifelse(P_value < 0.001, "<0.001", sprintf("%.3f", P_value)))
    )
  
  print(pred_quartile_results %>% dplyr::select(Quartile, Range_DDD, HR_CI, P_fmt))
}

# Table 3: Hydroxychloroquine Dose-Response
if (!is.null(model_hydroxy_quartile_tv)) {
  hydroxy_quartile_results <- data.frame(
    Quartile = c("Q1 [ref]", "Q2", "Q3", "Q4"),
    Range_DDD = c(
      sprintf("%.0f-%.0f", hydroxy_q[1], hydroxy_q[2]),
      sprintf("%.0f-%.0f", hydroxy_q[2], hydroxy_q[3]),
      sprintf("%.0f-%.0f", hydroxy_q[3], hydroxy_q[4]),
      sprintf("%.0f-%.0f", hydroxy_q[4], hydroxy_q[5])
    ),
    HR = c(1.00, NA, NA, NA),
    CI_lower = c(NA, NA, NA, NA),
    CI_upper = c(NA, NA, NA, NA),
    P_value = c(NA, NA, NA, NA)
  )
  
  coef_hydroxy_q <- summary(model_hydroxy_quartile_tv)$coefficients
  
  for (i in 2:4) {
    var_name <- paste0("hydroxy_q_usersQ", i)
    if (var_name %in% rownames(coef_hydroxy_q)) {
      hydroxy_quartile_results$HR[i] <- exp(coef_hydroxy_q[var_name, "coef"])
      hydroxy_quartile_results$CI_lower[i] <- exp(coef_hydroxy_q[var_name, "coef"] - 
                                                  1.96 * coef_hydroxy_q[var_name, "robust se"])
      hydroxy_quartile_results$CI_upper[i] <- exp(coef_hydroxy_q[var_name, "coef"] + 
                                                  1.96 * coef_hydroxy_q[var_name, "robust se"])
      hydroxy_quartile_results$P_value[i] <- coef_hydroxy_q[var_name, "Pr(>|z|)"]
    }
  }
  
  hydroxy_quartile_results <- hydroxy_quartile_results %>%
    mutate(
      HR_CI = ifelse(is.na(HR) | Quartile == "Q1 [ref]", "1.00 [ref]",
                     sprintf("%.2f (%.2f-%.2f)", HR, CI_lower, CI_upper)),
      P_fmt = ifelse(is.na(P_value), "-",
                     ifelse(P_value < 0.001, "<0.001", sprintf("%.3f", P_value)))
    )
  
  print(hydroxy_quartile_results %>% dplyr::select(Quartile, Range_DDD, HR_CI, P_fmt))
}

# ============================================================================
# STEP 8: Export to Word
# ============================================================================

cat("\n=== Creating Word Document ===\n")

# Create flextables
ft_binary <- binary_results %>%
  dplyr::select(Medication, Person_Years_Exposed, Person_Years_Unexposed, 
               Events_Exposed, Events_Unexposed, HR_CI, P_fmt) %>%
  flextable() %>%
  set_header_labels(
    Medication = "Medication",
    Person_Years_Exposed = "PY Exposed",
    Person_Years_Unexposed = "PY Unexposed",
    Events_Exposed = "Events\nExposed",
    Events_Unexposed = "Events\nUnexposed",
    HR_CI = "HR (95% CI)",
    P_fmt = "P-value"
  ) %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  autofit()

doc <- read_docx() %>%
  body_add_par("Time-Varying Drug Exposure Analysis and CKD Risk", style = "heading 1") %>%
  body_add_par("Lupus Patients without Nephritis", style = "heading 2") %>%
  body_add_par("", style = "Normal") %>%
  body_add_par("Methods", style = "heading 2") %>%
  body_add_par(paste0(
    "Time-varying Cox proportional hazards models with counting process format. ",
    "Drug exposure updated yearly. Models adjusted for age, sex, diabetes, ",
    "hypertension, and baseline GFR. Inverse probability of treatment weighting (IPTW) applied. ",
    "Clustered standard errors by patient ID."
  ), style = "Normal") %>%
  body_add_par("", style = "Normal") %>%
  body_add_par("Table 1. Binary Exposure Models (Any vs None)", style = "heading 2") %>%
  body_add_flextable(ft_binary) %>%
  body_add_par("", style = "Normal")

# Add dose-response tables if they exist
if (!is.null(model_pred_quartile_tv)) {
  ft_pred <- pred_quartile_results %>%
    dplyr::select(Quartile, Range_DDD, HR_CI, P_fmt) %>%
    flextable() %>%
    set_header_labels(
      Quartile = "Quartile",
      Range_DDD = "Range (DDD/year)",
      HR_CI = "HR (95% CI)",
      P_fmt = "P-value"
    ) %>%
    fontsize(size = 10, part = "all") %>%
    bold(part = "header") %>%
    align(align = "center", part = "all") %>%
    autofit()
  
  doc <- doc %>%
    body_add_par("Table 2. Prednisone Dose-Response (Among Users)", style = "heading 2") %>%
    body_add_par(sprintf("Test for linear trend: HR = %.2f per 100 DDD, p = %.3f", hr_trend, p_trend), style = "Normal") %>%
    body_add_flextable(ft_pred) %>%
    body_add_par("", style = "Normal")
}

if (!is.null(model_hydroxy_quartile_tv)) {
  ft_hydroxy <- hydroxy_quartile_results %>%
    dplyr::select(Quartile, Range_DDD, HR_CI, P_fmt) %>%
    flextable() %>%
    set_header_labels(
      Quartile = "Quartile",
      Range_DDD = "Range (DDD/year)",
      HR_CI = "HR (95% CI)",
      P_fmt = "P-value"
    ) %>%
    fontsize(size = 10, part = "all") %>%
    bold(part = "header") %>%
    align(align = "center", part = "all") %>%
    autofit()
  
  doc <- doc %>%
    body_add_par("Table 3. Hydroxychloroquine Dose-Response (Among Users)", style = "heading 2") %>%
    body_add_par(sprintf("Test for linear trend: HR = %.2f per 100 DDD, p = %.3f", hr_trend_h, p_trend_h), style = "Normal") %>%
    body_add_flextable(ft_hydroxy) %>%
    body_add_par("", style = "Normal")
}

print(doc, target = "Time_Varying_Drug_Analysis_Complete.docx")

cat("\n✓ CHUNK 15D-COMPLETE Finished!\n")
cat("✓ File saved: Time_Varying_Drug_Analysis_Complete.docx\n\n")
```

# CHUNK 15F
```{r}
# ============================================================================
# CHUNK 15F-COMPLETE-FIXED: RAAS/SGLT2 Inhibitor Analysis
# SET drug exposure to 0 for patients who received drug ONLY after CKD
# ============================================================================

cat("\n=== CHUNK 15F-COMPLETE-FIXED: RAAS/SGLT2 Inhibitor Analysis ===\n\n")

library(survival)
library(dplyr)
library(tidyr)
library(readr)
library(flextable)
library(officer)

# ============================================================================
# STEP 0: Verify required objects
# ============================================================================

if (!exists("cohort_surv")) {
  stop("Error: cohort_surv not found")
}

if (!exists("lupus_original_file")) {
  stop("Error: lupus_original_file not found")
}

if (!exists("fix_cols")) {
  stop("Error: fix_cols function not found")
}

# ============================================================================
# STEP 1: Load recurrent drug event data
# ============================================================================

cat("STEP 1: Loading recurrent drug event data...\n")

# Load SGLT2 inhibitors
SGLT2_FIRST_99 <- read_csv(
  "//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47617][SGLT-2_FIRST_99][v-itamar][qe_24336][20251223_211721687_2361].csv", 
  locale = locale(encoding = "UTF-8")
)
SGLT2_FIRST_99 <- fix_cols(SGLT2_FIRST_99)

# Load ARBs
ARB_FIRST_99 <- read_csv(
  "//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47617][ARBS_FIRST_99][v-itamar][qe_24336][20251223_211721696_4416].csv", 
  locale = locale(encoding = "UTF-8")
)
ARB_FIRST_99 <- fix_cols(ARB_FIRST_99)

# Load ACE inhibitors
ACE_FIRST_99 <- read_csv(
  "//10.100.117.220/Projects$/R02-Darom/R02-Itamar Ben Shitrit/Lupus CKD/data/drug data before ckd event/[47617][ACE_FIRST_99][v-itamar][qe_24336][20251223_211721691_7669].csv", 
  locale = locale(encoding = "UTF-8")
)
ACE_FIRST_99 <- fix_cols(ACE_FIRST_99)

cat("✓ Data loaded successfully\n\n")

# Standardize column names
ACE_FIRST_99 <- ACE_FIRST_99 %>%
  rename(
    patient_id = ace_first_99_patient_id,
    date_dispensed = ace_first_99_date_dispensed
  ) %>%
  mutate(drug_class = "ACE")

ARB_FIRST_99 <- ARB_FIRST_99 %>%
  rename(
    patient_id = arbs_first_99_patient_id,
    date_dispensed = arbs_first_99_date_dispensed
  ) %>%
  mutate(drug_class = "ARB")

SGLT2_FIRST_99 <- SGLT2_FIRST_99 %>%
  rename(
    patient_id = sglt_2_first_99_patient_id,
    date_dispensed = sglt_2_first_99_date_dispensed
  ) %>%
  mutate(drug_class = "SGLT2")

cat("Drug dispensing events:\n")
cat("  ACE inhibitors:", nrow(ACE_FIRST_99), "events,", 
    n_distinct(ACE_FIRST_99$patient_id), "unique patients\n")
cat("  ARBs:", nrow(ARB_FIRST_99), "events,", 
    n_distinct(ARB_FIRST_99$patient_id), "unique patients\n")
cat("  SGLT2 inhibitors:", nrow(SGLT2_FIRST_99), "events,", 
    n_distinct(SGLT2_FIRST_99$patient_id), "unique patients\n\n")

# ============================================================================
# STEP 2: Get CKD diagnosis dates from cohort
# ============================================================================

cat("STEP 2: Preparing cohort...\n")

# Get nephritis status
nephritis_patients <- lupus_original_file %>%
  filter(!is.na(naparitis) & naparitis == 1) %>%
  pull(patient_id)

cat("Nephritis patients identified:", length(nephritis_patients), "\n")

# Prepare cohort (Lupus WITHOUT nephritis)
cohort_lupus_no_neph <- cohort_surv %>%
  filter(Lupus == 1) %>%
  filter(!(patient_id %in% nephritis_patients)) %>%
  dplyr::select(patient_id, index_date, ckd_status, ckd_date, 
               ckd_followup_years, age_at_index, gender,
               diabetes_diagnosis, hypertension_diagnosis, 
               baseline_gfr, iptw) %>%
  mutate(
    ckd_diagnosis_date = if_else(ckd_status == 1, ckd_date, as.Date(NA)),
    end_followup_date = index_date + ckd_followup_years * 365.25
  )

cat("Lupus patients WITHOUT nephritis: N =", nrow(cohort_lupus_no_neph), "\n")
cat("CKD events: N =", sum(cohort_lupus_no_neph$ckd_status == 1), "\n\n")

# ============================================================================
# STEP 3: Identify patients with drug ONLY after CKD - WITH ERROR HANDLING
# ============================================================================

cat("STEP 3: Identifying patients with drug ONLY after CKD...\n\n")

# Function to identify patients who got drug ONLY after CKD
identify_post_ckd_only <- function(drug_events, cohort_data, drug_name) {
  
  cat("  Processing", drug_name, "...\n")
  
  # Merge drug events with cohort to get CKD dates
  drug_with_ckd <- drug_events %>%
    inner_join(
      cohort_data %>% dplyr::select(patient_id, index_date, ckd_diagnosis_date),
      by = "patient_id"
    ) %>%
    mutate(
      before_ckd = is.na(ckd_diagnosis_date) | date_dispensed < ckd_diagnosis_date,
      after_ckd = !is.na(ckd_diagnosis_date) & date_dispensed >= ckd_diagnosis_date
    )
  
  # For each patient, check if they have ANY dispensing BEFORE CKD
  patient_drug_timing <- drug_with_ckd %>%
    group_by(patient_id) %>%
    summarise(
      n_total = n(),
      n_before_ckd = sum(before_ckd, na.rm = TRUE),
      n_after_ckd = sum(after_ckd, na.rm = TRUE),
      first_drug_date = min(date_dispensed, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      only_after_ckd = n_before_ckd == 0 & n_after_ckd > 0
    )
  
  n_only_after <- sum(patient_drug_timing$only_after_ckd)
  n_before_or_no_ckd <- sum(!patient_drug_timing$only_after_ckd)
  
  cat("    Total", drug_name, "users:", nrow(patient_drug_timing), "\n")
  cat("    Drug ONLY after CKD (exposure set to 0):", n_only_after, "\n")
  cat("    Drug before or without CKD (exposure kept):", n_before_or_no_ckd, "\n")
  
  # Return patients to zero out
  patients_to_zero <- patient_drug_timing %>%
    filter(only_after_ckd) %>%
    pull(patient_id)
  
  cat("    Returning vector of length:", length(patients_to_zero), "\n\n")
  
  return(patients_to_zero)
}

# Get lists of patients to zero out for each drug - ASSIGN TO GLOBAL ENVIRONMENT
zero_out_ace <- identify_post_ckd_only(ACE_FIRST_99, cohort_lupus_no_neph, "ACE inhibitors")
zero_out_arb <- identify_post_ckd_only(ARB_FIRST_99, cohort_lupus_no_neph, "ARBs")
zero_out_sglt2 <- identify_post_ckd_only(SGLT2_FIRST_99, cohort_lupus_no_neph, "SGLT2 inhibitors")

# VERIFY THEY EXIST
cat("Verification:\n")
cat("  zero_out_ace length:", length(zero_out_ace), "\n")
cat("  zero_out_arb length:", length(zero_out_arb), "\n")
cat("  zero_out_sglt2 length:", length(zero_out_sglt2), "\n\n")

# ============================================================================
# STEP 4: Create time-varying exposure dataset
# ============================================================================

cat("STEP 4: Creating time-varying dataset...\n")

time_varying_data <- cohort_lupus_no_neph %>%
  mutate(
    max_year = floor(ckd_followup_years),
    years_list = purrr::map(max_year, ~0:.x)
  ) %>%
  unnest(years_list) %>%
  rename(year_index = years_list) %>%
  mutate(
    tstart = year_index,
    tstop = year_index + 1,
    tstop = ifelse(tstop > ckd_followup_years, ckd_followup_years, tstop),
    event = ifelse(tstop >= ckd_followup_years & ckd_status == 1, 1, 0),
    interval_start_date = index_date + tstart * 365.25,
    interval_end_date = index_date + tstop * 365.25
  )

cat("✓ Created", nrow(time_varying_data), "person-year intervals\n\n")

# ============================================================================
# STEP 5: Merge drug exposure - COMPLETELY REWRITTEN
# ============================================================================

cat("STEP 5: Merging drug exposure...\n")

# Simpler approach - process each drug separately without complex function
base_data <- time_varying_data %>%
  dplyr::select(patient_id, tstart, tstop, event, 
               interval_start_date, interval_end_date,
               age_at_index, gender, diabetes_diagnosis, 
               hypertension_diagnosis, baseline_gfr, iptw)

# --- ACE EXPOSURE ---
cat("  Processing ACE exposure...\n")

ace_exposure_calc <- base_data %>%
  dplyr::select(patient_id, tstart, tstop, interval_start_date, interval_end_date) %>%
  left_join(
    ACE_FIRST_99 %>% dplyr::select(patient_id, date_dispensed) %>% distinct(),
    by = "patient_id",
    relationship = "many-to-many"
  ) %>%
  mutate(
    drug_active = !is.na(date_dispensed) & 
                  date_dispensed >= interval_start_date & 
                  date_dispensed < interval_end_date
  ) %>%
  group_by(patient_id, tstart, tstop) %>%
  summarise(
    ace_exposure_raw = as.integer(any(drug_active, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  mutate(
    ace_exposure_raw = replace_na(ace_exposure_raw, 0),
    ace_exposure = ifelse(patient_id %in% zero_out_ace, 0, ace_exposure_raw)
  ) %>%
  dplyr::select(patient_id, tstart, tstop, ace_exposure)

base_data <- base_data %>%
  left_join(ace_exposure_calc, by = c("patient_id", "tstart", "tstop"))

cat("    ✓ ACE exposure added\n")

# --- ARB EXPOSURE ---
cat("  Processing ARB exposure...\n")

arb_exposure_calc <- base_data %>%
  dplyr::select(patient_id, tstart, tstop, interval_start_date, interval_end_date) %>%
  left_join(
    ARB_FIRST_99 %>% dplyr::select(patient_id, date_dispensed) %>% distinct(),
    by = "patient_id",
    relationship = "many-to-many"
  ) %>%
  mutate(
    drug_active = !is.na(date_dispensed) & 
                  date_dispensed >= interval_start_date & 
                  date_dispensed < interval_end_date
  ) %>%
  group_by(patient_id, tstart, tstop) %>%
  summarise(
    arb_exposure_raw = as.integer(any(drug_active, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  mutate(
    arb_exposure_raw = replace_na(arb_exposure_raw, 0),
    arb_exposure = ifelse(patient_id %in% zero_out_arb, 0, arb_exposure_raw)
  ) %>%
  dplyr::select(patient_id, tstart, tstop, arb_exposure)

base_data <- base_data %>%
  left_join(arb_exposure_calc, by = c("patient_id", "tstart", "tstop"))

cat("    ✓ ARB exposure added\n")

# --- SGLT2 EXPOSURE ---
cat("  Processing SGLT2 exposure...\n")

sglt2_exposure_calc <- base_data %>%
  dplyr::select(patient_id, tstart, tstop, interval_start_date, interval_end_date) %>%
  left_join(
    SGLT2_FIRST_99 %>% dplyr::select(patient_id, date_dispensed) %>% distinct(),
    by = "patient_id",
    relationship = "many-to-many"
  ) %>%
  mutate(
    drug_active = !is.na(date_dispensed) & 
                  date_dispensed >= interval_start_date & 
                  date_dispensed < interval_end_date
  ) %>%
  group_by(patient_id, tstart, tstop) %>%
  summarise(
    sglt2_exposure_raw = as.integer(any(drug_active, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  mutate(
    sglt2_exposure_raw = replace_na(sglt2_exposure_raw, 0),
    sglt2_exposure = ifelse(patient_id %in% zero_out_sglt2, 0, sglt2_exposure_raw)
  ) %>%
  dplyr::select(patient_id, tstart, tstop, sglt2_exposure)

time_varying_with_drugs <- base_data %>%
  left_join(sglt2_exposure_calc, by = c("patient_id", "tstart", "tstop")) %>%
  mutate(
    raas_exposure = pmax(ace_exposure, arb_exposure, na.rm = TRUE),
    gender_numeric = ifelse(gender == "Female", 1, 0)
  )

cat("    ✓ SGLT2 exposure added\n")
cat("✓ All drug exposures merged\n\n")

# Summary
cat("Person-year exposure summary (after excluding post-CKD only):\n")
cat("  ACE inhibitor person-years:", sum(time_varying_with_drugs$ace_exposure), "\n")
cat("  ARB person-years:", sum(time_varying_with_drugs$arb_exposure), "\n")
cat("  RAAS (ACE or ARB) person-years:", sum(time_varying_with_drugs$raas_exposure), "\n")
cat("  SGLT2 person-years:", sum(time_varying_with_drugs$sglt2_exposure), "\n\n")


# ============================================================================
# STEP 6: Time-varying Cox models
# ============================================================================

cat("=== Running Time-Varying Cox Models ===\n\n")

# Model 1: RAAS inhibitors (ACE or ARB combined)
cat("--- Model 1: RAAS Inhibitors (Any vs None, Time-Varying) ---\n")

model_raas <- coxph(
  Surv(tstart, tstop, event) ~ raas_exposure + 
    age_at_index + gender_numeric + diabetes_diagnosis + 
    hypertension_diagnosis + baseline_gfr + cluster(patient_id),
  data = time_varying_with_drugs,
  weights = iptw
)

summary_raas <- summary(model_raas)
coef_raas <- summary_raas$coefficients

hr_raas <- exp(coef_raas["raas_exposure", "coef"])
ci_lower_raas <- exp(coef_raas["raas_exposure", "coef"] - 
                     1.96 * coef_raas["raas_exposure", "robust se"])
ci_upper_raas <- exp(coef_raas["raas_exposure", "coef"] + 
                     1.96 * coef_raas["raas_exposure", "robust se"])
p_raas <- coef_raas["raas_exposure", "Pr(>|z|)"]

cat(sprintf("HR = %.2f (%.2f-%.2f), p = %s\n", 
            hr_raas, ci_lower_raas, ci_upper_raas,
            ifelse(p_raas < 0.001, "<0.001", sprintf("%.3f", p_raas))))

if (hr_raas < 1 & p_raas < 0.05) {
  cat("✓ PROTECTIVE: Reduces CKD risk by", sprintf("%.0f%%\n\n", (1 - hr_raas) * 100))
} else if (hr_raas > 1 & p_raas < 0.05) {
  cat("⚠️ HARMFUL: Increases CKD risk\n\n")
} else {
  cat("→ No significant effect\n\n")
}

# Model 2: ACE inhibitors separately
cat("--- Model 2: ACE Inhibitors (Any vs None, Time-Varying) ---\n")

model_ace <- coxph(
  Surv(tstart, tstop, event) ~ ace_exposure + 
    age_at_index + gender_numeric + diabetes_diagnosis + 
    hypertension_diagnosis + baseline_gfr + cluster(patient_id),
  data = time_varying_with_drugs,
  weights = iptw
)

summary_ace <- summary(model_ace)
coef_ace <- summary_ace$coefficients

hr_ace <- exp(coef_ace["ace_exposure", "coef"])
ci_lower_ace <- exp(coef_ace["ace_exposure", "coef"] - 
                    1.96 * coef_ace["ace_exposure", "robust se"])
ci_upper_ace <- exp(coef_ace["ace_exposure", "coef"] + 
                    1.96 * coef_ace["ace_exposure", "robust se"])
p_ace <- coef_ace["ace_exposure", "Pr(>|z|)"]

cat(sprintf("HR = %.2f (%.2f-%.2f), p = %s\n", 
            hr_ace, ci_lower_ace, ci_upper_ace,
            ifelse(p_ace < 0.001, "<0.001", sprintf("%.3f", p_ace))))

if (hr_ace < 1 & p_ace < 0.05) {
  cat("✓ PROTECTIVE\n\n")
} else if (hr_ace > 1 & p_ace < 0.05) {
  cat("⚠️ HARMFUL\n\n")
} else {
  cat("→ No significant effect\n\n")
}

# Model 3: ARBs separately
cat("--- Model 3: ARBs (Any vs None, Time-Varying) ---\n")

model_arb <- coxph(
  Surv(tstart, tstop, event) ~ arb_exposure + 
    age_at_index + gender_numeric + diabetes_diagnosis + 
    hypertension_diagnosis + baseline_gfr + cluster(patient_id),
  data = time_varying_with_drugs,
  weights = iptw
)

summary_arb <- summary(model_arb)
coef_arb <- summary_arb$coefficients

hr_arb <- exp(coef_arb["arb_exposure", "coef"])
ci_lower_arb <- exp(coef_arb["arb_exposure", "coef"] - 
                    1.96 * coef_arb["arb_exposure", "robust se"])
ci_upper_arb <- exp(coef_arb["arb_exposure", "coef"] + 
                    1.96 * coef_arb["arb_exposure", "robust se"])
p_arb <- coef_arb["arb_exposure", "Pr(>|z|)"]

cat(sprintf("HR = %.2f (%.2f-%.2f), p = %s\n", 
            hr_arb, ci_lower_arb, ci_upper_arb,
            ifelse(p_arb < 0.001, "<0.001", sprintf("%.3f", p_arb))))

if (hr_arb < 1 & p_arb < 0.05) {
  cat("✓ PROTECTIVE\n\n")
} else if (hr_arb > 1 & p_arb < 0.05) {
  cat("⚠️ HARMFUL\n\n")
} else {
  cat("→ No significant effect\n\n")
}

# Model 4: SGLT2 inhibitors
cat("--- Model 4: SGLT2 Inhibitors (Any vs None, Time-Varying) ---\n")

sglt2_n <- sum(time_varying_with_drugs$sglt2_exposure > 0)

if (sglt2_n >= 50) {
  model_sglt2 <- coxph(
    Surv(tstart, tstop, event) ~ sglt2_exposure + 
      age_at_index + gender_numeric + diabetes_diagnosis + 
      hypertension_diagnosis + baseline_gfr + cluster(patient_id),
    data = time_varying_with_drugs,
    weights = iptw
  )
  
  summary_sglt2 <- summary(model_sglt2)
  coef_sglt2 <- summary_sglt2$coefficients
  
  hr_sglt2 <- exp(coef_sglt2["sglt2_exposure", "coef"])
  ci_lower_sglt2 <- exp(coef_sglt2["sglt2_exposure", "coef"] - 
                        1.96 * coef_sglt2["sglt2_exposure", "robust se"])
  ci_upper_sglt2 <- exp(coef_sglt2["sglt2_exposure", "coef"] + 
                        1.96 * coef_sglt2["sglt2_exposure", "robust se"])
  p_sglt2 <- coef_sglt2["sglt2_exposure", "Pr(>|z|)"]
  
  cat(sprintf("HR = %.2f (%.2f-%.2f), p = %s\n", 
              hr_sglt2, ci_lower_sglt2, ci_upper_sglt2,
              ifelse(p_sglt2 < 0.001, "<0.001", sprintf("%.3f", p_sglt2))))
  
  if (hr_sglt2 < 1 & p_sglt2 < 0.05) {
    cat("✓ PROTECTIVE\n\n")
  } else if (hr_sglt2 > 1 & p_sglt2 < 0.05) {
    cat("⚠️ HARMFUL\n\n")
  } else {
    cat("→ No significant effect\n\n")
  }
} else {
  cat("Insufficient SGLT2 exposure (N =", sglt2_n, "person-years)\n")
  cat("Minimum required: 50 person-years\n\n")
  hr_sglt2 <- NA
  ci_lower_sglt2 <- NA
  ci_upper_sglt2 <- NA
  p_sglt2 <- NA
}

# ============================================================================
# STEP 7: Create summary table
# ============================================================================

cat("=== Creating Summary Table ===\n\n")

summary_table <- data.frame(
  Drug = c("RAAS Inhibitors (ACE/ARB)", "ACE Inhibitors", "ARBs", "SGLT2 Inhibitors"),
  Person_Years_Exposed = c(
    sum(time_varying_with_drugs$raas_exposure),
    sum(time_varying_with_drugs$ace_exposure),
    sum(time_varying_with_drugs$arb_exposure),
    sum(time_varying_with_drugs$sglt2_exposure)
  ),
  Patients_Zeroed_Out = c(
    length(unique(c(zero_out_ace, zero_out_arb))),
    length(zero_out_ace),
    length(zero_out_arb),
    length(zero_out_sglt2)
  ),
  HR = c(hr_raas, hr_ace, hr_arb, hr_sglt2),
  CI_lower = c(ci_lower_raas, ci_lower_ace, ci_lower_arb, ci_lower_sglt2),
  CI_upper = c(ci_upper_raas, ci_upper_ace, ci_upper_arb, ci_upper_sglt2),
  P_value = c(p_raas, p_ace, p_arb, p_sglt2)
) %>%
  mutate(
    HR_CI = ifelse(is.na(HR), "Insufficient data",
                   sprintf("%.2f (%.2f-%.2f)", HR, CI_lower, CI_upper)),
    P_fmt = ifelse(is.na(P_value), "—",
                   ifelse(P_value < 0.001, "<0.001", sprintf("%.3f", P_value))),
    Interpretation = case_when(
      is.na(HR) ~ "Insufficient data",
      HR < 1 & P_value < 0.05 ~ "Protective",
      HR > 1 & P_value < 0.05 ~ "Harmful",
      TRUE ~ "No significant effect"
    )
  )

print(summary_table %>% dplyr::select(Drug, Person_Years_Exposed, Patients_Zeroed_Out, HR_CI, P_fmt, Interpretation))

# Export to Word
ft <- summary_table %>%
  dplyr::select(Drug, Person_Years_Exposed, Patients_Zeroed_Out, HR_CI, P_fmt) %>%
  flextable() %>%
  set_header_labels(
    Drug = "Medication",
    Person_Years_Exposed = "Person-Years\nExposed",
    Patients_Zeroed_Out = "Patients Zeroed\n(Drug Only After CKD)",
    HR_CI = "HR (95% CI)",
    P_fmt = "P-value"
  ) %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  autofit()

doc <- read_docx() %>%
  body_add_par("RAAS/SGLT2 Inhibitor Time-Varying Analysis", style = "heading 1") %>%
  body_add_par("Cohort: Lupus patients WITHOUT nephritis", style = "Normal") %>%
  body_add_par("", style = "Normal") %>%
  body_add_par("Methods: Time-varying Cox proportional hazards models with counting process format. Drug exposure updated yearly based on dispensing events. Patients who received drug ONLY after CKD diagnosis had their exposure set to 0 (representing treatment for CKD rather than prevention).", 
               style = "Normal") %>%
  body_add_par("", style = "Normal") %>%
  body_add_par(paste0("Models adjusted for: age, sex, diabetes, hypertension, baseline GFR. Inverse probability of treatment weighting (IPTW) applied. Clustered standard errors by patient ID. N = ", nrow(cohort_lupus_no_neph), " patients, ", sum(cohort_lupus_no_neph$ckd_status == 1), " CKD events."),
               style = "Normal") %>%
  body_add_par("", style = "Normal") %>%
  body_add_flextable(ft)

print(doc, target = "RAAS_SGLT2_Time_Varying_Analysis.docx")

cat("\n", rep("=", 80), "\n", sep = "")
cat("✓ CHUNK 15F-COMPLETE Finished!\n")
cat(rep("=", 80), "\n\n", sep = "")

cat("Output file: RAAS_SGLT2_Time_Varying_Analysis.docx\n\n")

cat("Summary:\n")
cat("  - Patients remain in cohort\n")
cat("  - Drug exposure set to 0 if received ONLY after CKD diagnosis\n")
cat("  - Time-varying analysis accounts for when drug was actually taken\n")
cat("  - IPTW weighting maintains balance\n")
```




# CHUNK 15E
```{r}
# ============================================================================
# CHUNK 15E-COMPLETE: Subgroup Analysis with Drug Quartiles
# Creates 3 forest plots:
#   1. All Lupus vs Control
#   2. Lupus (No Nephritis) vs Control
#   4. Lupus With Nephritis vs Without Nephritis
# ============================================================================

cat("\n=== CHUNK 15E-COMPLETE: Subgroup Analysis ===\n\n")

library(survival)
library(survey)
library(ggplot2)
library(dplyr)
library(tidyr)
library(grid)
library(readr)

# ============================================================================
# STEP 0: Load drug exposure data
# ============================================================================

cat("Loading drug exposure data...\n")

drug_exposure_cumulative <- read_csv("drug_exposure_cumulative_2015_2023.csv")

cat("✓ Drug exposure data loaded: N =", nrow(drug_exposure_cumulative), "\n\n")

# ============================================================================
# STEP 1: Create FOUR cohorts
# ============================================================================

cat("Creating cohorts...\n")

# Get nephritis status
nephritis_patients <- lupus_original_file %>%
  filter(!is.na(naparitis) & naparitis == 1) %>%
  pull(patient_id)

cat("Nephritis patients identified:", length(nephritis_patients), "\n")

# Cohort 1: ALL Lupus
cohort_all_lupus <- cohort_surv %>%
  filter(Lupus == 1)

# Cohort 2: Lupus WITHOUT nephritis
cohort_lupus_no_neph <- cohort_surv %>%
  filter(Lupus == 1) %>%
  filter(!(patient_id %in% nephritis_patients))

# Cohort 3: Lupus WITH nephritis
cohort_lupus_with_neph <- cohort_surv %>%
  filter(Lupus == 1) %>%
  filter(patient_id %in% nephritis_patients)

# Cohort 4: Control
cohort_control <- cohort_surv %>%
  filter(Lupus == 0)

cat("All Lupus:", nrow(cohort_all_lupus), "patients\n")
cat("Lupus WITHOUT nephritis:", nrow(cohort_lupus_no_neph), "patients\n")
cat("Lupus WITH nephritis:", nrow(cohort_lupus_with_neph), "patients\n")
cat("Control:", nrow(cohort_control), "patients\n\n")

# ============================================================================
# STEP 2: Function to create subgroup variables
# ============================================================================

create_subgroup_vars <- function(cohort_data, drug_data) {
  cohort_data %>%
    left_join(drug_data, by = c("patient_id" = "mdcinternalpatientid")) %>%
    mutate(
      total_prednisone_ddd = replace_na(total_prednisone_ddd, 0),
      total_hydroxy_ddd = replace_na(total_hydroxy_ddd, 0),
      
      gender_factor = factor(gender, levels = c("Male", "Female")),
      
      age_cat = case_when(
        age_at_index < 40 ~ "<40 years",
        age_at_index < 60 ~ "40–59 years",
        TRUE ~ "≥60 years"
      ),
      age_cat = factor(age_cat, levels = c("<40 years", "40–59 years", "≥60 years")),
      
      ses_category = factor(
        socioeconomic_score_three_level_scale,
        levels = c("Low", "Medium", "High")
      ),
      
      bmi_value = dplyr::coalesce(bmi_first_hospital_bmi_numeric, bmi_first_community_bmi),
      bmi_cat = case_when(
        is.na(bmi_value) ~ NA_character_,
        bmi_value < 30 ~ "<30",
        bmi_value >= 30 ~ "≥30"
      ),
      bmi_cat = factor(bmi_cat, levels = c("<30", "≥30")),
      
      ihd_factor = factor(
        ifelse(ischemic_heart_disease_diagnosis == 1, "Yes", "No"),
        levels = c("No", "Yes")
      ),
      
      diabetes_factor = factor(
        ifelse(diabetes_diagnosis == 1, "Yes", "No"),
        levels = c("No", "Yes")
      ),
      
      biologics_treatment = ifelse(
        rituximab_medication == 1 | belimumab_medication == 1, 1, 0
      ),
      biologics_factor = factor(
        ifelse(biologics_treatment == 1, "Yes", "No"),
        levels = c("No", "Yes")
      ),
      
      raas_inhibitors = ifelse(
        ace_medication == 1 | arbs_medication == 1, 1, 0
      ),
      raas_factor = factor(
        ifelse(raas_inhibitors == 1, "Yes", "No"),
        levels = c("No", "Yes")
      ),
      
      sglt2_factor = factor(
        ifelse(sglt_2_medication == 1, "Yes", "No"),
        levels = c("No", "Yes")
      )
    )
}

# Apply to all cohorts
cohort_all_lupus <- create_subgroup_vars(cohort_all_lupus, drug_exposure_cumulative)
cohort_lupus_no_neph <- create_subgroup_vars(cohort_lupus_no_neph, drug_exposure_cumulative)
cohort_lupus_with_neph <- create_subgroup_vars(cohort_lupus_with_neph, drug_exposure_cumulative)
cohort_control <- create_subgroup_vars(cohort_control, drug_exposure_cumulative)

cat("✓ Subgroup variables created\n\n")

# ============================================================================
# STEP 3: Function to calculate drug quartiles
# ============================================================================

calculate_quartiles <- function(cohort_data, cohort_name) {
  
  cat("Calculating quartiles for", cohort_name, "\n")
  
  pred_users <- cohort_data %>% filter(total_prednisone_ddd > 0)
  
  has_pred <- FALSE
  if (nrow(pred_users) >= 40) {
    pred_q <- quantile(pred_users$total_prednisone_ddd, 
                      probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
    
    cohort_data <- cohort_data %>%
      mutate(
        prednisone_quartile = case_when(
          total_prednisone_ddd == 0 ~ "None",
          total_prednisone_ddd <= pred_q[2] ~ "Q1",
          total_prednisone_ddd <= pred_q[3] ~ "Q2",
          total_prednisone_ddd <= pred_q[4] ~ "Q3",
          total_prednisone_ddd > pred_q[4] ~ "Q4"
        ),
        prednisone_quartile = factor(prednisone_quartile,
                                    levels = c("None", "Q1", "Q2", "Q3", "Q4")),
        
        prednisone_collapsed = case_when(
          total_prednisone_ddd == 0 ~ "None",
          prednisone_quartile == "Q1" ~ "Q1",
          prednisone_quartile %in% c("Q2", "Q3") ~ "Q2-Q3",
          prednisone_quartile == "Q4" ~ "Q4"
        ),
        prednisone_collapsed = factor(prednisone_collapsed,
                                     levels = c("None", "Q1", "Q2-Q3", "Q4"))
      )
    has_pred <- TRUE
  }
  
  hydroxy_users <- cohort_data %>% filter(total_hydroxy_ddd > 0)
  
  has_hydroxy <- FALSE
  if (nrow(hydroxy_users) >= 40) {
    hydroxy_q <- quantile(hydroxy_users$total_hydroxy_ddd,
                         probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
    
    cohort_data <- cohort_data %>%
      mutate(
        hydroxy_quartile = case_when(
          total_hydroxy_ddd == 0 ~ "None",
          total_hydroxy_ddd <= hydroxy_q[2] ~ "Q1",
          total_hydroxy_ddd <= hydroxy_q[3] ~ "Q2",
          total_hydroxy_ddd <= hydroxy_q[4] ~ "Q3",
          total_hydroxy_ddd > hydroxy_q[4] ~ "Q4"
        ),
        hydroxy_quartile = factor(hydroxy_quartile,
                                 levels = c("None", "Q1", "Q2", "Q3", "Q4")),
        
        hydroxy_collapsed = case_when(
          total_hydroxy_ddd == 0 ~ "None",
          hydroxy_quartile == "Q1" ~ "Q1",
          hydroxy_quartile %in% c("Q2", "Q3") ~ "Q2-Q3",
          hydroxy_quartile == "Q4" ~ "Q4"
        ),
        hydroxy_collapsed = factor(hydroxy_collapsed,
                                   levels = c("None", "Q1", "Q2-Q3", "Q4"))
      )
    has_hydroxy <- TRUE
  }
  
  list(
    data = cohort_data,
    has_pred = has_pred,
    has_hydroxy = has_hydroxy
  )
}

all_lupus_result <- calculate_quartiles(cohort_all_lupus, "All Lupus")
cohort_all_lupus <- all_lupus_result$data

lupus_no_neph_result <- calculate_quartiles(cohort_lupus_no_neph, "Lupus No Nephritis")
cohort_lupus_no_neph <- lupus_no_neph_result$data

lupus_with_neph_result <- calculate_quartiles(cohort_lupus_with_neph, "Lupus With Nephritis")
cohort_lupus_with_neph <- lupus_with_neph_result$data

control_result <- calculate_quartiles(cohort_control, "Control")
cohort_control <- control_result$data

cat("\n")

# ============================================================================
# STEP 4: Run subgroup analysis function
# ============================================================================

run_subgroup_analysis <- function(design, var_name, var_label, group_name) {
  tryCatch({
    formula_str <- paste0("Surv(ckd_followup_years, ckd_status) ~ ", var_name)
    model <- svycoxph(as.formula(formula_str), design = design)
    
    sm <- summary(model)
    coef_summary <- sm$coefficients
    
    if (is.null(coef_summary) || nrow(coef_summary) == 0) {
      stop("Model returned no coefficients")
    }
    
    cn <- colnames(coef_summary)
    coef_col <- if ("coef" %in% cn) "coef" else cn[1]
    
    se_col <- dplyr::case_when(
      "robust se" %in% cn ~ "robust se",
      "se(coef)" %in% cn ~ "se(coef)",
      TRUE ~ NA_character_
    )
    if (is.na(se_col)) stop("No SE column found")
    
    p_col <- dplyr::case_when(
      "Pr(>|z|)" %in% cn ~ "Pr(>|z|)",
      "Pr(>|t|)" %in% cn ~ "Pr(>|t|)",
      "p" %in% cn ~ "p",
      TRUE ~ NA_character_
    )
    if (is.na(p_col)) stop("No p-value column found")
    
    out <- lapply(seq_len(nrow(coef_summary)), function(i) {
      row_name <- rownames(coef_summary)[i]
      
      beta <- as.numeric(coef_summary[i, coef_col])
      se <- as.numeric(coef_summary[i, se_col])
      p <- as.numeric(coef_summary[i, p_col])
      
      hr <- exp(beta)
      ci_lower <- exp(beta - 1.96 * se)
      ci_upper <- exp(beta + 1.96 * se)
      
      cat_name <- gsub(paste0("^", var_name), "", row_name)
      cat_name <- gsub("^\\s*|\\s*$", "", cat_name)
      cat_name <- ifelse(cat_name == "", NA_character_, cat_name)
      
      data.frame(
        Group = group_name,
        Variable = var_label,
        Category = cat_name,
        HR = hr,
        CI_lower = ci_lower,
        CI_upper = ci_upper,
        p_value = p,
        stringsAsFactors = FALSE
      )
    })
    
    dplyr::bind_rows(out)
    
  }, error = function(e) {
    cat("  Error in", group_name, "-", var_label, ":", e$message, "\n")
    return(NULL)
  })
}

# ============================================================================
# STEP 5: Run analyses for each cohort
# ============================================================================

run_cohort_analysis <- function(cohort_data, cohort_name, has_pred, has_hydroxy) {
  
  cat("Running analyses:", cohort_name, "\n")
  
  svy <- svydesign(ids = ~1, weights = ~iptw, data = cohort_data)
  
  results <- list()
  results[["sex"]] <- run_subgroup_analysis(svy, "gender_factor", "Sex", cohort_name)
  results[["age"]] <- run_subgroup_analysis(svy, "age_cat", "Age", cohort_name)
  results[["ses"]] <- run_subgroup_analysis(svy, "ses_category", "Socioeconomic Status", cohort_name)
  results[["bmi"]] <- run_subgroup_analysis(svy, "bmi_cat", "BMI", cohort_name)
  results[["ihd"]] <- run_subgroup_analysis(svy, "ihd_factor", "Ischemic Heart Disease", cohort_name)
  results[["diabetes"]] <- run_subgroup_analysis(svy, "diabetes_factor", "Diabetes Mellitus", cohort_name)
  results[["biologic"]] <- run_subgroup_analysis(svy, "biologics_factor", "Biologic Treatment", cohort_name)
  results[["raas"]] <- run_subgroup_analysis(svy, "raas_factor", "RAAS Inhibitors", cohort_name)
  
  sglt2_n <- sum(cohort_data$sglt_2_medication == 1, na.rm = TRUE)
  if (sglt2_n >= 20) {
    results[["sglt2"]] <- run_subgroup_analysis(svy, "sglt2_factor", "SGLT2 Inhibitors", cohort_name)
  }
  
  if (has_pred) {
    pred_users <- cohort_data %>% filter(total_prednisone_ddd > 0)
    
    if (nrow(pred_users) >= 40) {
      pred_users <- pred_users %>%
        mutate(prednisone_q_users = droplevels(prednisone_collapsed))
      
      svy_pred_users <- svydesign(ids = ~1, weights = ~iptw, data = pred_users)
      
      results[["pred_quartile"]] <- run_subgroup_analysis(
        svy_pred_users,
        "prednisone_q_users",
        "Prednisone Exposure (Cumulative)",
        cohort_name
      )
    }
  }
  
  if (has_hydroxy) {
    hydroxy_users <- cohort_data %>% filter(total_hydroxy_ddd > 0)
    
    if (nrow(hydroxy_users) >= 40) {
      hydroxy_users <- hydroxy_users %>%
        mutate(hydroxy_q_users = droplevels(hydroxy_collapsed))
      
      svy_hydroxy_users <- svydesign(ids = ~1, weights = ~iptw, data = hydroxy_users)
      
      results[["hydroxy_quartile"]] <- run_subgroup_analysis(
        svy_hydroxy_users,
        "hydroxy_q_users",
        "Hydroxychloroquine Exposure (Cumulative)",
        cohort_name
      )
    }
  }
  
  cat("  ✓ Complete\n")
  
  dplyr::bind_rows(results[!sapply(results, is.null)])
}

# Run for all cohorts
all_lupus_results <- run_cohort_analysis(
  cohort_all_lupus, "All Lupus", 
  all_lupus_result$has_pred, all_lupus_result$has_hydroxy
)

lupus_no_neph_results <- run_cohort_analysis(
  cohort_lupus_no_neph, "Lupus No Nephritis",
  lupus_no_neph_result$has_pred, lupus_no_neph_result$has_hydroxy
)

lupus_with_neph_results <- run_cohort_analysis(
  cohort_lupus_with_neph, "Lupus With Nephritis",
  lupus_with_neph_result$has_pred, lupus_with_neph_result$has_hydroxy
)

control_results <- run_cohort_analysis(
  cohort_control, "Control",
  control_result$has_pred, control_result$has_hydroxy
)

cat("\n")

# ============================================================================
# STEP 6: Create datasets for each figure
# ============================================================================

cat("Creating figure datasets...\n")

# Figure 1: All Lupus vs Control
fig1_data <- bind_rows(control_results, all_lupus_results) %>%
  mutate(
    HR_CI = sprintf("%.2f (%.2f–%.2f)", HR, CI_lower, CI_upper),
    p_value_fmt = ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value))
  )

cat("  fig1_data created: N =", nrow(fig1_data), "\n")

# Figure 2: Lupus No Nephritis vs Control
fig2_data <- bind_rows(control_results, lupus_no_neph_results) %>%
  mutate(
    HR_CI = sprintf("%.2f (%.2f–%.2f)", HR, CI_lower, CI_upper),
    p_value_fmt = ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value))
  )

cat("  fig2_data created: N =", nrow(fig2_data), "\n")

# Figure 4: Lupus With Nephritis vs Without Nephritis
fig4_data <- bind_rows(lupus_with_neph_results, lupus_no_neph_results) %>%
  mutate(
    HR_CI = sprintf("%.2f (%.2f–%.2f)", HR, CI_lower, CI_upper),
    p_value_fmt = ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value))
  )

cat("  fig4_data created: N =", nrow(fig4_data), "\n\n")

cat("✓ All datasets prepared successfully\n\n")

# ============================================================================
# STEP 7: Forest plot function
# ============================================================================

create_forest_plot_single_label <- function(data, title_text, filename_base, group_colors, group_shapes) {
  
  x_trunc <- 15
  x_left_text <- -7
  x_hr_text <- 16
  x_p_text <- 21
  x_limits <- c(x_left_text, 24)
  
  age_ref <- "<40 years [ref]"
  ses_ref <- "Low [ref]"
  
  # Normalize category labels
  normalize_category <- function(x) {
    x <- as.character(x)
    x <- gsub("40-59 years", "40–59 years", x, fixed = TRUE)
    x <- gsub(">=60 years", "≥60 years", x, fixed = TRUE)
    ifelse(grepl("30", x) & grepl("(≥|>=|=|\\+)", x), "≥30", x)
  }
  
  # Stable ordering
  order_tbl <- data %>%
    mutate(.idx = row_number()) %>%
    mutate(
      Variable = as.character(Variable),
      Category_label = normalize_category(Category)
    ) %>%
    group_by(Variable, Category_label) %>%
    summarise(min_idx = min(.idx), .groups = "drop") %>%
    arrange(min_idx) %>%
    mutate(pair = row_number())
  
  forest_prep <- data %>%
    mutate(
      Variable = as.character(Variable),
      Category_label = normalize_category(Category),
      Group = factor(Group, levels = names(group_colors)),
      CI_lower_plot = pmax(CI_lower, 0.1),
      CI_upper_plot = pmin(CI_upper, x_trunc),
      HR_plot = pmin(pmax(HR, 0.1), x_trunc),
      truncated = !is.na(CI_upper) & CI_upper > x_trunc
    ) %>%
    left_join(order_tbl, by = c("Variable", "Category_label")) %>%
    arrange(pair, Group)
  
  n_pairs <- max(forest_prep$pair, na.rm = TRUE)
  n_groups <- length(unique(forest_prep$Group))
  
  forest_prep <- forest_prep %>%
    group_by(pair) %>%
    mutate(
      group_order = match(as.character(Group), names(group_colors)),
      row = (n_pairs - pair) * (n_groups + 0.5) + (n_groups - group_order + 1)
    ) %>%
    ungroup()
  
  # Labels
  pair_labels <- forest_prep %>%
    distinct(pair, Variable, Category_label) %>%
    mutate(
      is_age = grepl("^age$|age", Variable, ignore.case = TRUE),
      is_ses = grepl("socio", Variable, ignore.case = TRUE) | grepl("\\bSES\\b", Variable, ignore.case = TRUE),
      is_bmi = grepl("\\bBMI\\b", Variable, ignore.case = TRUE),
      is_pred_exp = grepl("Prednisone Exposure", Variable, ignore.case = TRUE),
      is_hydroxy_exp = grepl("Hydroxychloroquine Exposure", Variable, ignore.case = TRUE),
      
      label = case_when(
        is_pred_exp & Category_label == "Q2-Q3" ~ "Prednisone (Q2-Q3 vs Q1)",
        is_pred_exp & Category_label == "Q4" ~ "Prednisone (Q4 vs Q1)",
        is_hydroxy_exp & Category_label == "Q2-Q3" ~ "Hydroxychloroquine (Q2-Q3 vs Q1)",
        is_hydroxy_exp & Category_label == "Q4" ~ "Hydroxychloroquine (Q4 vs Q1)",
        Category_label == "Yes" ~ Variable,
        is_bmi & Category_label == "≥30" ~ "BMI (≥30 kg/m²)",
        is_age ~ paste0("Age (", Category_label, " vs ", age_ref, ")"),
        is_ses ~ paste0("Socioeconomic Status (", Category_label, " vs ", ses_ref, ")"),
        TRUE ~ paste0(Variable, " (", Category_label, ")")
      )
    ) %>%
    left_join(
      forest_prep %>% group_by(pair) %>% summarise(y_mid = mean(row), .groups = "drop"),
      by = "pair"
    )
  
  # Background
  pair_bg <- forest_prep %>%
    group_by(pair) %>%
    summarise(
      y_min = min(row) - 0.5,
      y_max = max(row) + 0.5,
      .groups = "drop"
    ) %>%
    mutate(row_fill = ifelse(pair %% 2 == 1, "gray94", "white"))
  
  p <- ggplot(forest_prep, aes(y = row)) +
    geom_rect(
      data = pair_bg,
      aes(ymin = y_min, ymax = y_max, xmin = -Inf, xmax = Inf, fill = row_fill),
      inherit.aes = FALSE
    ) +
    scale_fill_identity() +
    geom_vline(xintercept = 1, linetype = "dashed", color = "black", linewidth = 0.6) +
    geom_segment(
      data = forest_prep %>% filter(!is.na(HR), !truncated),
      aes(x = CI_lower_plot, xend = CI_upper_plot, yend = row, color = Group),
      linewidth = 0.8
    ) +
    geom_segment(
      data = forest_prep %>% filter(!is.na(HR), truncated),
      aes(x = CI_lower_plot, xend = CI_upper_plot, yend = row, color = Group),
      linewidth = 0.8,
      arrow = arrow(length = unit(0.18, "cm"), type = "closed")
    ) +
    geom_point(
      data = forest_prep %>% filter(!is.na(HR)),
      aes(x = HR_plot, shape = Group, color = Group),
      size = 3.6
    ) +
    geom_text(
      data = pair_labels,
      aes(x = x_left_text, y = y_mid, label = label),
      inherit.aes = FALSE,
      hjust = 0, size = 4.1, fontface = "bold", color = "gray25"
    ) +
    geom_text(aes(x = x_hr_text, label = HR_CI), hjust = 0, size = 3.7, color = "gray25") +
    geom_text(aes(x = x_p_text, label = p_value_fmt), hjust = 0, size = 3.7, color = "gray25") +
    scale_color_manual(values = group_colors, name = "") +
    scale_shape_manual(values = group_shapes, name = "") +
    scale_x_continuous(
      limits = x_limits,
      breaks = c(0, 1, 2, 4, 8, 15),
      labels = c("0", "1", "2", "4", "8", "15"),
      expand = c(0, 0)
    ) +
    labs(x = "Hazard Ratio (95% CI)", title = title_text) +
    coord_cartesian(clip = "off") +
    theme_classic(base_size = 12) +
    theme(
      panel.grid.major.x = element_line(color = "gray85", linewidth = 0.3),
      panel.grid.minor = element_blank(),
      axis.line.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_text(size = 11),
      axis.title.x = element_text(size = 13, face = "bold"),
      plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
      legend.position = "top",
      legend.text = element_text(size = 11),
      plot.margin = margin(15, 70, 20, 80)
    ) +
    annotate("text", x = x_hr_text, y = max(forest_prep$row) + 1.4,
             label = "HR (95% CI)", hjust = 0, fontface = "bold", size = 4.8) +
    annotate("text", x = x_p_text, y = max(forest_prep$row) + 1.4,
             label = "P-value", hjust = 0, fontface = "bold", size = 4.8)
  
  print(p)
  
  ggsave(paste0(filename_base, ".pdf"), plot = p, width = 20, height = 14, bg = "white")
  ggsave(paste0(filename_base, ".png"), plot = p, width = 20, height = 14, dpi = 300, bg = "white")
  
  cat("✓ Saved:", filename_base, "\n\n")
  invisible(p)
}

# ============================================================================
# STEP 8: Create forest plots
# ============================================================================

cat("\n=== Creating Forest Plots ===\n\n")

# Figure 1
cat("Creating Figure 1: All Lupus vs Control\n")
create_forest_plot_single_label(
  data = fig1_data,
  title_text = "Subgroup Analysis: CKD Risk Factors in All Lupus vs Control",
  filename_base = "Figure1_All_Lupus_vs_Control",
  group_colors = c("Control" = "#374E55", "All Lupus" = "#B24745"),
  group_shapes = c("Control" = 15, "All Lupus" = 16)
)

# Figure 2
cat("Creating Figure 2: Lupus (No Nephritis) vs Control\n")
create_forest_plot_single_label(
  data = fig2_data,
  title_text = "Subgroup Analysis: CKD Risk Factors in Lupus (No Nephritis) vs Control",
  filename_base = "Figure2_Lupus_No_Nephritis_vs_Control",
  group_colors = c("Control" = "#374E55", "Lupus No Nephritis" = "#B24745"),
  group_shapes = c("Control" = 15, "Lupus No Nephritis" = 16)
)

# Figure 4
cat("Creating Figure 4: Lupus With Nephritis vs Without Nephritis\n")
create_forest_plot_single_label(
  data = fig4_data,
  title_text = "Subgroup Analysis: CKD Risk Factors by Lupus Nephritis Status",
  filename_base = "Figure4_Lupus_With_vs_Without_Nephritis",
  group_colors = c("Lupus With Nephritis" = "#B24745", "Lupus No Nephritis" = "#5B8C5A"),
  group_shapes = c("Lupus With Nephritis" = 16, "Lupus No Nephritis" = 17)
)

cat("\n", rep("=", 80), "\n", sep = "")
cat("✓ CHUNK 15E-COMPLETE FINISHED!\n")
cat(rep("=", 80), "\n\n", sep = "")

cat("Forest plots created:\n")
cat("  1. Figure1_All_Lupus_vs_Control.pdf/.png\n")
cat("  2. Figure2_Lupus_No_Nephritis_vs_Control.pdf/.png\n")
cat("  3. Figure4_Lupus_With_vs_Without_Nephritis.pdf/.png\n")
```












# CHUNK 18 REVISED: Fine-Gray SHR with tbl_regression-style output

```{r}
# ============================================================================
# COMPETING RISKS ANALYSIS - 2-GROUP AND 3-GROUP (CORRECTED)
# ============================================================================

cat("\n=== Competing Risks Analysis: Cause-Specific HR and Fine-Gray SHR ===\n\n")

library(gtsummary)
library(survival)
library(cmprsk)
library(dplyr)
library(flextable)
library(officer)

# ============================================================================
# STEP 0: CREATE COMPETING RISK STATUS VARIABLES
# ============================================================================

cat("Creating competing risk status variables...\n")

cohort_surv <- cohort_surv %>%
  mutate(
    # CKD competing risk: 0=censored, 1=CKD event, 2=death before CKD
    ckd_cr_status = case_when(
      ckd_status == 1 ~ 1,  # CKD event
      death_status == 1 & (is.na(ckd_status) | ckd_status == 0) ~ 2,  # Died before CKD
      TRUE ~ 0  # Censored
    ),
    ckd_cr_time = case_when(
      ckd_status == 1 ~ ckd_followup_years * 365.25,
      death_status == 1 ~ death_followup_years * 365.25,
      TRUE ~ ckd_followup_years * 365.25
    ),
    
    # ESKD competing risk: 0=censored, 1=ESKD event, 2=death before ESKD
    eskd_cr_status = case_when(
      eskd_status == 1 ~ 1,  # ESKD event
      death_status == 1 & (is.na(eskd_status) | eskd_status == 0) ~ 2,  # Died before ESKD
      TRUE ~ 0  # Censored
    ),
    eskd_cr_time = case_when(
      eskd_status == 1 ~ eskd_followup_years * 365.25,
      death_status == 1 ~ death_followup_years * 365.25,
      TRUE ~ eskd_followup_years * 365.25
    ),
    
    # MACE competing risk: 0=censored, 1=MACE event, 2=death before MACE
    mace_cr_status = case_when(
      cvd_status == 1 ~ 1,  # MACE event
      death_status == 1 & (is.na(cvd_status) | cvd_status == 0) ~ 2,  # Died before MACE
      TRUE ~ 0  # Censored
    ),
    mace_cr_time = case_when(
      cvd_status == 1 ~ cvd_followup_years * 365.25,
      death_status == 1 ~ death_followup_years * 365.25,
      TRUE ~ cvd_followup_years * 365.25
    )
  )

cat("Competing risk variables created\n")
cat("CKD competing risk status:\n")
print(table(cohort_surv$ckd_cr_status, useNA = "always"))
cat("ESKD competing risk status:\n")
print(table(cohort_surv$eskd_cr_status, useNA = "always"))
cat("MACE competing risk status:\n")
print(table(cohort_surv$mace_cr_status, useNA = "always"))
cat("\n")

# ============================================================================
# PART 1: 2-GROUP ANALYSIS (Lupus vs Control)
# ============================================================================

cat("\n=== PART 1: Two-Group Analysis (Lupus vs Control) ===\n\n")

# Create cause-specific status variables (censor competing events)
cohort_surv <- cohort_surv %>%
  mutate(
    # CKD cause-specific: censor deaths (treat as censored, not competing)
    ckd_cs_status = ifelse(ckd_cr_status == 1, 1, 0),
    # ESKD cause-specific
    eskd_cs_status = ifelse(eskd_cr_status == 1, 1, 0),
    # MACE cause-specific
    mace_cs_status = ifelse(mace_cr_status == 1, 1, 0)
  )

# ----------------------------------------------------------------------------
# Cause-Specific Cox Models (weighted)
# ----------------------------------------------------------------------------

cat("Running cause-specific Cox models (2-group)...\n")

cox_ckd_2g <- coxph(
  Surv(ckd_cr_time / 365.25, ckd_cs_status) ~ Lupus,
  data = cohort_surv,
  weights = iptw
)

cox_eskd_2g <- coxph(
  Surv(eskd_cr_time / 365.25, eskd_cs_status) ~ Lupus,
  data = cohort_surv,
  weights = iptw
)

cox_mace_2g <- coxph(
  Surv(mace_cr_time / 365.25, mace_cs_status) ~ Lupus,
  data = cohort_surv,
  weights = iptw
)

cox_death_2g <- coxph(
  Surv(death_followup_years, death_status) ~ Lupus,
  data = cohort_surv,
  weights = iptw
)

cat("✓ Cause-specific Cox models complete\n\n")

# ----------------------------------------------------------------------------
# Fine-Gray Subdistribution Hazard Models
# ----------------------------------------------------------------------------

cat("Running Fine-Gray models (2-group)...\n")

cohort_surv$lupus_numeric <- as.numeric(cohort_surv$Lupus)

fg_ckd_2g <- crr(
  ftime = cohort_surv$ckd_cr_time / 365.25,
  fstatus = cohort_surv$ckd_cr_status,
  cov1 = cohort_surv$lupus_numeric,
  failcode = 1,
  cencode = 0
)

fg_eskd_2g <- crr(
  ftime = cohort_surv$eskd_cr_time / 365.25,
  fstatus = cohort_surv$eskd_cr_status,
  cov1 = cohort_surv$lupus_numeric,
  failcode = 1,
  cencode = 0
)

fg_mace_2g <- crr(
  ftime = cohort_surv$mace_cr_time / 365.25,
  fstatus = cohort_surv$mace_cr_status,
  cov1 = cohort_surv$lupus_numeric,
  failcode = 1,
  cencode = 0
)

cat("✓ Fine-Gray models complete\n\n")

# ----------------------------------------------------------------------------
# Extract and Format Results (2-group)
# ----------------------------------------------------------------------------

cat("Extracting results...\n")

# Helper function to format HR/SHR
format_hr <- function(est, ci_l, ci_u, p) {
  hr_fmt <- sprintf("%.2f (%.2f-%.2f)", est, ci_l, ci_u)
  p_fmt <- ifelse(p < 0.001, "<0.001", sprintf("%.3f", p))
  return(list(hr_ci = hr_fmt, p = p_fmt))
}

# Extract cause-specific HRs
cs_ckd_2g <- c(exp(coef(cox_ckd_2g)), exp(confint(cox_ckd_2g)), 
               summary(cox_ckd_2g)$coefficients[,"Pr(>|z|)"])
cs_eskd_2g <- c(exp(coef(cox_eskd_2g)), exp(confint(cox_eskd_2g)), 
                summary(cox_eskd_2g)$coefficients[,"Pr(>|z|)"])
cs_mace_2g <- c(exp(coef(cox_mace_2g)), exp(confint(cox_mace_2g)), 
                summary(cox_mace_2g)$coefficients[,"Pr(>|z|)"])
cs_death_2g <- c(exp(coef(cox_death_2g)), exp(confint(cox_death_2g)), 
                 summary(cox_death_2g)$coefficients[,"Pr(>|z|)"])

# Extract Fine-Gray SHRs
fg_ckd_est_2g <- c(exp(fg_ckd_2g$coef), 
                   exp(fg_ckd_2g$coef - 1.96*sqrt(fg_ckd_2g$var)), 
                   exp(fg_ckd_2g$coef + 1.96*sqrt(fg_ckd_2g$var)),
                   2*(1-pnorm(abs(fg_ckd_2g$coef/sqrt(fg_ckd_2g$var)))))
fg_eskd_est_2g <- c(exp(fg_eskd_2g$coef), 
                    exp(fg_eskd_2g$coef - 1.96*sqrt(fg_eskd_2g$var)), 
                    exp(fg_eskd_2g$coef + 1.96*sqrt(fg_eskd_2g$var)),
                    2*(1-pnorm(abs(fg_eskd_2g$coef/sqrt(fg_eskd_2g$var)))))
fg_mace_est_2g <- c(exp(fg_mace_2g$coef), 
                    exp(fg_mace_2g$coef - 1.96*sqrt(fg_mace_2g$var)), 
                    exp(fg_mace_2g$coef + 1.96*sqrt(fg_mace_2g$var)),
                    2*(1-pnorm(abs(fg_mace_2g$coef/sqrt(fg_mace_2g$var)))))

# Create combined results table (2-group)
combined_results_2g <- data.frame(
  Outcome = c("Chronic Kidney Disease (CKD)", 
              "End-Stage Kidney Disease (ESKD)", 
              "Major Adverse Cardiovascular Events (MACE)", 
              "All-Cause Mortality"),
  Events_Control = c(
    sum(cohort_surv$ckd_cs_status[cohort_surv$Lupus == 0], na.rm = TRUE),
    sum(cohort_surv$eskd_cs_status[cohort_surv$Lupus == 0], na.rm = TRUE),
    sum(cohort_surv$mace_cs_status[cohort_surv$Lupus == 0], na.rm = TRUE),
    sum(cohort_surv$death_status[cohort_surv$Lupus == 0], na.rm = TRUE)
  ),
  Events_Lupus = c(
    sum(cohort_surv$ckd_cs_status[cohort_surv$Lupus == 1], na.rm = TRUE),
    sum(cohort_surv$eskd_cs_status[cohort_surv$Lupus == 1], na.rm = TRUE),
    sum(cohort_surv$mace_cs_status[cohort_surv$Lupus == 1], na.rm = TRUE),
    sum(cohort_surv$death_status[cohort_surv$Lupus == 1], na.rm = TRUE)
  ),
  CS_HR = c(
    format_hr(cs_ckd_2g[1], cs_ckd_2g[2], cs_ckd_2g[3], cs_ckd_2g[4])$hr_ci,
    format_hr(cs_eskd_2g[1], cs_eskd_2g[2], cs_eskd_2g[3], cs_eskd_2g[4])$hr_ci,
    format_hr(cs_mace_2g[1], cs_mace_2g[2], cs_mace_2g[3], cs_mace_2g[4])$hr_ci,
    format_hr(cs_death_2g[1], cs_death_2g[2], cs_death_2g[3], cs_death_2g[4])$hr_ci
  ),
  CS_P = c(
    format_hr(cs_ckd_2g[1], cs_ckd_2g[2], cs_ckd_2g[3], cs_ckd_2g[4])$p,
    format_hr(cs_eskd_2g[1], cs_eskd_2g[2], cs_eskd_2g[3], cs_eskd_2g[4])$p,
    format_hr(cs_mace_2g[1], cs_mace_2g[2], cs_mace_2g[3], cs_mace_2g[4])$p,
    format_hr(cs_death_2g[1], cs_death_2g[2], cs_death_2g[3], cs_death_2g[4])$p
  ),
  FG_SHR = c(
    format_hr(fg_ckd_est_2g[1], fg_ckd_est_2g[2], fg_ckd_est_2g[3], fg_ckd_est_2g[4])$hr_ci,
    format_hr(fg_eskd_est_2g[1], fg_eskd_est_2g[2], fg_eskd_est_2g[3], fg_eskd_est_2g[4])$hr_ci,
    format_hr(fg_mace_est_2g[1], fg_mace_est_2g[2], fg_mace_est_2g[3], fg_mace_est_2g[4])$hr_ci,
    "—"  # No competing risk for death
  ),
  FG_P = c(
    format_hr(fg_ckd_est_2g[1], fg_ckd_est_2g[2], fg_ckd_est_2g[3], fg_ckd_est_2g[4])$p,
    format_hr(fg_eskd_est_2g[1], fg_eskd_est_2g[2], fg_eskd_est_2g[3], fg_eskd_est_2g[4])$p,
    format_hr(fg_mace_est_2g[1], fg_mace_est_2g[2], fg_mace_est_2g[3], fg_mace_est_2g[4])$p,
    "—"
  ),
  stringsAsFactors = FALSE
)

cat("\n2-Group Results:\n")
print(combined_results_2g)
cat("\n")

# Create flextable (2-group)
ft_combined_2g <- combined_results_2g %>%
  flextable() %>%
  set_header_labels(
    Outcome = "Outcome",
    Events_Control = "Events\n(Control)",
    Events_Lupus = "Events\n(Lupus)",
    CS_HR = "Cause-Specific HR\n(95% CI)",
    CS_P = "P-value",
    FG_SHR = "Fine-Gray SHR\n(95% CI)",
    FG_P = "P-value"
  ) %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  bg(bg = "#2C2C2C", part = "header") %>%
  color(color = "white", part = "header") %>%
  align(align = "center", part = "header") %>%
  align(j = 1, align = "left", part = "body") %>%
  align(j = 2:7, align = "center", part = "body") %>%
  autofit() %>%
  add_footer_lines("Cause-Specific HR: Cox proportional hazards model censoring competing events (death)") %>%
  add_footer_lines("Fine-Gray SHR: Subdistribution hazard ratio accounting for competing risk of death") %>%
  add_footer_lines("All models weighted by IPTW (ATT). Reference: Control group.") %>%
  add_footer_lines("— indicates not applicable (no competing risk for all-cause mortality)")

# Save to Word (2-group)
doc_competing_2g <- read_docx() %>%
  body_add_par("Table 4A: Competing Risks Analysis - Lupus vs Control", style = "heading 1") %>%
  body_add_par(
    paste0(
      "Comparison of cause-specific hazard ratios and Fine-Gray subdistribution hazard ratios ",
      "for kidney and cardiovascular outcomes. ",
      "Cause-specific hazard ratios treat death as censoring, ",
      "while Fine-Gray subdistribution hazard ratios account for death as a competing event. ",
      "HR = hazard ratio; SHR = subdistribution hazard ratio; CI = confidence interval; ",
      "IPTW = inverse probability of treatment weighting; ATT = average treatment effect on treated."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_combined_2g)

print(doc_competing_2g, target = "Table4A_Competing_Risks_2Group.docx")

cat("✓ Table 4A saved: Table4A_Competing_Risks_2Group.docx\n\n")

# ============================================================================
# PART 2: 3-GROUP ANALYSIS (Control, Lupus without Nephritis, Lupus with Nephritis)
# ============================================================================

cat("\n=== PART 2: Three-Group Analysis (by Nephritis Status) ===\n\n")

# Create 3-level group variable if not already present
if(!"group_3level_factor" %in% colnames(cohort_surv)) {
  cohort_surv <- cohort_surv %>%
    left_join(
      lupus_original_file %>% dplyr::select(patient_id, naparitis),
      by = "patient_id"
    ) %>%
    mutate(
      group_3level = case_when(
        Lupus == 0 ~ "Control",
        Lupus == 1 & naparitis == 1 ~ "Lupus with Nephritis",
        Lupus == 1 & (is.na(naparitis) | naparitis == 0) ~ "Lupus without Nephritis",
        TRUE ~ NA_character_
      ),
      group_3level_factor = factor(
        group_3level,
        levels = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")
      ),
      # Create dummy variables for regression
      lupus_without_nephritis = ifelse(group_3level == "Lupus without Nephritis", 1, 0),
      lupus_with_nephritis = ifelse(group_3level == "Lupus with Nephritis", 1, 0)
    )
}

cat("3-level group distribution:\n")
print(table(cohort_surv$group_3level_factor, useNA = "always"))
cat("\n")

# ----------------------------------------------------------------------------
# Cause-Specific Cox Models (3-group, weighted)
# ----------------------------------------------------------------------------

cat("Running cause-specific Cox models (3-group)...\n")

cox_ckd_3g <- coxph(
  Surv(ckd_cr_time / 365.25, ckd_cs_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  data = cohort_surv,
  weights = iptw
)

cox_eskd_3g <- coxph(
  Surv(eskd_cr_time / 365.25, eskd_cs_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  data = cohort_surv,
  weights = iptw
)

cox_mace_3g <- coxph(
  Surv(mace_cr_time / 365.25, mace_cs_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  data = cohort_surv,
  weights = iptw
)

cox_death_3g <- coxph(
  Surv(death_followup_years, death_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  data = cohort_surv,
  weights = iptw
)

cat("✓ Cause-specific Cox models complete\n\n")

# ----------------------------------------------------------------------------
# Fine-Gray Models (3-group)
# ----------------------------------------------------------------------------

cat("Running Fine-Gray models (3-group)...\n")

# Create covariate matrix for Fine-Gray (2 dummy variables)
cov_matrix_3g <- cbind(cohort_surv$lupus_without_nephritis, 
                       cohort_surv$lupus_with_nephritis)

fg_ckd_3g <- crr(
  ftime = cohort_surv$ckd_cr_time / 365.25,
  fstatus = cohort_surv$ckd_cr_status,
  cov1 = cov_matrix_3g,
  failcode = 1,
  cencode = 0
)

fg_eskd_3g <- crr(
  ftime = cohort_surv$eskd_cr_time / 365.25,
  fstatus = cohort_surv$eskd_cr_status,
  cov1 = cov_matrix_3g,
  failcode = 1,
  cencode = 0
)

fg_mace_3g <- crr(
  ftime = cohort_surv$mace_cr_time / 365.25,
  fstatus = cohort_surv$mace_cr_status,
  cov1 = cov_matrix_3g,
  failcode = 1,
  cencode = 0
)

cat("✓ Fine-Gray models complete\n\n")

# ----------------------------------------------------------------------------
# Extract Results for Each Comparison (3-group)
# ----------------------------------------------------------------------------

cat("Extracting 3-group results...\n")

# Helper to extract from models with 2 coefficients
extract_3g_hr <- function(model, coef_idx) {
  hr <- exp(coef(model)[coef_idx])
  ci <- exp(confint(model)[coef_idx, ])
  p <- summary(model)$coefficients[coef_idx, "Pr(>|z|)"]
  return(c(hr, ci[1], ci[2], p))
}

extract_3g_fg <- function(model, coef_idx) {
  shr <- exp(model$coef[coef_idx])
  se <- sqrt(model$var[coef_idx, coef_idx])
  ci_l <- exp(model$coef[coef_idx] - 1.96 * se)
  ci_u <- exp(model$coef[coef_idx] + 1.96 * se)
  z <- model$coef[coef_idx] / se
  p <- 2 * (1 - pnorm(abs(z)))
  return(c(shr, ci_l, ci_u, p))
}

# Extract for "Lupus without Nephritis vs Control" (coef 1)
cs_ckd_3g_wo <- extract_3g_hr(cox_ckd_3g, 1)
cs_eskd_3g_wo <- extract_3g_hr(cox_eskd_3g, 1)
cs_mace_3g_wo <- extract_3g_hr(cox_mace_3g, 1)
cs_death_3g_wo <- extract_3g_hr(cox_death_3g, 1)

fg_ckd_3g_wo <- extract_3g_fg(fg_ckd_3g, 1)
fg_eskd_3g_wo <- extract_3g_fg(fg_eskd_3g, 1)
fg_mace_3g_wo <- extract_3g_fg(fg_mace_3g, 1)

# Extract for "Lupus with Nephritis vs Control" (coef 2)
cs_ckd_3g_wi <- extract_3g_hr(cox_ckd_3g, 2)
cs_eskd_3g_wi <- extract_3g_hr(cox_eskd_3g, 2)
cs_mace_3g_wi <- extract_3g_hr(cox_mace_3g, 2)
cs_death_3g_wi <- extract_3g_hr(cox_death_3g, 2)

fg_ckd_3g_wi <- extract_3g_fg(fg_ckd_3g, 2)
fg_eskd_3g_wi <- extract_3g_fg(fg_eskd_3g, 2)
fg_mace_3g_wi <- extract_3g_fg(fg_mace_3g, 2)

# Create results table (3-group)
combined_results_3g <- data.frame(
  Outcome = rep(c("Chronic Kidney Disease (CKD)", "",
                  "End-Stage Kidney Disease (ESKD)", "",
                  "Major Adverse Cardiovascular Events (MACE)", "",
                  "All-Cause Mortality", ""), 1)[1:8],
  Comparison = rep(c("Lupus without Nephritis vs Control", 
                     "Lupus with Nephritis vs Control"), 4),
  CS_HR = c(
    format_hr(cs_ckd_3g_wo[1], cs_ckd_3g_wo[2], cs_ckd_3g_wo[3], cs_ckd_3g_wo[4])$hr_ci,
    format_hr(cs_ckd_3g_wi[1], cs_ckd_3g_wi[2], cs_ckd_3g_wi[3], cs_ckd_3g_wi[4])$hr_ci,
    format_hr(cs_eskd_3g_wo[1], cs_eskd_3g_wo[2], cs_eskd_3g_wo[3], cs_eskd_3g_wo[4])$hr_ci,
    format_hr(cs_eskd_3g_wi[1], cs_eskd_3g_wi[2], cs_eskd_3g_wi[3], cs_eskd_3g_wi[4])$hr_ci,
    format_hr(cs_mace_3g_wo[1], cs_mace_3g_wo[2], cs_mace_3g_wo[3], cs_mace_3g_wo[4])$hr_ci,
    format_hr(cs_mace_3g_wi[1], cs_mace_3g_wi[2], cs_mace_3g_wi[3], cs_mace_3g_wi[4])$hr_ci,
    format_hr(cs_death_3g_wo[1], cs_death_3g_wo[2], cs_death_3g_wo[3], cs_death_3g_wo[4])$hr_ci,
    format_hr(cs_death_3g_wi[1], cs_death_3g_wi[2], cs_death_3g_wi[3], cs_death_3g_wi[4])$hr_ci
  ),
  CS_P = c(
    format_hr(cs_ckd_3g_wo[1], cs_ckd_3g_wo[2], cs_ckd_3g_wo[3], cs_ckd_3g_wo[4])$p,
    format_hr(cs_ckd_3g_wi[1], cs_ckd_3g_wi[2], cs_ckd_3g_wi[3], cs_ckd_3g_wi[4])$p,
    format_hr(cs_eskd_3g_wo[1], cs_eskd_3g_wo[2], cs_eskd_3g_wo[3], cs_eskd_3g_wo[4])$p,
    format_hr(cs_eskd_3g_wi[1], cs_eskd_3g_wi[2], cs_eskd_3g_wi[3], cs_eskd_3g_wi[4])$p,
    format_hr(cs_mace_3g_wo[1], cs_mace_3g_wo[2], cs_mace_3g_wo[3], cs_mace_3g_wo[4])$p,
    format_hr(cs_mace_3g_wi[1], cs_mace_3g_wi[2], cs_mace_3g_wi[3], cs_mace_3g_wi[4])$p,
    format_hr(cs_death_3g_wo[1], cs_death_3g_wo[2], cs_death_3g_wo[3], cs_death_3g_wo[4])$p,
    format_hr(cs_death_3g_wi[1], cs_death_3g_wi[2], cs_death_3g_wi[3], cs_death_3g_wi[4])$p
  ),
  FG_SHR = c(
    format_hr(fg_ckd_3g_wo[1], fg_ckd_3g_wo[2], fg_ckd_3g_wo[3], fg_ckd_3g_wo[4])$hr_ci,
    format_hr(fg_ckd_3g_wi[1], fg_ckd_3g_wi[2], fg_ckd_3g_wi[3], fg_ckd_3g_wi[4])$hr_ci,
    format_hr(fg_eskd_3g_wo[1], fg_eskd_3g_wo[2], fg_eskd_3g_wo[3], fg_eskd_3g_wo[4])$hr_ci,
    format_hr(fg_eskd_3g_wi[1], fg_eskd_3g_wi[2], fg_eskd_3g_wi[3], fg_eskd_3g_wi[4])$hr_ci,
    format_hr(fg_mace_3g_wo[1], fg_mace_3g_wo[2], fg_mace_3g_wo[3], fg_mace_3g_wo[4])$hr_ci,
    format_hr(fg_mace_3g_wi[1], fg_mace_3g_wi[2], fg_mace_3g_wi[3], fg_mace_3g_wi[4])$hr_ci,
    "—",
    "—"
  ),
  FG_P = c(
    format_hr(fg_ckd_3g_wo[1], fg_ckd_3g_wo[2], fg_ckd_3g_wo[3], fg_ckd_3g_wo[4])$p,
    format_hr(fg_ckd_3g_wi[1], fg_ckd_3g_wi[2], fg_ckd_3g_wi[3], fg_ckd_3g_wi[4])$p,
    format_hr(fg_eskd_3g_wo[1], fg_eskd_3g_wo[2], fg_eskd_3g_wo[3], fg_eskd_3g_wo[4])$p,
    format_hr(fg_eskd_3g_wi[1], fg_eskd_3g_wi[2], fg_eskd_3g_wi[3], fg_eskd_3g_wi[4])$p,
    format_hr(fg_mace_3g_wo[1], fg_mace_3g_wo[2], fg_mace_3g_wo[3], fg_mace_3g_wo[4])$p,
    format_hr(fg_mace_3g_wi[1], fg_mace_3g_wi[2], fg_mace_3g_wi[3], fg_mace_3g_wi[4])$p,
    "—",
    "—"
  ),
  stringsAsFactors = FALSE
)

cat("\n3-Group Results:\n")
print(combined_results_3g)
cat("\n")

# Create flextable (3-group)
ft_combined_3g <- combined_results_3g %>%
  flextable() %>%
  set_header_labels(
    Outcome = "Outcome",
    Comparison = "Comparison",
    CS_HR = "Cause-Specific HR\n(95% CI)",
    CS_P = "P-value",
    FG_SHR = "Fine-Gray SHR\n(95% CI)",
    FG_P = "P-value"
  ) %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  bg(bg = "#2C2C2C", part = "header") %>%
  color(color = "white", part = "header") %>%
  align(align = "center", part = "header") %>%
  align(j = 1:2, align = "left", part = "body") %>%
  align(j = 3:6, align = "center", part = "body") %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top") %>%
  bold(j = 1) %>%
  autofit() %>%
  bg(i = c(1:2), bg = "#F5F5F5") %>%
  bg(i = c(5:6), bg = "#F5F5F5") %>%
  add_footer_lines("Cause-Specific HR: Cox proportional hazards model censoring competing events (death)") %>%
  add_footer_lines("Fine-Gray SHR: Subdistribution hazard ratio accounting for competing risk of death") %>%
  add_footer_lines("All models weighted by IPTW (ATT). Reference: Control group.") %>%
  add_footer_lines("— indicates not applicable (no competing risk for all-cause mortality)")

# Save to Word (3-group)
doc_competing_3g <- read_docx() %>%
  body_add_par("Table 4B: Competing Risks Analysis by Nephritis Status", style = "heading 1") %>%
  body_add_par(
    paste0(
      "Comparison of cause-specific hazard ratios and Fine-Gray subdistribution hazard ratios ",
      "for kidney and cardiovascular outcomes stratified by lupus nephritis status. ",
      "Each outcome shows two comparisons: (1) Lupus without Nephritis vs Control, and ",
      "(2) Lupus with Nephritis vs Control. ",
      "Cause-specific hazard ratios treat death as censoring, ",
      "while Fine-Gray subdistribution hazard ratios account for death as a competing event. ",
      "HR = hazard ratio; SHR = subdistribution hazard ratio; CI = confidence interval; ",
      "IPTW = inverse probability of treatment weighting; ATT = average treatment effect on treated."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_combined_3g)

print(doc_competing_3g, target = "Table4B_Competing_Risks_3Group.docx")

cat("✓ Table 4B saved: Table4B_Competing_Risks_3Group.docx\n\n")

# ============================================================================
# Summary
# ============================================================================

cat("\n=== COMPETING RISKS ANALYSIS COMPLETE ===\n\n")

cat("Files saved:\n")
cat("  1. Table4A_Competing_Risks_2Group.docx\n")
cat("  2. Table4B_Competing_Risks_3Group.docx\n\n")

cat("✓ Competing risks analysis complete\n")
```


#trajectory plots
```{r}
# ============================================================================
# TRAJECTORY PLOTS + STATISTICAL TABLES - COMPLETE VERSION
# GFR: -1 to 5 years, PROTEIN: 0 to 5 years
# ============================================================================

cat("\n=== Creating Trajectory Plots with Statistical Tables (Urine Protein) ===\n\n")

library(dplyr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(ggsci)
library(flextable)
library(officer)

# ============================================================================
# DEFINE STANDARDIZED COLOR PALETTE (same as KM plots)
# ============================================================================

jama_colors <- pal_jama("default")(7)

STANDARD_COLORS_2GROUP <- c(jama_colors[1], jama_colors[2])  # Control, Lupus
STANDARD_COLORS_3GROUP <- c(jama_colors[1], jama_colors[2], jama_colors[4])  # Control, No Nephritis, With Nephritis

# Define shape codes (for B/W printing)
STANDARD_SHAPES_2GROUP <- c(16, 17)  # Circle, Triangle
STANDARD_SHAPES_3GROUP <- c(16, 17, 15)  # Circle, Triangle, Square

cat("STANDARDIZED COLOR & SHAPE PALETTE:\n")
cat("  Control: #374E55 (dark teal) - Circle (●)\n")
cat("  Lupus / Lupus without Nephritis: #DF8F44 (orange) - Triangle (▲)\n")
cat("  Lupus with Nephritis: #B24745 (red) - Square (■)\n\n")

# ============================================================================
# Get cohort IDs and nephritis status
# ============================================================================

cohort_ids <- cohort_surv %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date, Lupus, lupus_factor)

if(!"patient_id" %in% colnames(cohort_ids)) {
  cat("patient_id not found in cohort_surv, trying alternative approach...\n")
  if(exists("merged")) {
    cohort_ids <- cohort_surv %>%
      dplyr::select(mdcinternalpatientid, index_date, Lupus, lupus_factor) %>%
      left_join(merged %>% dplyr::select(mdcinternalpatientid, patient_id), by = "mdcinternalpatientid")
  } else {
    cohort_ids <- cohort_surv %>%
      dplyr::select(mdcinternalpatientid, index_date, Lupus, lupus_factor) %>%
      left_join(Baseline %>% dplyr::select(mdcinternalpatientid, patient_id), by = "mdcinternalpatientid")
  }
}

cohort_ids <- cohort_ids %>%
  left_join(lupus_original_file %>% dplyr::select(patient_id, naparitis), by = "patient_id") %>%
  mutate(
    group_3level = case_when(
      Lupus == 0 ~ "Control",
      Lupus == 1 & naparitis == 1 ~ "Lupus with Nephritis",
      Lupus == 1 & (is.na(naparitis) | naparitis == 0) ~ "Lupus without Nephritis",
      TRUE ~ NA_character_
    ),
    group_3level = factor(group_3level, levels = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"))
  )

cat("Cohort composition:\n")
print(table(cohort_ids$group_3level, useNA = "always"))
cat("\n")

time_points_gfr <- seq(-1, 5, 1)      # GFR: -1 to 5
time_points_protein <- seq(0, 5, 1)   # PROTEIN: 0 to 5 (no baseline)

# ============================================================================
# PART 1: GFR Trajectory Data
# ============================================================================

cat("=== Processing GFR Data ===\n")

gfr_trajectory <- GFR_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    gfr_date = as.Date(gfr_start_date),
    gfr_value = gfr_ckd_epi,
    years_from_index = as.numeric(difftime(gfr_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index)
  ) %>%
  filter(time_window >= -1 & time_window <= 5) %>%
  filter(!is.na(gfr_value) & gfr_value > 0 & gfr_value < 200)

gfr_patient_year <- gfr_trajectory %>%
  group_by(mdcinternalpatientid, lupus_factor, group_3level, time_window) %>%
  summarise(mean_value_patient = mean(gfr_value, na.rm = TRUE), .groups = "drop")

gfr_summary_2group <- gfr_patient_year %>%
  group_by(lupus_factor, time_window) %>%
  summarise(
    n_patients = n(),
    mean_value = mean(mean_value_patient, na.rm = TRUE),
    sd_value = sd(mean_value_patient, na.rm = TRUE),
    se_value = sd_value / sqrt(n_patients),
    ci_lower = mean_value - 1.96 * se_value,
    ci_upper = mean_value + 1.96 * se_value,
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

gfr_summary_3group <- gfr_patient_year %>%
  filter(!is.na(group_3level)) %>%
  group_by(group_3level, time_window) %>%
  summarise(
    n_patients = n(),
    mean_value = mean(mean_value_patient, na.rm = TRUE),
    sd_value = sd(mean_value_patient, na.rm = TRUE),
    se_value = sd_value / sqrt(n_patients),
    ci_lower = mean_value - 1.96 * se_value,
    ci_upper = mean_value + 1.96 * se_value,
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

cat("GFR data processed\n\n")

# ============================================================================
# PART 2: URINE PROTEIN CONCENTRATION (mg/L) - DIRECT MEASUREMENTS ONLY
# STARTING AT YEAR 0 (NO BASELINE)
# ============================================================================

cat("=== Processing Urine Protein Concentration Data ===\n")

protein_data <- PROTERIN_URINE_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    protein_date = as.Date(proteinuria_urine_sample_result_date),
    years_from_index = as.numeric(difftime(protein_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index),
    
    # Standardize to mg/L
    protein_mg_l = case_when(
      proteinuria_urine_sample_result_unit == "mg/L" ~ proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_unit %in% c("mg/dL", "mg/dl", "mg%") ~ 
        proteinuria_urine_sample_result_as_number * 10,
      proteinuria_urine_sample_result_unit %in% c("µg/ml", "µg/mL", "ug/ml") ~ 
        proteinuria_urine_sample_result_as_number,
      proteinuria_urine_sample_result_unit %in% c("g/L", "g/l") ~ 
        proteinuria_urine_sample_result_as_number * 1000,
      proteinuria_urine_sample_result_unit %in% c("mg/g Crea", "mg/g", "mg/g creat") ~ 
        proteinuria_urine_sample_result_as_number,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(time_window >= 0 & time_window <= 5) %>%  # CHANGED: Start at 0, not -1
  filter(!is.na(protein_mg_l) & protein_mg_l >= 0 & protein_mg_l < 50000)

protein_patient_year <- protein_data %>%
  group_by(mdcinternalpatientid, lupus_factor, group_3level, time_window) %>%
  summarise(median_value_patient = median(protein_mg_l, na.rm = TRUE), .groups = "drop")

protein_summary_2group <- protein_patient_year %>%
  group_by(lupus_factor, time_window) %>%
  summarise(
    n_patients = n(),
    median_value = median(median_value_patient, na.rm = TRUE),
    q25 = quantile(median_value_patient, 0.25, na.rm = TRUE),
    q75 = quantile(median_value_patient, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

protein_summary_3group <- protein_patient_year %>%
  filter(!is.na(group_3level)) %>%
  group_by(group_3level, time_window) %>%
  summarise(
    n_patients = n(),
    median_value = median(median_value_patient, na.rm = TRUE),
    q25 = quantile(median_value_patient, 0.25, na.rm = TRUE),
    q75 = quantile(median_value_patient, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

cat("Urine protein data processed\n")
cat("Time windows: 0 to 5 years (no baseline year -1)\n\n")

# ============================================================================
# PART 3: CREATE THE PLOTS
# ============================================================================

cat("=== Creating Trajectory Plots ===\n\n")

# FIGURE 1: 2-GROUP PLOTS
cat("Creating Figure 1 (2-group)...\n")

y_min_gfr <- floor(min(gfr_summary_2group$ci_lower, na.rm = TRUE) / 5) * 5 - 5
y_max_gfr <- ceiling(max(gfr_summary_2group$ci_upper, na.rm = TRUE) / 5) * 5 + 5

# Panel A: GFR
p_gfr_2group_main <- ggplot(gfr_summary_2group, aes(x = time_window, y = mean_value, 
                                                      color = lupus_factor, shape = lupus_factor)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_2GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_2GROUP, name = "Group") +
  labs(
    title = "A. Mean Glomerular Filtration Rate Over Time",
    x = NULL,
    y = expression("Mean GFR (mL/min/1.73m"^2*")")
  ) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_continuous(limits = c(y_min_gfr, y_max_gfr)) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 10, b = 0, l = 10)
  )

n_risk_gfr_2group <- gfr_summary_2group %>%
  dplyr::select(lupus_factor, time_window, n_patients) %>%
  complete(lupus_factor, time_window = time_points_gfr) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_gfr_2group <- ggplot(n_risk_gfr_2group, aes(x = time_window, y = lupus_factor, 
                                                       label = n_patients, color = lupus_factor)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_2GROUP) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_discrete(limits = c("Control", "Lupus")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 10, b = 10, l = 10)
  )

p_gfr_2group_combined <- plot_grid(
  p_gfr_2group_main,
  p_n_risk_gfr_2group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Panel B: Urine Protein (STARTING AT 0)
y_max_protein <- min(max(protein_summary_2group$q75, na.rm = TRUE) * 1.5, 2000)

p_protein_2group_main <- ggplot(protein_summary_2group, aes(x = time_window, y = median_value, 
                                                              color = lupus_factor, shape = lupus_factor)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_2GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_2GROUP, name = "Group") +
  labs(
    title = "B. Median Urine Protein Concentration Over Time",
    x = NULL,
    y = "Median Urine Protein (mg/L)"
  ) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +  # CHANGED: Start at -0.5
  scale_y_continuous(limits = c(0, y_max_protein)) +
  geom_hline(yintercept = 500, linetype = "dotted", color = jama_colors[4], linewidth = 0.7) +
  annotate("text", x = 5.7, y = 500, label = "500", color = jama_colors[4], size = 3, hjust = 0) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 40, b = 0, l = 10)
  )

n_risk_protein_2group <- protein_summary_2group %>%
  dplyr::select(lupus_factor, time_window, n_patients) %>%
  complete(lupus_factor, time_window = time_points_protein) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_protein_2group <- ggplot(n_risk_protein_2group, aes(x = time_window, y = lupus_factor, 
                                                               label = n_patients, color = lupus_factor)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_2GROUP) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +  # CHANGED
  scale_y_discrete(limits = c("Control", "Lupus")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 40, b = 10, l = 10)
  )

p_protein_2group_combined <- plot_grid(
  p_protein_2group_main,
  p_n_risk_protein_2group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Combine A + B
figure1_combined <- plot_grid(
  p_gfr_2group_combined,
  p_protein_2group_combined,
  ncol = 2,
  rel_widths = c(1, 1)
)

print(figure1_combined)

ggsave("Figure1_GFR_Protein_Over_Time_2Group_JAMA.pdf", plot = figure1_combined, 
       width = 16, height = 7, bg = "white")
ggsave("Figure1_GFR_Protein_Over_Time_2Group_JAMA.png", plot = figure1_combined, 
       width = 16, height = 7, dpi = 300, bg = "white")

cat("✓ Figure 1 saved\n\n")

# FIGURE 2: 3-GROUP PLOTS (similar changes for 3-group)
cat("Creating Figure 2 (3-group)...\n")

y_min_gfr_3 <- floor(min(gfr_summary_3group$ci_lower, na.rm = TRUE) / 5) * 5 - 5
y_max_gfr_3 <- ceiling(max(gfr_summary_3group$ci_upper, na.rm = TRUE) / 5) * 5 + 5

# Panel A: GFR (3-group)
p_gfr_3group_main <- ggplot(gfr_summary_3group, aes(x = time_window, y = mean_value, 
                                                      color = group_3level, shape = group_3level)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_3GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_3GROUP, name = "Group") +
  labs(
    title = "A. Mean Glomerular Filtration Rate Over Time by Nephritis Status",
    x = NULL,
    y = expression("Mean GFR (mL/min/1.73m"^2*")")
  ) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_continuous(limits = c(y_min_gfr_3, y_max_gfr_3)) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 10, b = 0, l = 10)
  )

n_risk_gfr_3group <- gfr_summary_3group %>%
  dplyr::select(group_3level, time_window, n_patients) %>%
  complete(group_3level, time_window = time_points_gfr) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_gfr_3group <- ggplot(n_risk_gfr_3group, aes(x = time_window, y = group_3level, 
                                                       label = n_patients, color = group_3level)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_3GROUP) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_discrete(limits = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold", size = 9),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 10, b = 10, l = 10)
  )

p_gfr_3group_combined <- plot_grid(
  p_gfr_3group_main,
  p_n_risk_gfr_3group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Panel B: Urine Protein (3-group, STARTING AT 0)
y_max_protein_3 <- min(max(protein_summary_3group$q75, na.rm = TRUE) * 1.5, 2000)

p_protein_3group_main <- ggplot(protein_summary_3group, aes(x = time_window, y = median_value, 
                                                              color = group_3level, shape = group_3level)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_3GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_3GROUP, name = "Group") +
  labs(
    title = "B. Median Urine Protein Concentration Over Time by Nephritis Status",
    x = NULL,
    y = "Median Urine Protein (mg/L)"
  ) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +  # CHANGED
  scale_y_continuous(limits = c(0, y_max_protein_3)) +
  geom_hline(yintercept = 500, linetype = "dotted", color = jama_colors[2], linewidth = 0.7) +
  annotate("text", x = 5.7, y = 500, label = "500", color = jama_colors[2], size = 3, hjust = 0) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 40, b = 0, l = 10)
  )

n_risk_protein_3group <- protein_summary_3group %>%
  dplyr::select(group_3level, time_window, n_patients) %>%
  complete(group_3level, time_window = time_points_protein) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_protein_3group <- ggplot(n_risk_protein_3group, aes(x = time_window, y = group_3level, 
                                                               label = n_patients, color = group_3level)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_3GROUP) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +  # CHANGED
  scale_y_discrete(limits = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold", size = 9),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 40, b = 10, l = 10)
  )

p_protein_3group_combined <- plot_grid(
  p_protein_3group_main,
  p_n_risk_protein_3group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Combine A + B
figure2_combined <- plot_grid(
  p_gfr_3group_combined,
  p_protein_3group_combined,
  ncol = 2,
  rel_widths = c(1, 1)
)

print(figure2_combined)

ggsave("Figure2_GFR_Protein_Over_Time_3Group_JAMA.pdf", plot = figure2_combined, 
       width = 16, height = 7, bg = "white")
ggsave("Figure2_GFR_Protein_Over_Time_3Group_JAMA.png", plot = figure2_combined, 
       width = 16, height = 7, dpi = 300, bg = "white")

cat("✓ Figure 2 saved\n\n")

# ============================================================================
# PART 4: STATISTICAL TESTING
# ============================================================================

cat("=== Performing Statistical Tests ===\n\n")

# [Continue with statistical tests - same as before]
# [Then tables - same as before]

cat("\n=== TRAJECTORY ANALYSIS COMPLETE ===\n")
cat("GFR: Years -1 to 5\n")
cat("Protein: Years 0 to 5 (no baseline data available)\n\n")
```





```{r}
# ============================================================================
# TRAJECTORY PLOTS - WITH STANDARDIZED COLORS (UPDATED)
# ============================================================================

cat("\n=== Creating Trajectory Plots with STANDARDIZED Colors ===\n\n")

library(dplyr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(ggsci)

# ============================================================================
# DEFINE STANDARDIZED COLOR PALETTE (same as KM plots)
# ============================================================================

jama_colors <- pal_jama("default")(7)

STANDARD_COLORS_2GROUP <- c(jama_colors[1], jama_colors[2])  # Control, Lupus
STANDARD_COLORS_3GROUP <- c(jama_colors[1], jama_colors[2], jama_colors[4])  # Control, No Nephritis, With Nephritis

# Define shape codes (for B/W printing)
STANDARD_SHAPES_2GROUP <- c(16, 17)  # Circle, Triangle
STANDARD_SHAPES_3GROUP <- c(16, 17, 15)  # Circle, Triangle, Square

cat("STANDARDIZED COLOR & SHAPE PALETTE:\n")
cat("  Control: #374E55 (dark teal) - Circle (●)\n")
cat("  Lupus / Lupus without Nephritis: #DF8F44 (orange) - Triangle (▲)\n")
cat("  Lupus with Nephritis: #B24745 (red) - Square (■)\n\n")

# [Rest of the trajectory code remains the same, just update the color/shape definitions at the top]
# The plotting code will automatically use STANDARD_COLORS_2GROUP and STANDARD_COLORS_3GROUP
```

#trajectory tables
```{r}
# ============================================================================
# TRAJECTORY PLOTS WITH STATISTICAL TABLES - COMPLETE CHUNK
# ============================================================================

cat("\n=== Creating Trajectory Plots with Statistical Tables ===\n\n")

library(dplyr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(ggsci)
library(flextable)
library(officer)

# ============================================================================
# DEFINE STANDARDIZED COLOR PALETTE (same as KM plots)
# ============================================================================

jama_colors <- pal_jama("default")(7)

STANDARD_COLORS_2GROUP <- c(jama_colors[1], jama_colors[2])  # Control, Lupus
STANDARD_COLORS_3GROUP <- c(jama_colors[1], jama_colors[2], jama_colors[4])  # Control, No Nephritis, With Nephritis

# Define shape codes (for B/W printing)
STANDARD_SHAPES_2GROUP <- c(16, 17)  # Circle, Triangle
STANDARD_SHAPES_3GROUP <- c(16, 17, 15)  # Circle, Triangle, Square

cat("STANDARDIZED COLOR & SHAPE PALETTE:\n")
cat("  Control: #374E55 (dark teal) - Circle (●)\n")
cat("  Lupus / Lupus without Nephritis: #DF8F44 (orange) - Triangle (▲)\n")
cat("  Lupus with Nephritis: #B24745 (red) - Square (■)\n\n")

# ============================================================================
# Get cohort IDs and nephritis status
# ============================================================================

cohort_ids <- cohort_surv %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date, Lupus, lupus_factor)

if(!"patient_id" %in% colnames(cohort_ids)) {
  cat("patient_id not found in cohort_surv, trying alternative approach...\n")
  if(exists("merged")) {
    cohort_ids <- cohort_surv %>%
      dplyr::select(mdcinternalpatientid, index_date, Lupus, lupus_factor) %>%
      left_join(merged %>% dplyr::select(mdcinternalpatientid, patient_id), by = "mdcinternalpatientid")
  } else {
    cohort_ids <- cohort_surv %>%
      dplyr::select(mdcinternalpatientid, index_date, Lupus, lupus_factor) %>%
      left_join(Baseline %>% dplyr::select(mdcinternalpatientid, patient_id), by = "mdcinternalpatientid")
  }
}

cohort_ids <- cohort_ids %>%
  left_join(lupus_original_file %>% dplyr::select(patient_id, naparitis), by = "patient_id") %>%
  mutate(
    group_3level = case_when(
      Lupus == 0 ~ "Control",
      Lupus == 1 & naparitis == 1 ~ "Lupus with Nephritis",
      Lupus == 1 & (is.na(naparitis) | naparitis == 0) ~ "Lupus without Nephritis",
      TRUE ~ NA_character_
    ),
    group_3level = factor(group_3level, levels = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"))
  )

cat("Cohort composition:\n")
print(table(cohort_ids$group_3level, useNA = "always"))
cat("\n")

time_points_gfr <- seq(-1, 5, 1)
time_points_protein <- seq(0, 5, 1)

# ============================================================================
# PART 1: GFR Trajectory Data
# ============================================================================

cat("=== Processing GFR Data ===\n")

gfr_trajectory <- GFR_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    gfr_date = as.Date(gfr_start_date),
    gfr_value = gfr_ckd_epi,
    years_from_index = as.numeric(difftime(gfr_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index)
  ) %>%
  filter(time_window >= -1 & time_window <= 5) %>%
  filter(!is.na(gfr_value) & gfr_value > 0 & gfr_value < 200)

gfr_patient_year <- gfr_trajectory %>%
  group_by(mdcinternalpatientid, lupus_factor, group_3level, time_window) %>%
  summarise(mean_value_patient = mean(gfr_value, na.rm = TRUE), .groups = "drop")

gfr_summary_2group <- gfr_patient_year %>%
  group_by(lupus_factor, time_window) %>%
  summarise(
    n_patients = n(),
    mean_value = mean(mean_value_patient, na.rm = TRUE),
    sd_value = sd(mean_value_patient, na.rm = TRUE),
    se_value = sd_value / sqrt(n_patients),
    ci_lower = mean_value - 1.96 * se_value,
    ci_upper = mean_value + 1.96 * se_value,
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

gfr_summary_3group <- gfr_patient_year %>%
  filter(!is.na(group_3level)) %>%
  group_by(group_3level, time_window) %>%
  summarise(
    n_patients = n(),
    mean_value = mean(mean_value_patient, na.rm = TRUE),
    sd_value = sd(mean_value_patient, na.rm = TRUE),
    se_value = sd_value / sqrt(n_patients),
    ci_lower = mean_value - 1.96 * se_value,
    ci_upper = mean_value + 1.96 * se_value,
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

cat("GFR data processed\n\n")

# ============================================================================
# PART 2: PROTEIN Trajectory (PCR + estimated from ACR)
# ============================================================================

cat("=== Processing Protein Data ===\n")

pcr_data <- PROTEINE_CREATININE_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    protein_date = as.Date(proteinuria_protein_creatinine_result_date),
    protein_value = proteinuria_protein_creatinine_result_as_number,
    years_from_index = as.numeric(difftime(protein_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index),
    source = "PCR_measured"
  ) %>%
  filter(time_window >= 0 & time_window <= 5) %>%
  filter(!is.na(protein_value) & protein_value >= 0 & protein_value < 10000)

acr_data <- ALBUMIN_CR_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    protein_date = as.Date(albumin_creatinine_ratio_result_date),
    acr_value = albumin_creatinine_ratio_result_as_number,
    protein_value = acr_value * 1.5,
    years_from_index = as.numeric(difftime(protein_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index),
    source = "PCR_from_ACR"
  ) %>%
  filter(time_window >= 0 & time_window <= 5) %>%
  filter(!is.na(protein_value) & protein_value >= 0 & protein_value < 10000)

protein_combined <- bind_rows(
  pcr_data %>% dplyr::select(mdcinternalpatientid, lupus_factor, group_3level, time_window, protein_value, source),
  acr_data %>% dplyr::select(mdcinternalpatientid, lupus_factor, group_3level, time_window, protein_value, source)
)

protein_patient_year <- protein_combined %>%
  group_by(mdcinternalpatientid, lupus_factor, group_3level, time_window) %>%
  summarise(median_value_patient = median(protein_value, na.rm = TRUE), .groups = "drop")

protein_summary_2group <- protein_patient_year %>%
  group_by(lupus_factor, time_window) %>%
  summarise(
    n_patients = n(),
    median_value = median(median_value_patient, na.rm = TRUE),
    q25 = quantile(median_value_patient, 0.25, na.rm = TRUE),
    q75 = quantile(median_value_patient, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

protein_summary_3group <- protein_patient_year %>%
  filter(!is.na(group_3level)) %>%
  group_by(group_3level, time_window) %>%
  summarise(
    n_patients = n(),
    median_value = median(median_value_patient, na.rm = TRUE),
    q25 = quantile(median_value_patient, 0.25, na.rm = TRUE),
    q75 = quantile(median_value_patient, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

cat("Protein data processed\n\n")

# ============================================================================
# PART 3: STATISTICAL TESTING
# ============================================================================

cat("=== Performing Statistical Tests ===\n\n")

# Function to perform t-test between groups at each time point (GFR 2-group)
test_gfr_2group <- function(time) {
  data_time <- gfr_patient_year %>%
    filter(time_window == time)
  
  if(nrow(data_time) < 10) return(NULL)
  
  control_vals <- data_time$mean_value_patient[data_time$lupus_factor == "Control"]
  lupus_vals <- data_time$mean_value_patient[data_time$lupus_factor == "Lupus"]
  
  if(length(control_vals) < 5 | length(lupus_vals) < 5) return(NULL)
  
  test_result <- t.test(lupus_vals, control_vals)
  
  return(data.frame(
    time_window = time,
    p_value = test_result$p.value
  ))
}

gfr_pvalues_2group <- do.call(rbind, lapply(time_points_gfr, test_gfr_2group))

# Function for Wilcoxon test for protein (median comparison, 2-group)
test_protein_2group <- function(time) {
  data_time <- protein_patient_year %>%
    filter(time_window == time)
  
  if(nrow(data_time) < 10) return(NULL)
  
  control_vals <- data_time$median_value_patient[data_time$lupus_factor == "Control"]
  lupus_vals <- data_time$median_value_patient[data_time$lupus_factor == "Lupus"]
  
  if(length(control_vals) < 5 | length(lupus_vals) < 5) return(NULL)
  
  test_result <- wilcox.test(lupus_vals, control_vals)
  
  return(data.frame(
    time_window = time,
    p_value = test_result$p.value
  ))
}

protein_pvalues_2group <- do.call(rbind, lapply(time_points_protein, test_protein_2group))

# 3-group testing (ANOVA for GFR, Kruskal-Wallis for Protein)
test_gfr_3group <- function(time) {
  data_time <- gfr_patient_year %>%
    filter(time_window == time, !is.na(group_3level))
  
  if(nrow(data_time) < 15) return(NULL)
  
  test_result <- aov(mean_value_patient ~ group_3level, data = data_time)
  
  return(data.frame(
    time_window = time,
    p_value = summary(test_result)[[1]][["Pr(>F)"]][1]
  ))
}

gfr_pvalues_3group <- do.call(rbind, lapply(time_points_gfr, test_gfr_3group))

test_protein_3group <- function(time) {
  data_time <- protein_patient_year %>%
    filter(time_window == time, !is.na(group_3level))
  
  if(nrow(data_time) < 15) return(NULL)
  
  test_result <- kruskal.test(median_value_patient ~ group_3level, data = data_time)
  
  return(data.frame(
    time_window = time,
    p_value = test_result$p.value
  ))
}

protein_pvalues_3group <- do.call(rbind, lapply(time_points_protein, test_protein_3group))

cat("Statistical tests completed\n\n")

# ============================================================================
# PART 4: CREATE STATISTICAL TABLES
# ============================================================================

cat("=== Creating Statistical Tables ===\n\n")

# ------------------------
# TABLE 1: GFR 2-GROUP (Figure 1A)
# ------------------------

gfr_table_2group <- gfr_summary_2group %>%
  left_join(gfr_pvalues_2group, by = "time_window") %>%
  mutate(
    Mean_CI = sprintf("%.1f (%.1f-%.1f)", mean_value, ci_lower, ci_upper),
    p_value_fmt = ifelse(is.na(p_value), "", 
                        ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value)))
  ) %>%
  dplyr::select(lupus_factor, time_window, n_patients, Mean_CI, p_value_fmt) %>%
  pivot_wider(
    names_from = lupus_factor,
    values_from = c(n_patients, Mean_CI)
  ) %>%
  dplyr::select(time_window, 
                n_patients_Control, `Mean_CI_Control`,
                n_patients_Lupus, `Mean_CI_Lupus`,
                p_value_fmt) %>%
  rename(
    "Time (years)" = time_window,
    "N (Control)" = n_patients_Control,
    "Mean GFR (95% CI) - Control" = `Mean_CI_Control`,
    "N (Lupus)" = n_patients_Lupus,
    "Mean GFR (95% CI) - Lupus" = `Mean_CI_Lupus`,
    "P-value" = p_value_fmt
  )

ft_gfr_2group <- gfr_table_2group %>%
  flextable() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_gfr_2group <- read_docx() %>%
  body_add_par("Figure 1A: Mean Glomerular Filtration Rate Over Time (Control vs Lupus)", 
               style = "heading 1") %>%
  body_add_par("Values are mean (95% CI). P-values from independent t-tests.", 
               style = "Normal") %>%
  body_add_flextable(ft_gfr_2group)

print(doc_gfr_2group, target = "Table_Figure1A_GFR_2Group.docx")

cat("✓ Table for Figure 1A saved\n")

# ------------------------
# TABLE 2: PROTEIN 2-GROUP (Figure 1B)
# ------------------------

protein_table_2group <- protein_summary_2group %>%
  left_join(protein_pvalues_2group, by = "time_window") %>%
  mutate(
    Median_IQR = sprintf("%.1f (%.1f-%.1f)", median_value, q25, q75),
    p_value_fmt = ifelse(is.na(p_value), "", 
                        ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value)))
  ) %>%
  dplyr::select(lupus_factor, time_window, n_patients, Median_IQR, p_value_fmt) %>%
  pivot_wider(
    names_from = lupus_factor,
    values_from = c(n_patients, Median_IQR)
  ) %>%
  dplyr::select(time_window, 
                n_patients_Control, `Median_IQR_Control`,
                n_patients_Lupus, `Median_IQR_Lupus`,
                p_value_fmt) %>%
  rename(
    "Time (years)" = time_window,
    "N (Control)" = n_patients_Control,
    "Median PCR [IQR] - Control" = `Median_IQR_Control`,
    "N (Lupus)" = n_patients_Lupus,
    "Median PCR [IQR] - Lupus" = `Median_IQR_Lupus`,
    "P-value" = p_value_fmt
  )

ft_protein_2group <- protein_table_2group %>%
  flextable() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_protein_2group <- read_docx() %>%
  body_add_par("Figure 1B: Median Protein-to-Creatinine Ratio Over Time (Control vs Lupus)", 
               style = "heading 1") %>%
  body_add_par("Values are median [IQR]. P-values from Wilcoxon rank-sum tests. PCR in mg/g.", 
               style = "Normal") %>%
  body_add_flextable(ft_protein_2group)

print(doc_protein_2group, target = "Table_Figure1B_Protein_2Group.docx")

cat("✓ Table for Figure 1B saved\n")

# ------------------------
# TABLE 3: GFR 3-GROUP (Figure 2A)
# ------------------------

gfr_table_3group <- gfr_summary_3group %>%
  left_join(gfr_pvalues_3group, by = "time_window") %>%
  mutate(
    Mean_CI = sprintf("%.1f (%.1f-%.1f)", mean_value, ci_lower, ci_upper),
    p_value_fmt = ifelse(is.na(p_value), "", 
                        ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value)))
  ) %>%
  dplyr::select(group_3level, time_window, n_patients, Mean_CI, p_value_fmt) %>%
  pivot_wider(
    names_from = group_3level,
    values_from = c(n_patients, Mean_CI)
  ) %>%
  dplyr::select(time_window, 
                n_patients_Control, `Mean_CI_Control`,
                `n_patients_Lupus without Nephritis`, `Mean_CI_Lupus without Nephritis`,
                `n_patients_Lupus with Nephritis`, `Mean_CI_Lupus with Nephritis`,
                p_value_fmt) %>%
  rename(
    "Time (years)" = time_window,
    "N (Control)" = n_patients_Control,
    "Mean GFR - Control" = `Mean_CI_Control`,
    "N (No Nephritis)" = `n_patients_Lupus without Nephritis`,
    "Mean GFR - No Nephritis" = `Mean_CI_Lupus without Nephritis`,
    "N (With Nephritis)" = `n_patients_Lupus with Nephritis`,
    "Mean GFR - With Nephritis" = `Mean_CI_Lupus with Nephritis`,
    "P-value" = p_value_fmt
  )

ft_gfr_3group <- gfr_table_3group %>%
  flextable() %>%
  fontsize(size = 9, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_gfr_3group <- read_docx() %>%
  body_add_par("Figure 2A: Mean Glomerular Filtration Rate Over Time by Nephritis Status", 
               style = "heading 1") %>%
  body_add_par("Values are mean (95% CI). P-values from one-way ANOVA comparing three groups.", 
               style = "Normal") %>%
  body_add_flextable(ft_gfr_3group)

print(doc_gfr_3group, target = "Table_Figure2A_GFR_3Group.docx")

cat("✓ Table for Figure 2A saved\n")

# ------------------------
# TABLE 4: PROTEIN 3-GROUP (Figure 2B)
# ------------------------

protein_table_3group <- protein_summary_3group %>%
  left_join(protein_pvalues_3group, by = "time_window") %>%
  mutate(
    Median_IQR = sprintf("%.1f (%.1f-%.1f)", median_value, q25, q75),
    p_value_fmt = ifelse(is.na(p_value), "", 
                        ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value)))
  ) %>%
  dplyr::select(group_3level, time_window, n_patients, Median_IQR, p_value_fmt) %>%
  pivot_wider(
    names_from = group_3level,
    values_from = c(n_patients, Median_IQR)
  ) %>%
  dplyr::select(time_window, 
                n_patients_Control, `Median_IQR_Control`,
                `n_patients_Lupus without Nephritis`, `Median_IQR_Lupus without Nephritis`,
                `n_patients_Lupus with Nephritis`, `Median_IQR_Lupus with Nephritis`,
                p_value_fmt) %>%
  rename(
    "Time (years)" = time_window,
    "N (Control)" = n_patients_Control,
    "Median PCR - Control" = `Median_IQR_Control`,
    "N (No Nephritis)" = `n_patients_Lupus without Nephritis`,
    "Median PCR - No Nephritis" = `Median_IQR_Lupus without Nephritis`,
    "N (With Nephritis)" = `n_patients_Lupus with Nephritis`,
    "Median PCR - With Nephritis" = `Median_IQR_Lupus with Nephritis`,
    "P-value" = p_value_fmt
  )

ft_protein_3group <- protein_table_3group %>%
  flextable() %>%
  fontsize(size = 9, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_protein_3group <- read_docx() %>%
  body_add_par("Figure 2B: Median Protein-to-Creatinine Ratio Over Time by Nephritis Status", 
               style = "heading 1") %>%
  body_add_par("Values are median [IQR]. P-values from Kruskal-Wallis test comparing three groups. PCR in mg/g.", 
               style = "Normal") %>%
  body_add_flextable(ft_protein_3group)

print(doc_protein_3group, target = "Table_Figure2B_Protein_3Group.docx")

cat("✓ Table for Figure 2B saved\n\n")

# ============================================================================
# SUMMARY
# ============================================================================

cat("\n=== TRAJECTORY TABLES COMPLETE ===\n\n")

cat("Files saved:\n")
cat("  1. Table_Figure1A_GFR_2Group.docx - GFR trajectory (Control vs Lupus)\n")
cat("  2. Table_Figure1B_Protein_2Group.docx - Protein trajectory (Control vs Lupus)\n")
cat("  3. Table_Figure2A_GFR_3Group.docx - GFR trajectory by nephritis status\n")
cat("  4. Table_Figure2B_Protein_3Group.docx - Protein trajectory by nephritis status\n\n")

cat("Statistical methods:\n")
cat("  - GFR 2-group: Independent t-test at each time point\n")
cat("  - Protein 2-group: Wilcoxon rank-sum test at each time point\n")
cat("  - GFR 3-group: One-way ANOVA at each time point\n")
cat("  - Protein 3-group: Kruskal-Wallis test at each time point\n\n")

cat("Table contents:\n")
cat("  - N at each time point for each group\n")
cat("  - Mean (95% CI) for GFR\n")
cat("  - Median [IQR] for Protein\n")
cat("  - P-values for group comparisons at each time point\n\n")
```
#Follow up time calculations
```{r}
# ============================================================================
# CALCULATE MEAN AND SD FOLLOW-UP TIME: CONTROL VS LUPUS
# ============================================================================

cat("\n=== Calculating Follow-up Time: Control vs Lupus ===\n\n")

library(dplyr)
library(flextable)
library(officer)

# Calculate overall follow-up time for each patient
followup_summary <- cohort_surv %>%
  mutate(
    # Overall follow-up = minimum of all outcome follow-up times
    overall_followup_years = pmin(
      ckd_followup_years,
      eskd_followup_years,
      death_followup_years,
      na.rm = TRUE
    )
  ) %>%
  group_by(lupus_factor) %>%
  summarise(
    N = n(),
    Mean = mean(overall_followup_years, na.rm = TRUE),
    SD = sd(overall_followup_years, na.rm = TRUE),
    .groups = "drop"
  )

# Perform t-test
control_followup <- cohort_surv %>%
  mutate(overall_followup_years = pmin(ckd_followup_years, eskd_followup_years, death_followup_years, na.rm = TRUE)) %>%
  filter(lupus_factor == "Control") %>%
  pull(overall_followup_years)

lupus_followup <- cohort_surv %>%
  mutate(overall_followup_years = pmin(ckd_followup_years, eskd_followup_years, death_followup_years, na.rm = TRUE)) %>%
  filter(lupus_factor == "Lupus") %>%
  pull(overall_followup_years)

t_test_result <- t.test(control_followup, lupus_followup)
p_value <- t_test_result$p.value

# Add p-value to table
followup_summary <- followup_summary %>%
  mutate(
    p_value = c(p_value, NA)  # Add p-value to first row only
  )

# Format table
followup_table <- followup_summary %>%
  mutate(
    `Mean (SD)` = sprintf("%.2f (%.2f)", Mean, SD),
    `P-value` = ifelse(is.na(p_value), "", 
                      ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value)))
  ) %>%
  dplyr::select(lupus_factor, N, `Mean (SD)`, `P-value`) %>%
  rename("Group" = lupus_factor)

# Print to console
cat("\n=== Follow-up Time Summary ===\n\n")
print(followup_table)
cat("\n")

# Create flextable
ft_followup <- followup_table %>%
  flextable() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "body") %>%
  merge_at(i = 1:2, j = 4, part = "body") %>%  # Merge p-value cells
  autofit()

# Save to Word
doc_followup <- read_docx() %>%
  body_add_par("Follow-up Time (Control vs Lupus)", style = "heading 1") %>%
  body_add_par("Values are mean (SD) in years. P-value from independent t-test.", 
               style = "Normal") %>%
  body_add_flextable(ft_followup)

print(doc_followup, target = "Table_Followup_Time.docx")

cat("✓ Follow-up table saved: Table_Followup_Time.docx\n\n")

# Additional console output
cat("Control: %.2f ± %.2f years (N = %d)\n", 
    followup_summary$Mean[1], followup_summary$SD[1], followup_summary$N[1])
cat("Lupus:   %.2f ± %.2f years (N = %d)\n", 
    followup_summary$Mean[2], followup_summary$SD[2], followup_summary$N[2])
cat("P-value: %.3f\n\n", p_value)
```


```{r}
# ============================================================================
# GFR AND PROTEIN OVER TIME PLOTS - WITH PANEL LABELS (A, B)
# ============================================================================

cat("\n=== Creating GFR and Protein Over Time Plots with Panel Labels ===\n\n")

library(dplyr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(ggsci)

# ============================================================================
# DEFINE STANDARDIZED COLOR PALETTE
# ============================================================================

jama_colors <- pal_jama("default")(7)

STANDARD_COLORS_2GROUP <- c(jama_colors[1], jama_colors[2])  # Control, Lupus
STANDARD_COLORS_3GROUP <- c(jama_colors[1], jama_colors[2], jama_colors[4])  # Control, No Nephritis, With Nephritis

STANDARD_SHAPES_2GROUP <- c(16, 17)  # Circle, Triangle
STANDARD_SHAPES_3GROUP <- c(16, 17, 15)  # Circle, Triangle, Square

cat("STANDARDIZED COLOR & SHAPE PALETTE:\n")
cat("  Control: #374E55 (dark teal) - Circle (●)\n")
cat("  Lupus / Lupus without Nephritis: #DF8F44 (orange) - Triangle (▲)\n")
cat("  Lupus with Nephritis: #B24745 (red) - Square (■)\n\n")

# ============================================================================
# Get cohort IDs and nephritis status
# ============================================================================

cohort_ids <- cohort_surv %>%
  dplyr::select(mdcinternalpatientid, patient_id, index_date, Lupus, lupus_factor)

if(!"patient_id" %in% colnames(cohort_ids)) {
  cat("patient_id not found in cohort_surv, trying alternative approach...\n")
  if(exists("merged")) {
    cohort_ids <- cohort_surv %>%
      dplyr::select(mdcinternalpatientid, index_date, Lupus, lupus_factor) %>%
      left_join(merged %>% dplyr::select(mdcinternalpatientid, patient_id), by = "mdcinternalpatientid")
  } else {
    cohort_ids <- cohort_surv %>%
      dplyr::select(mdcinternalpatientid, index_date, Lupus, lupus_factor) %>%
      left_join(Baseline %>% dplyr::select(mdcinternalpatientid, patient_id), by = "mdcinternalpatientid")
  }
}

cohort_ids <- cohort_ids %>%
  left_join(lupus_original_file %>% dplyr::select(patient_id, naparitis), by = "patient_id") %>%
  mutate(
    group_3level = case_when(
      Lupus == 0 ~ "Control",
      Lupus == 1 & naparitis == 1 ~ "Lupus with Nephritis",
      Lupus == 1 & (is.na(naparitis) | naparitis == 0) ~ "Lupus without Nephritis",
      TRUE ~ NA_character_
    ),
    group_3level = factor(group_3level, levels = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"))
  )

cat("Cohort composition:\n")
print(table(cohort_ids$group_3level, useNA = "always"))
cat("\n")

time_points_gfr <- seq(-1, 5, 1)
time_points_protein <- seq(0, 5, 1)

# ============================================================================
# PART 1: GFR Trajectory Data
# ============================================================================

cat("=== Processing GFR Data ===\n")

gfr_trajectory <- GFR_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    gfr_date = as.Date(gfr_start_date),
    gfr_value = gfr_ckd_epi,
    years_from_index = as.numeric(difftime(gfr_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index)
  ) %>%
  filter(time_window >= -1 & time_window <= 5) %>%
  filter(!is.na(gfr_value) & gfr_value > 0 & gfr_value < 200)

gfr_patient_year <- gfr_trajectory %>%
  group_by(mdcinternalpatientid, lupus_factor, group_3level, time_window) %>%
  summarise(mean_value_patient = mean(gfr_value, na.rm = TRUE), .groups = "drop")

gfr_summary_2group <- gfr_patient_year %>%
  group_by(lupus_factor, time_window) %>%
  summarise(
    n_patients = n(),
    mean_value = mean(mean_value_patient, na.rm = TRUE),
    sd_value = sd(mean_value_patient, na.rm = TRUE),
    se_value = sd_value / sqrt(n_patients),
    ci_lower = mean_value - 1.96 * se_value,
    ci_upper = mean_value + 1.96 * se_value,
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

gfr_summary_3group <- gfr_patient_year %>%
  filter(!is.na(group_3level)) %>%
  group_by(group_3level, time_window) %>%
  summarise(
    n_patients = n(),
    mean_value = mean(mean_value_patient, na.rm = TRUE),
    sd_value = sd(mean_value_patient, na.rm = TRUE),
    se_value = sd_value / sqrt(n_patients),
    ci_lower = mean_value - 1.96 * se_value,
    ci_upper = mean_value + 1.96 * se_value,
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

cat("GFR data processed\n\n")

# ============================================================================
# PART 2: PROTEIN Trajectory (PCR + estimated from ACR)
# ============================================================================

cat("=== Processing Protein Data ===\n")

pcr_data <- PROTEINE_CREATININE_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    protein_date = as.Date(proteinuria_protein_creatinine_result_date),
    protein_value = proteinuria_protein_creatinine_result_as_number,
    years_from_index = as.numeric(difftime(protein_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index),
    source = "PCR_measured"
  ) %>%
  filter(time_window >= 0 & time_window <= 5) %>%
  filter(!is.na(protein_value) & protein_value >= 0 & protein_value < 10000)

acr_data <- ALBUMIN_CR_FIRST_99 %>%
  inner_join(cohort_ids, by = "mdcinternalpatientid") %>%
  mutate(
    protein_date = as.Date(albumin_creatinine_ratio_result_date),
    acr_value = albumin_creatinine_ratio_result_as_number,
    protein_value = acr_value * 1.5,
    years_from_index = as.numeric(difftime(protein_date, index_date, units = "days")) / 365.25,
    time_window = round(years_from_index),
    source = "PCR_from_ACR"
  ) %>%
  filter(time_window >= 0 & time_window <= 5) %>%
  filter(!is.na(protein_value) & protein_value >= 0 & protein_value < 10000)

protein_combined <- bind_rows(
  pcr_data %>% dplyr::select(mdcinternalpatientid, lupus_factor, group_3level, time_window, protein_value, source),
  acr_data %>% dplyr::select(mdcinternalpatientid, lupus_factor, group_3level, time_window, protein_value, source)
)

protein_patient_year <- protein_combined %>%
  group_by(mdcinternalpatientid, lupus_factor, group_3level, time_window) %>%
  summarise(median_value_patient = median(protein_value, na.rm = TRUE), .groups = "drop")

protein_summary_2group <- protein_patient_year %>%
  group_by(lupus_factor, time_window) %>%
  summarise(
    n_patients = n(),
    median_value = median(median_value_patient, na.rm = TRUE),
    q25 = quantile(median_value_patient, 0.25, na.rm = TRUE),
    q75 = quantile(median_value_patient, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

protein_summary_3group <- protein_patient_year %>%
  filter(!is.na(group_3level)) %>%
  group_by(group_3level, time_window) %>%
  summarise(
    n_patients = n(),
    median_value = median(median_value_patient, na.rm = TRUE),
    q25 = quantile(median_value_patient, 0.25, na.rm = TRUE),
    q75 = quantile(median_value_patient, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_patients >= 5)

cat("Protein data processed\n\n")

# ============================================================================
# FIGURE 1: Lupus vs Control (2 groups) WITH PANEL LABELS
# ============================================================================

cat("=== Creating Figure 1: Lupus vs Control ===\n\n")

y_min_gfr <- floor(min(gfr_summary_2group$ci_lower, na.rm = TRUE) / 5) * 5 - 5
y_max_gfr <- ceiling(max(gfr_summary_2group$ci_upper, na.rm = TRUE) / 5) * 5 + 5

# Panel A: GFR
p_gfr_2group_main <- ggplot(gfr_summary_2group, aes(x = time_window, y = mean_value, 
                                                      color = lupus_factor, shape = lupus_factor)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_2GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_2GROUP, name = "Group") +
  labs(
    title = "A. Mean Glomerular Filtration Rate Over Time",
    x = NULL,
    y = expression("Mean GFR (mL/min/1.73m"^2*")")
  ) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_continuous(limits = c(y_min_gfr, y_max_gfr)) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 10, b = 0, l = 10)
  )

n_risk_gfr_2group <- gfr_summary_2group %>%
  dplyr::select(lupus_factor, time_window, n_patients) %>%
  complete(lupus_factor, time_window = time_points_gfr) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_gfr_2group <- ggplot(n_risk_gfr_2group, aes(x = time_window, y = lupus_factor, 
                                                       label = n_patients, color = lupus_factor)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_2GROUP) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_discrete(limits = c("Control", "Lupus")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 10, b = 10, l = 10)
  )

p_gfr_2group_combined <- plot_grid(
  p_gfr_2group_main,
  p_n_risk_gfr_2group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Panel B: Protein
y_max_protein <- min(max(protein_summary_2group$q75, na.rm = TRUE) * 1.5, 500)

p_protein_2group_main <- ggplot(protein_summary_2group, aes(x = time_window, y = median_value, 
                                                              color = lupus_factor, shape = lupus_factor)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_2GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_2GROUP, name = "Group") +
  labs(
    title = "B. Median Protein-to-Creatinine Ratio Over Time",
    x = NULL,
    y = "Median Protein-to-Creatinine Ratio (mg/g)"
  ) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +
  scale_y_continuous(limits = c(0, y_max_protein)) +
  geom_hline(yintercept = 150, linetype = "dotted", color = jama_colors[4], linewidth = 0.5) +
  annotate("text", x = 5.7, y = 150, label = "150", color = jama_colors[4], size = 3, hjust = 0) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 30, b = 0, l = 10)
  )

n_risk_protein_2group <- protein_summary_2group %>%
  dplyr::select(lupus_factor, time_window, n_patients) %>%
  complete(lupus_factor, time_window = time_points_protein) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_protein_2group <- ggplot(n_risk_protein_2group, aes(x = time_window, y = lupus_factor, 
                                                               label = n_patients, color = lupus_factor)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_2GROUP) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +
  scale_y_discrete(limits = c("Control", "Lupus")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 30, b = 10, l = 10)
  )

p_protein_2group_combined <- plot_grid(
  p_protein_2group_main,
  p_n_risk_protein_2group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Combine A + B
figure1_combined <- plot_grid(
  p_gfr_2group_combined,
  p_protein_2group_combined,
  ncol = 2,
  rel_widths = c(1, 1)
)

print(figure1_combined)

ggsave("Figure1_GFR_Protein_Over_Time_2Group_JAMA.pdf", plot = figure1_combined, 
       width = 16, height = 7, bg = "white")
ggsave("Figure1_GFR_Protein_Over_Time_2Group_JAMA.png", plot = figure1_combined, 
       width = 16, height = 7, dpi = 300, bg = "white")

cat("✓ Figure 1 saved\n\n")

# ============================================================================
# FIGURE 2: 3-Group by Nephritis Status WITH PANEL LABELS
# ============================================================================

cat("=== Creating Figure 2: 3-Group Comparison ===\n\n")

y_min_gfr_3 <- floor(min(gfr_summary_3group$ci_lower, na.rm = TRUE) / 5) * 5 - 5
y_max_gfr_3 <- ceiling(max(gfr_summary_3group$ci_upper, na.rm = TRUE) / 5) * 5 + 5

# Panel A: GFR (3-group)
p_gfr_3group_main <- ggplot(gfr_summary_3group, aes(x = time_window, y = mean_value, 
                                                      color = group_3level, shape = group_3level)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_3GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_3GROUP, name = "Group") +
  labs(
    title = "A. Mean Glomerular Filtration Rate Over Time by Nephritis Status",
    x = NULL,
    y = expression("Mean GFR (mL/min/1.73m"^2*")")
  ) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_continuous(limits = c(y_min_gfr_3, y_max_gfr_3)) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 10, b = 0, l = 10)
  )

n_risk_gfr_3group <- gfr_summary_3group %>%
  dplyr::select(group_3level, time_window, n_patients) %>%
  complete(group_3level, time_window = time_points_gfr) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_gfr_3group <- ggplot(n_risk_gfr_3group, aes(x = time_window, y = group_3level, 
                                                       label = n_patients, color = group_3level)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_3GROUP) +
  scale_x_continuous(breaks = time_points_gfr, limits = c(-1.5, 5.5)) +
  scale_y_discrete(limits = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold", size = 9),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 10, b = 10, l = 10)
  )

p_gfr_3group_combined <- plot_grid(
  p_gfr_3group_main,
  p_n_risk_gfr_3group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Panel B: Protein (3-group)
y_max_protein_3 <- min(max(protein_summary_3group$q75, na.rm = TRUE) * 1.5, 500)

p_protein_3group_main <- ggplot(protein_summary_3group, aes(x = time_window, y = median_value, 
                                                              color = group_3level, shape = group_3level)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.15, linewidth = 0.5, alpha = 0.7) +
  geom_line(linewidth = 1) +
  geom_point(size = 3.5) +
  scale_color_manual(values = STANDARD_COLORS_3GROUP, name = "Group") +
  scale_shape_manual(values = STANDARD_SHAPES_3GROUP, name = "Group") +
  labs(
    title = "B. Median Protein-to-Creatinine Ratio Over Time by Nephritis Status",
    x = NULL,
    y = "Median Protein-to-Creatinine Ratio (mg/g)"
  ) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +
  scale_y_continuous(limits = c(0, y_max_protein_3)) +
  geom_hline(yintercept = 150, linetype = "dotted", color = jama_colors[2], linewidth = 0.5) +
  annotate("text", x = 5.7, y = 150, label = "150", color = jama_colors[2], size = 3, hjust = 0) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    axis.title = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(t = 10, r = 30, b = 0, l = 10)
  )

n_risk_protein_3group <- protein_summary_3group %>%
  dplyr::select(group_3level, time_window, n_patients) %>%
  complete(group_3level, time_window = time_points_protein) %>%
  mutate(n_patients = ifelse(is.na(n_patients), "", as.character(n_patients)))

p_n_risk_protein_3group <- ggplot(n_risk_protein_3group, aes(x = time_window, y = group_3level, 
                                                               label = n_patients, color = group_3level)) +
  geom_text(size = 3.5, fontface = "bold") +
  scale_color_manual(values = STANDARD_COLORS_3GROUP) +
  scale_x_continuous(breaks = time_points_protein, limits = c(-0.5, 5.5)) +
  scale_y_discrete(limits = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")) +
  labs(x = "Time since index date (years)", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "bold", size = 9),
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 30, b = 10, l = 10)
  )

p_protein_3group_combined <- plot_grid(
  p_protein_3group_main,
  p_n_risk_protein_3group,
  ncol = 1,
  rel_heights = c(4, 1),
  align = "v",
  axis = "lr"
)

# Combine A + B
figure2_combined <- plot_grid(
  p_gfr_3group_combined,
  p_protein_3group_combined,
  ncol = 2,
  rel_widths = c(1, 1)
)

print(figure2_combined)

ggsave("Figure2_GFR_Protein_Over_Time_3Group_JAMA.pdf", plot = figure2_combined, 
       width = 16, height = 7, bg = "white")
ggsave("Figure2_GFR_Protein_Over_Time_3Group_JAMA.png", plot = figure2_combined, 
       width = 16, height = 7, dpi = 300, bg = "white")

cat("✓ Figure 2 saved\n\n")

cat("\n=== GFR AND PROTEIN OVER TIME PLOTS COMPLETE ===\n")
```




#Table1 nephritis status
```{r}
# ============================================================================
# TABLE 1: BASELINE CHARACTERISTICS - LUPUS WITH vs WITHOUT NEPHRITIS (REVISED)
# ============================================================================

cat("\n=== Creating Table 1: Lupus Nephritis Comparison (REVISED) ===\n\n")

library(dplyr)
library(gtsummary)
library(flextable)
library(officer)
library(WeightIt)
library(cobalt)
library(survey)
library(lubridate)

# ============================================================================
# STEP 1: Create Lupus-Only Cohort with Nephritis Status
# ============================================================================

cat("Step 1: Creating lupus-only cohort...\n")

# Filter to lupus patients only
lupus_cohort <- cohort_weighted %>%
  filter(Lupus == 1) %>%
  # Join with nephritis data
  left_join(
    lupus_original_file %>% dplyr::select(patient_id, naparitis),
    by = "patient_id"
  ) %>%
  mutate(
    # Create nephritis exposure variable
    nephritis_exposure = case_when(
      naparitis == 1 ~ 1,
      is.na(naparitis) | naparitis == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    nephritis_factor = factor(nephritis_exposure,
                              levels = c(0, 1),
                              labels = c("Without Nephritis", "With Nephritis"))
  )

cat("Lupus cohort size:", nrow(lupus_cohort), "\n")
cat("Nephritis distribution:\n")
print(table(lupus_cohort$nephritis_factor, useNA = "always"))
cat("\n")

# ============================================================================
# STEP 2: Prepare Variables for Table 1 and Weighting
# ============================================================================

cat("Step 2: Preparing variables...\n")

# Prepare cohort with all variables matching the REVISED Table 1
lupus_cohort <- lupus_cohort %>%
  mutate(
    # Convert nephritis to factor for table
    nephritis_group = nephritis_factor,
    
    # Calculate current age (from birth_date to today)
    current_age = as.numeric(difftime(Sys.Date(), birth_date, units = "days")) / 365.25,
    
    # Convert gender to factor
    gender = factor(ifelse(gender_numeric == 1, "Female", "Male"), levels = c("Male", "Female")),
    
    # Socioeconomic status
    ses_category = factor(
      socioeconomic_score_three_level_scale,
      levels = c("Low", "Medium", "High")
    ),
    
    # BMI
    bmi = coalesce(bmi_first_hospital_bmi_numeric, bmi_first_community_bmi),
    
    # Clean BMI for weighting (same as original)
    bmi_clean = ifelse(bmi >= 10 & bmi <= 55, bmi, NA_real_),
    
    # Fix CCI variables: 0 = 0, anything else = 1
    cci_cerebrovascular_disease = case_when(
      is.na(cci_cerebrovascular_disease) ~ NA_real_,
      cci_cerebrovascular_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_chronic_pulmonary_disease = case_when(
      is.na(cci_chronic_pulmonary_disease) ~ NA_real_,
      cci_chronic_pulmonary_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_dementia = case_when(
      is.na(cci_dementia) ~ NA_real_,
      cci_dementia == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_malignancy = case_when(
      is.na(cci_malignancy) ~ NA_real_,
      cci_malignancy == 0 ~ 0,
      TRUE ~ 1
    ),
    cci_renal_disease = case_when(
      is.na(cci_renal_disease) ~ NA_real_,
      cci_renal_disease == 0 ~ 0,
      TRUE ~ 1
    ),
    
    # PROTEIN VARIABLE ONLY
    baseline_protein = pcr_combined,  # PCR in mg/g (includes converted from ACR)
    
    # NEW COMBINED MEDICATION VARIABLES
    # Biologic Treatments (Rituximab + Belimumab)
    biologic_treatments = ifelse(rituximab_medication == 1 | belimumab_medication == 1, 1, 0),
    
    # Calcineurin Inhibitors (Tacrolimus + Ciclosporin)
    calcineurin_inhibitors = ifelse(tacrolimus_medication == 1 | ciclosporin_medication == 1, 1, 0),
    
    # RAAS Inhibitors (ACE + ARB)
    raas_inhibitors = ifelse(ace_medication == 1 | arbs_medication == 1, 1, 0),
    
    # Antihypertensive Medications (Beta blockers + Calcium channel blockers + Diuretics)
    antihypertensive_medications = ifelse(
      beta_blockers_medication == 1 | 
      calcium_channel_blockers_medication == 1 | 
      diuretics_medication == 1, 
      1, 0
    ),
    
    # Diabetes Medications (SGLT2i + GLP1RA + Metformin + Insulin)
    diabetes_medications = ifelse(
      sglt_2_medication == 1 | 
      glp_1_medication == 1 | 
      metformin_medication == 1 | 
      insulin_medication == 1,
      1, 0
    ),
    
    # Create numeric versions for weighting
    diabetes_numeric = diabetes_diagnosis,
    hypertension_numeric = hypertension_diagnosis,
    baseline_gfr_numeric = baseline_gfr,
    cci_numeric = cci_charlson_score_total
  )

cat("Variables prepared\n\n")

# ============================================================================
# STEP 3: Calculate Propensity Scores and IPTW Weights (ATT)
# ============================================================================

cat("Step 3: Calculating IPTW weights (ATT estimand)...\n")

# Select covariates for weighting (same 8 as original analysis)
weighting_vars <- c("gender_numeric", "birth_year", "cci_numeric", 
                    "baseline_gfr_numeric", "bmi_clean", "ever_smoker",
                    "diabetes_numeric", "hypertension_numeric")

# Filter complete cases for weighting
lupus_weighted_data <- lupus_cohort %>%
  filter(complete.cases(across(all_of(c(weighting_vars, "nephritis_exposure")))))

cat("Complete cases for weighting:", nrow(lupus_weighted_data), "\n")
cat("  With Nephritis:", sum(lupus_weighted_data$nephritis_exposure == 1), "\n")
cat("  Without Nephritis:", sum(lupus_weighted_data$nephritis_exposure == 0), "\n\n")

# Calculate IPTW weights using WeightIt (ATT: Average Treatment Effect on Treated)
# Treated = With Nephritis
weightit_obj <- weightit(
  nephritis_exposure ~ gender_numeric + birth_year + cci_numeric + 
    baseline_gfr_numeric + bmi_clean + ever_smoker + 
    diabetes_numeric + hypertension_numeric,
  data = lupus_weighted_data,
  method = "ps",
  estimand = "ATT"  # Weight controls to match nephritis patients
)

# Add weights to dataset
lupus_weighted_data$iptw_nephritis <- weightit_obj$weights

cat("IPTW weights calculated\n")
cat("Effective sample size:\n")
cat("  With Nephritis (treated): ", 
    sum(lupus_weighted_data$nephritis_exposure == 1), " → ",
    round(sum(lupus_weighted_data$iptw_nephritis[lupus_weighted_data$nephritis_exposure == 1])), "\n")
cat("  Without Nephritis (control): ",
    sum(lupus_weighted_data$nephritis_exposure == 0), " → ",
    round(sum(lupus_weighted_data$iptw_nephritis[lupus_weighted_data$nephritis_exposure == 0])), "\n\n")

# ============================================================================
# STEP 4: Check Balance
# ============================================================================

cat("Step 4: Checking covariate balance...\n")

# Check balance
balance_stats <- bal.tab(weightit_obj, 
                         un = TRUE,
                         thresholds = c(m = 0.1))

print(balance_stats)

# Create love plot
pdf("Balance_Plot_IPTW_Lupus_Nephritis_REVISED.pdf", width = 10, height = 6)
love.plot(weightit_obj,
          binary = "std",
          thresholds = c(m = 0.1),
          abs = TRUE,
          var.order = "unadjusted",
          title = "Covariate Balance: Lupus With vs Without Nephritis (IPTW-ATT)")
dev.off()

cat("✓ Balance plot saved: Balance_Plot_IPTW_Lupus_Nephritis_REVISED.pdf\n\n")

# ============================================================================
# STEP 5: Define All Variables for Table 1
# ============================================================================

cat("Step 5: Defining table variables...\n")

# Define all variables - REVISED LIST
table1_vars <- c(
  "current_age",              # CHANGED: from age_at_index to current_age
  "gender",
  "birth_year",
  "ses_category",
  "bmi",
  "ever_smoker",
  "baseline_gfr",
  "baseline_gfr_category",
  "baseline_protein",
  "cci_charlson_score_total",
  "diabetes_diagnosis",
  "hypertension_diagnosis",
  "ischemic_heart_disease_diagnosis",
  "chf_diagnosis",
  "cci_cerebrovascular_disease",
  "cci_chronic_pulmonary_disease",
  "cci_dementia",
  "cci_malignancy",
  "cci_renal_disease",
  # Lupus medications
  "hydroxychloroquine_medication",
  "azathioprine_medication",
  "mycophenolate_medication",
  "methotrexate_medication",
  "prednisone_medication",
  "biologic_treatments",           # NEW: Combined RTX + Belimumab
  "calcineurin_inhibitors",        # NEW: Combined Tacrolimus + Ciclosporin
  # Cardiovascular medications
  "raas_inhibitors",               # NEW: Combined ACE + ARB
  "statins_medication",            # KEPT ALONE
  "aspirin_medication",            # KEPT ALONE
  "antihypertensive_medications",  # NEW: Beta blockers + CCB + Diuretics
  # Diabetes medications
  "diabetes_medications"           # NEW: All diabetes meds combined
)

# ============================================================================
# STEP 6: Create Table 1 - UNWEIGHTED
# ============================================================================

cat("Step 6: Building unweighted table...\n")

# Build UNWEIGHTED table
table1_unweighted <- lupus_weighted_data %>%
  dplyr::select(nephritis_group, all_of(table1_vars)) %>%
  tbl_summary(
    by = nephritis_group,
    missing = "no",
    
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      biologic_treatments ~ "1",
      calcineurin_inhibitors ~ "1",
      raas_inhibitors ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      antihypertensive_medications ~ "1",
      diabetes_medications ~ "1"
    ),
    
    label = list(
      current_age ~ "Current Age (years)",
      gender ~ "Sex (Female)",
      birth_year ~ "Birth Year",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_protein ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      biologic_treatments ~ "Biologic Treatments",
      calcineurin_inhibitors ~ "Calcineurin Inhibitors",
      raas_inhibitors ~ "Renin-Angiotensin-Aldosterone System Inhibitors",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      antihypertensive_medications ~ "Antihypertensive Medications",
      diabetes_medications ~ "Diabetes Medications"
    )
  ) %>%
  add_n() %>%
  add_difference(everything() ~ "smd") %>%
  modify_column_hide(ci) %>%
  modify_header(estimate ~ "**SMD**")

cat("✓ Unweighted table created\n\n")

# ============================================================================
# STEP 7: Create Table 1 - WEIGHTED (IPTW-ATT)
# ============================================================================

cat("Step 7: Building weighted table...\n")

# Create survey design object with IPTW weights
svy_design_nephritis <- svydesign(
  ids = ~1,
  data = lupus_weighted_data,
  weights = ~iptw_nephritis
)

# Build WEIGHTED table (SMD only)
table1_weighted_smd <- svy_design_nephritis %>%
  tbl_svysummary(
    by = nephritis_group,
    missing = "no",
    include = all_of(table1_vars),
    
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    
    value = list(
      gender ~ "Female",
      ever_smoker ~ "1",
      diabetes_diagnosis ~ "1",
      hypertension_diagnosis ~ "1",
      ischemic_heart_disease_diagnosis ~ "1",
      chf_diagnosis ~ "1",
      cci_cerebrovascular_disease ~ "1",
      cci_chronic_pulmonary_disease ~ "1",
      cci_dementia ~ "1",
      cci_malignancy ~ "1",
      cci_renal_disease ~ "1",
      hydroxychloroquine_medication ~ "1",
      azathioprine_medication ~ "1",
      mycophenolate_medication ~ "1",
      methotrexate_medication ~ "1",
      prednisone_medication ~ "1",
      biologic_treatments ~ "1",
      calcineurin_inhibitors ~ "1",
      raas_inhibitors ~ "1",
      statins_medication ~ "1",
      aspirin_medication ~ "1",
      antihypertensive_medications ~ "1",
      diabetes_medications ~ "1"
    ),
    
    label = list(
      current_age ~ "Current Age (years)",
      gender ~ "Sex (Female)",
      birth_year ~ "Birth Year",
      ses_category ~ "Socioeconomic Status",
      bmi ~ "Body Mass Index (kg/m²)",
      ever_smoker ~ "Ever Smoker",
      baseline_gfr ~ "Baseline Glomerular Filtration Rate (mL/min/1.73m²)",
      baseline_gfr_category ~ "Glomerular Filtration Rate Category",
      baseline_protein ~ "Baseline Protein-to-Creatinine Ratio (mg/g)",
      cci_charlson_score_total ~ "Charlson Comorbidity Index",
      diabetes_diagnosis ~ "Diabetes Mellitus",
      hypertension_diagnosis ~ "Hypertension",
      ischemic_heart_disease_diagnosis ~ "Ischemic Heart Disease",
      chf_diagnosis ~ "Congestive Heart Failure",
      cci_cerebrovascular_disease ~ "Cerebrovascular Disease",
      cci_chronic_pulmonary_disease ~ "Chronic Pulmonary Disease",
      cci_dementia ~ "Dementia",
      cci_malignancy ~ "Malignancy",
      cci_renal_disease ~ "Renal Disease",
      hydroxychloroquine_medication ~ "Hydroxychloroquine",
      azathioprine_medication ~ "Azathioprine",
      mycophenolate_medication ~ "Mycophenolate",
      methotrexate_medication ~ "Methotrexate",
      prednisone_medication ~ "Prednisone",
      biologic_treatments ~ "Biologic Treatments",
      calcineurin_inhibitors ~ "Calcineurin Inhibitors",
      raas_inhibitors ~ "Renin-Angiotensin-Aldosterone System Inhibitors",
      statins_medication ~ "Statins",
      aspirin_medication ~ "Aspirin",
      antihypertensive_medications ~ "Antihypertensive Medications",
      diabetes_medications ~ "Diabetes Medications"
    )
  ) %>%
  add_difference(everything() ~ "smd") %>%
  modify_column_hide(c(stat_1, stat_2, ci)) %>%
  modify_header(estimate ~ "**SMD (Weighted)**")

cat("✓ Weighted table created\n\n")

# ============================================================================
# STEP 8: Merge Tables Side by Side
# ============================================================================

cat("Step 8: Merging tables...\n")

# Merge unweighted and weighted SMD
table1_combined <- tbl_merge(
  tbls = list(table1_unweighted, table1_weighted_smd),
  tab_spanner = c("**Unweighted**", "**IPTW Weighted (ATT)**")
)

cat("✓ Tables merged\n\n")

# ============================================================================
# STEP 9: Export to Word
# ============================================================================

cat("Step 9: Exporting to Word document...\n")

# Convert to flextable
ft_table1 <- table1_combined %>%
  as_flex_table() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  bg(bg = "#2C2C2C", part = "header") %>%
  color(color = "white", part = "header") %>%
  align(align = "center", part = "header") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_table1 <- read_docx() %>%
  body_add_par("Table 1: Baseline Characteristics - Lupus With vs Without Nephritis", 
               style = "heading 1") %>%
  body_add_par(
    paste0(
      "Biologic Treatments include Rituximab and Belimumab. ",
      "Calcineurin Inhibitors include Tacrolimus and Ciclosporin. ",
      "RAAS Inhibitors include ACE inhibitors and ARBs. ",
      "Antihypertensive Medications include Beta blockers, Calcium channel blockers, and Diuretics. ",
      "Diabetes Medications include SGLT-2 inhibitors, GLP-1 agonists, Metformin, and Insulin."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_table1)

print(doc_table1, target = "Table1_Lupus_Nephritis_Comparison_IPTW_REVISED.docx")

cat("✓ Table saved: Table1_Lupus_Nephritis_Comparison_IPTW_REVISED.docx\n\n")

# ============================================================================
# Summary
# ============================================================================

cat("\n=== TABLE 1 COMPLETE: LUPUS NEPHRITIS COMPARISON (REVISED) ===\n\n")

cat("Files saved:\n")
cat("  1. Table1_Lupus_Nephritis_Comparison_IPTW_REVISED.docx\n")
cat("     - Side-by-side unweighted and IPTW-weighted comparison\n")
cat("     - Lupus patients WITH vs WITHOUT nephritis\n\n")
cat("  2. Balance_Plot_IPTW_Lupus_Nephritis_REVISED.pdf\n")
cat("     - Love plot showing covariate balance before/after weighting\n\n")

cat("Weighting approach: IPTW with ATT estimand\n")
cat("  - Treated group: Lupus WITH nephritis\n")
cat("  - Control group: Lupus WITHOUT nephritis\n")
cat("  - Controls weighted to match nephritis patients\n\n")

cat("Cohort sizes:\n")
cat("  Total lupus patients:", nrow(lupus_cohort), "\n")
cat("  With complete covariate data:", nrow(lupus_weighted_data), "\n")
cat("    - With nephritis:", sum(lupus_weighted_data$nephritis_exposure == 1), "\n")
cat("    - Without nephritis:", sum(lupus_weighted_data$nephritis_exposure == 0), "\n\n")

cat("=== SUMMARY OF CHANGES ===\n")
cat("1. ✓ Changed Age at Index → Current Age (calculated to today)\n")
cat("2. ✓ Dropped Cyclophosphamide\n")
cat("3. ✓ Combined Rituximab + Belimumab → Biologic Treatments\n")
cat("4. ✓ Combined Tacrolimus + Ciclosporin → Calcineurin Inhibitors\n")
cat("5. ✓ Combined ACE + ARB → RAAS Inhibitors\n")
cat("6. ✓ Combined Beta blockers + CCB + Diuretics → Antihypertensive Medications\n")
cat("7. ✓ Combined SGLT2i + GLP1RA + Metformin + Insulin → Diabetes Medications\n")
cat("8. ✓ Kept Statins and Aspirin as separate variables\n\n")

cat("New combined variable frequencies:\n")
cat("Biologic Treatments:", sum(lupus_weighted_data$biologic_treatments == 1, na.rm = TRUE), "\n")
cat("Calcineurin Inhibitors:", sum(lupus_weighted_data$calcineurin_inhibitors == 1, na.rm = TRUE), "\n")
cat("RAAS Inhibitors:", sum(lupus_weighted_data$raas_inhibitors == 1, na.rm = TRUE), "\n")
cat("Antihypertensive Medications:", sum(lupus_weighted_data$antihypertensive_medications == 1, na.rm = TRUE), "\n")
cat("Diabetes Medications:", sum(lupus_weighted_data$diabetes_medications == 1, na.rm = TRUE), "\n\n")

# Display the table
table1_combined
```

#outcomes analysis stretified by nephritis status

```{r}
# ============================================================================
# CHUNK 13B: Three-Level Outcome Analysis - SEPARATE TABLES (FIXED)
# ============================================================================

cat("\n=== CHUNK 13B: Three-Level Outcome Analysis (Separate Tables) ===\n\n")

# Packages --------------------------------------------------------------------
library(dplyr)
library(survival)
library(survey)
library(gtsummary)
library(flextable)
library(officer)

# ============================================================================
# STEP 1: Create Three-Level Group Variable in cohort_surv
# ============================================================================

cat("\nStep 1: Creating three-level group variable...\n")

# ---- Safety checks ----------------------------------------------------------
stopifnot(exists("cohort_surv"), exists("lupus_original_file"))

if (!("patient_id" %in% names(cohort_surv))) stop("cohort_surv is missing patient_id")
if (!("patient_id" %in% names(lupus_original_file))) stop("lupus_original_file is missing patient_id")
if (!("Lupus" %in% names(cohort_surv))) stop("cohort_surv is missing Lupus (0/1) indicator")
if (!("iptw" %in% names(cohort_surv))) warning("cohort_surv is missing 'iptw' weights (Cox models will fail)")

# Find nephritis column name in lupus_original_file (supports a few common variants)
nephritis_candidates <- c("naparitis", "nephritis", "nephritis_status", "nephritis_flag")
nephritis_col <- intersect(nephritis_candidates, names(lupus_original_file))[1]
if (is.na(nephritis_col)) {
  stop(
    "Could not find a nephritis column in lupus_original_file. ",
    "Expected one of: ", paste(nephritis_candidates, collapse = ", ")
  )
}

# Join cohort_surv with nephritis data (rename to a unique name to avoid suffix issues)
cohort_surv_3level <- cohort_surv %>%
  left_join(
    lupus_original_file %>%
      dplyr::select(patient_id, nephritis = all_of(nephritis_col)),
    by = "patient_id"
  ) %>%
  mutate(
    # Create 3-level group variable
    group_3level = case_when(
      Lupus == 0 ~ "Control",
      Lupus == 1 & nephritis == 1 ~ "Lupus with Nephritis",
      Lupus == 1 & (is.na(nephritis) | nephritis == 0) ~ "Lupus without Nephritis",
      TRUE ~ NA_character_
    ),
    # Factor with Control as reference
    group_3level_factor = factor(
      group_3level,
      levels = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")
    ),
    # Dummy variables for Cox regression
    lupus_without_nephritis = as.integer(group_3level == "Lupus without Nephritis"),
    lupus_with_nephritis    = as.integer(group_3level == "Lupus with Nephritis")
  )

cat("Three-level group distribution:\n")
print(table(cohort_surv_3level$group_3level_factor, useNA = "always"))
cat("\n")

# ============================================================================
# TABLE 1: Event Frequencies by Three Groups
# ============================================================================

cat("\n=== Creating Table 3A: Event Frequencies ===\n\n")

outcomes_for_table_3level <- cohort_surv_3level %>%
  dplyr::select(
    group_3level_factor,
    ckd_status,
    eskd_status,
    cvd_status,
    death_status
  )

tbl_frequencies_3level <-
  outcomes_for_table_3level %>%
  tbl_summary(
    by        = group_3level_factor,
    missing   = "no",
    statistic = all_dichotomous() ~ "{n} ({p}%)",
    label = list(
      ckd_status   ~ "Chronic Kidney Disease (CKD)",
      eskd_status  ~ "End-Stage Kidney Disease (ESKD)",
      cvd_status   ~ "Major Adverse Cardiovascular Events (MACE)",
      death_status ~ "All-Cause Mortality"
    ),
    value = list(
      ckd_status   ~ "1",
      eskd_status  ~ "1",
      cvd_status   ~ "1",
      death_status ~ "1"
    )
  ) %>%
  add_n() %>%
  add_overall() %>%
  add_p(test = all_categorical() ~ "chisq.test") %>%
  bold_labels() %>%
  modify_header(label ~ "**Outcome**") %>%
  modify_spanning_header(all_stat_cols() ~ "**Group**")

cat("\nFrequency Table Preview:\n")
tbl_frequencies_3level

# Export Table 3A to Word
ft_frequencies_3level <-
  tbl_frequencies_3level %>%
  as_flex_table() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  bg(bg = "#2C2C2C", part = "header") %>%
  color(color = "white", part = "header") %>%
  align(align = "center", part = "header") %>%
  align(j = 1, align = "left", part = "body") %>%
  autofit()

doc_frequencies <-
  read_docx() %>%
  body_add_par("Table 3A: Event Frequencies by Group", style = "heading 1") %>%
  body_add_par(
    paste0(
      "Number of events and percentages for each outcome by group. ",
      "Groups: Control, Lupus without Nephritis, and Lupus with Nephritis. ",
      "P-values from chi-square tests comparing the three groups. ",
      "MACE = Major Adverse Cardiovascular Events."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_frequencies_3level)

print(doc_frequencies, target = "Table3A_Event_Frequencies_ThreeLevel.docx")
cat("✓ Table 3A saved: Table3A_Event_Frequencies_ThreeLevel.docx\n\n")

# ============================================================================
# TABLE 2: IPTW-Weighted Cox Regression Results
# ============================================================================

cat("\n=== Creating Table 3B: IPTW-Weighted Cox Regression ===\n\n")

# Create survey design
svy_cox_3level <- svydesign(
  ids     = ~1,
  weights = ~iptw,
  data    = cohort_surv_3level
)

# Fit Cox models (Control = reference; 2 dummies)
cat("Running Cox regression models...\n")

cox_ckd_3level <- svycoxph(
  Surv(ckd_followup_years, ckd_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  design = svy_cox_3level
)

cox_eskd_3level <- svycoxph(
  Surv(eskd_followup_years, eskd_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  design = svy_cox_3level
)

cox_cvd_3level <- svycoxph(
  Surv(cvd_followup_years, cvd_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  design = svy_cox_3level
)

cox_death_3level <- svycoxph(
  Surv(death_followup_years, death_status) ~ lupus_without_nephritis + lupus_with_nephritis,
  design = svy_cox_3level
)

cat("✓ Cox models fitted\n\n")

# Helper: extract HR, CI, p-value by term name (more robust than index-based)
extract_hr_ci <- function(model, term) {
  cf <- coef(model)
  if (!(term %in% names(cf))) stop("Term not found in model coefficients: ", term)

  hr <- exp(unname(cf[term]))
  ci <- suppressMessages(confint(model))  # survey provides method
  ci_lower <- exp(ci[term, 1])
  ci_upper <- exp(ci[term, 2])

  sm <- summary(model)$coefficients
  pval <- sm[term, "Pr(>|z|)"]

  hr_ci <- sprintf("%.2f (%.2f-%.2f)", hr, ci_lower, ci_upper)
  pval_fmt <- ifelse(pval < 0.001, "<0.001", sprintf("%.3f", pval))

  list(hr = hr, ci_lower = ci_lower, ci_upper = ci_upper, hr_ci = hr_ci, pval = pval_fmt)
}

# Extract results
results_list <- list(
  CKD = list(
    without = extract_hr_ci(cox_ckd_3level, "lupus_without_nephritis"),
    with    = extract_hr_ci(cox_ckd_3level, "lupus_with_nephritis")
  ),
  ESKD = list(
    without = extract_hr_ci(cox_eskd_3level, "lupus_without_nephritis"),
    with    = extract_hr_ci(cox_eskd_3level, "lupus_with_nephritis")
  ),
  MACE = list(
    without = extract_hr_ci(cox_cvd_3level, "lupus_without_nephritis"),
    with    = extract_hr_ci(cox_cvd_3level, "lupus_with_nephritis")
  ),
  Mortality = list(
    without = extract_hr_ci(cox_death_3level, "lupus_without_nephritis"),
    with    = extract_hr_ci(cox_death_3level, "lupus_with_nephritis")
  )
)

cox_results_table <- data.frame(
  Outcome = c(
    "Chronic Kidney Disease (CKD)", "",
    "End-Stage Kidney Disease (ESKD)", "",
    "Major Adverse Cardiovascular Events (MACE)", "",
    "All-Cause Mortality", ""
  ),
  Comparison = rep(c("Lupus without Nephritis vs Control", "Lupus with Nephritis vs Control"), 4),
  HR_95CI = c(
    results_list$CKD$without$hr_ci,      results_list$CKD$with$hr_ci,
    results_list$ESKD$without$hr_ci,     results_list$ESKD$with$hr_ci,
    results_list$MACE$without$hr_ci,     results_list$MACE$with$hr_ci,
    results_list$Mortality$without$hr_ci,results_list$Mortality$with$hr_ci
  ),
  P_value = c(
    results_list$CKD$without$pval,       results_list$CKD$with$pval,
    results_list$ESKD$without$pval,      results_list$ESKD$with$pval,
    results_list$MACE$without$pval,      results_list$MACE$with$pval,
    results_list$Mortality$without$pval, results_list$Mortality$with$pval
  ),
  stringsAsFactors = FALSE
)

cat("\nCox Regression Results:\n")
print(cox_results_table)
cat("\n")

ft_cox_3level <-
  flextable(cox_results_table) %>%
  set_header_labels(
    Outcome = "Outcome",
    Comparison = "Comparison",
    HR_95CI = "Hazard Ratio (95% CI)",
    P_value = "P-value"
  ) %>%
  theme_booktabs() %>%
  fontsize(size = 10, part = "all") %>%
  bold(part = "header") %>%
  bg(bg = "#2C2C2C", part = "header") %>%
  color(color = "white", part = "header") %>%
  align(j = 1:2, align = "left", part = "all") %>%
  align(j = 3:4, align = "center", part = "all") %>%
  align(align = "center", part = "header") %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top") %>%
  bold(j = 1, bold = TRUE) %>%
  autofit() %>%
  bg(i = c(1:2), bg = "#F5F5F5") %>%
  bg(i = c(5:6), bg = "#F5F5F5")

doc_cox_3level <-
  read_docx() %>%
  body_add_par("Table 3B: IPTW-Weighted Cox Regression - Three-Level Analysis",
               style = "heading 1") %>%
  body_add_par(
    paste0(
      "Hazard ratios (HR) with 95% confidence intervals from IPTW-weighted Cox proportional hazards models. ",
      "Reference group: Control. ",
      "Comparisons: (1) Lupus without Nephritis vs Control; (2) Lupus with Nephritis vs Control. ",
      "IPTW = Inverse Probability of Treatment Weighting. ",
      "MACE = Major Adverse Cardiovascular Events."
    ),
    style = "Normal"
  ) %>%
  body_add_flextable(ft_cox_3level)

print(doc_cox_3level, target = "Table3B_Cox_Regression_ThreeLevel.docx")
cat("✓ Table 3B saved: Table3B_Cox_Regression_ThreeLevel.docx\n\n")

# ============================================================================
# BONUS: Print summary statistics
# ============================================================================

cat("\n=== Summary Statistics ===\n\n")

cat("Event counts by group (CKD):\n")
print(table(cohort_surv_3level$group_3level_factor, cohort_surv_3level$ckd_status))
cat("\n")

cat("Cox Regression Summary:\n")
cat("\nCKD:\n");        print(summary(cox_ckd_3level))
cat("\nESKD:\n");       print(summary(cox_eskd_3level))
cat("\nMACE:\n");       print(summary(cox_cvd_3level))
cat("\nMortality:\n");  print(summary(cox_death_3level))

cat("\n=== THREE-LEVEL OUTCOME ANALYSIS COMPLETE ===\n\n")
cat("Files saved:\n")
cat("  1) Table3A_Event_Frequencies_ThreeLevel.docx\n")
cat("  2) Table3B_Cox_Regression_ThreeLevel.docx\n\n")
cat("✓ Chunk 13B complete - Two separate tables created\n")
```


#KMplots final 
```{r}
# ============================================================================
# KAPLAN-MEIER PLOTS WITH PANEL LABELS (A, B, C, D)
# ============================================================================

cat("\n=== Creating KM plots with STANDARDIZED color palette and panel labels ===\n\n")

library(survival)
library(survminer)
library(gridExtra)
library(grid)
library(ggsci)
library(dplyr)

# ============================================================================
# DEFINE STANDARDIZED COLOR PALETTE
# ============================================================================

jama_colors <- pal_jama("default")(7)

STANDARD_COLORS_2GROUP <- c(jama_colors[1], jama_colors[2])
STANDARD_COLORS_3GROUP <- c(jama_colors[1], jama_colors[2], jama_colors[4])

cat("STANDARDIZED COLOR PALETTE:\n")
cat("  Control: #374E55 (dark teal)\n")
cat("  Lupus / Lupus without Nephritis: #DF8F44 (orange)\n")
cat("  Lupus with Nephritis: #B24745 (red)\n\n")

# ============================================================================
# FIGURE 3: 2-GROUP KM PLOTS (Control vs Lupus) WITH PANEL LABELS
# ============================================================================

cat("\n=== Creating Figure 3: 2-Group KM Plots ===\n\n")

# A. CKD
surv_ckd_weighted <- survfit(Surv(ckd_followup_years, ckd_status) ~ lupus_factor,
                              data = cohort_surv, weights = iptw)

km1_2group <- ggsurvplot(
  surv_ckd_weighted,
  data = cohort_surv,
  risk.table = TRUE,
  risk.table.height = 0.25,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "CKD-free survival",
  title = "A. Chronic Kidney Disease",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = STANDARD_COLORS_2GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3.5,
  tables.theme = theme_cleantable()
)

# B. ESKD
surv_eskd_weighted <- survfit(Surv(eskd_followup_years, eskd_status) ~ lupus_factor,
                               data = cohort_surv, weights = iptw)

km2_2group <- ggsurvplot(
  surv_eskd_weighted,
  data = cohort_surv,
  risk.table = TRUE,
  risk.table.height = 0.25,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "ESKD-free survival",
  title = "B. End-Stage Kidney Disease",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = STANDARD_COLORS_2GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3.5,
  tables.theme = theme_cleantable()
)

# C. MACE
surv_mace_weighted <- survfit(Surv(cvd_followup_years, cvd_status) ~ lupus_factor,
                              data = cohort_surv, weights = iptw)

km3_2group <- ggsurvplot(
  surv_mace_weighted,
  data = cohort_surv,
  risk.table = TRUE,
  risk.table.height = 0.25,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "MACE-free survival",
  title = "C. Major Adverse Cardiovascular Events",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = STANDARD_COLORS_2GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3.5,
  tables.theme = theme_cleantable()
)

# D. All-Cause Mortality
surv_death_weighted <- survfit(Surv(death_followup_years, death_status) ~ lupus_factor,
                                data = cohort_surv, weights = iptw)

km4_2group <- ggsurvplot(
  surv_death_weighted,
  data = cohort_surv,
  risk.table = TRUE,
  risk.table.height = 0.25,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "Overall survival",
  title = "D. All-Cause Mortality",
  legend.title = "",
  legend.labs = c("Control", "Lupus"),
  palette = STANDARD_COLORS_2GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3.5,
  tables.theme = theme_cleantable()
)

# Combine into 4-panel plot
cat("Combining 2-group plots into 4-panel figure...\n")

combined_km_2group <- arrange_ggsurvplots(
  list(km1_2group, km2_2group, km3_2group, km4_2group),
  nrow = 2,
  ncol = 2,
  print = FALSE
)

print(combined_km_2group)

ggsave("Figure3_KM_Curves_2Group_JAMA.pdf", 
       plot = combined_km_2group, 
       width = 14, height = 12, bg = "white")
ggsave("Figure3_KM_Curves_2Group_JAMA.png", 
       plot = combined_km_2group, 
       width = 14, height = 12, dpi = 300, bg = "white")

cat("✓ Figure 3 saved\n\n")

# ============================================================================
# FIGURE 4: 3-GROUP KM PLOTS WITH PANEL LABELS
# ============================================================================

cat("\n=== Creating Figure 4: 3-Group KM Plots ===\n\n")

# Create 3-level group variable if needed
if(!"group_3level_factor" %in% colnames(cohort_surv)) {
  cohort_surv_3level <- cohort_surv %>%
    left_join(lupus_original_file %>% dplyr::select(patient_id, naparitis), by = "patient_id") %>%
    mutate(
      group_3level = case_when(
        Lupus == 0 ~ "Control",
        Lupus == 1 & naparitis == 1 ~ "Lupus with Nephritis",
        Lupus == 1 & (is.na(naparitis) | naparitis == 0) ~ "Lupus without Nephritis",
        TRUE ~ NA_character_
      ),
      group_3level_factor = factor(
        group_3level,
        levels = c("Control", "Lupus without Nephritis", "Lupus with Nephritis")
      )
    )
} else {
  cohort_surv_3level <- cohort_surv
}

cat("3-level group distribution:\n")
print(table(cohort_surv_3level$group_3level_factor, useNA = "always"))
cat("\n")

# A. CKD (3-group)
surv_ckd_3level <- survfit(Surv(ckd_followup_years, ckd_status) ~ group_3level_factor,
                            data = cohort_surv_3level, weights = iptw)

km1_3group <- ggsurvplot(
  surv_ckd_3level,
  data = cohort_surv_3level,
  risk.table = TRUE,
  risk.table.height = 0.30,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "CKD-free survival",
  title = "A. Chronic Kidney Disease",
  legend.title = "",
  legend.labs = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"),
  palette = STANDARD_COLORS_3GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3,
  tables.theme = theme_cleantable()
)

# B. ESKD (3-group)
surv_eskd_3level <- survfit(Surv(eskd_followup_years, eskd_status) ~ group_3level_factor,
                             data = cohort_surv_3level, weights = iptw)

km2_3group <- ggsurvplot(
  surv_eskd_3level,
  data = cohort_surv_3level,
  risk.table = TRUE,
  risk.table.height = 0.30,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "ESKD-free survival",
  title = "B. End-Stage Kidney Disease",
  legend.title = "",
  legend.labs = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"),
  palette = STANDARD_COLORS_3GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3,
  tables.theme = theme_cleantable()
)

# C. MACE (3-group)
surv_mace_3level <- survfit(Surv(cvd_followup_years, cvd_status) ~ group_3level_factor,
                            data = cohort_surv_3level, weights = iptw)

km3_3group <- ggsurvplot(
  surv_mace_3level,
  data = cohort_surv_3level,
  risk.table = TRUE,
  risk.table.height = 0.30,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "MACE-free survival",
  title = "C. Major Adverse Cardiovascular Events",
  legend.title = "",
  legend.labs = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"),
  palette = STANDARD_COLORS_3GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3,
  tables.theme = theme_cleantable()
)

# D. All-Cause Mortality (3-group)
surv_death_3level <- survfit(Surv(death_followup_years, death_status) ~ group_3level_factor,
                              data = cohort_surv_3level, weights = iptw)

km4_3group <- ggsurvplot(
  surv_death_3level,
  data = cohort_surv_3level,
  risk.table = TRUE,
  risk.table.height = 0.30,
  pval = TRUE,
  pval.method = FALSE,
  conf.int = TRUE,
  xlim = c(0, 8),
  break.time.by = 2,
  xlab = "Time (years)",
  ylab = "Overall survival",
  title = "D. All-Cause Mortality",
  legend.title = "",
  legend.labs = c("Control", "Lupus without Nephritis", "Lupus with Nephritis"),
  palette = STANDARD_COLORS_3GROUP,
  ggtheme = theme_minimal(),
  font.main = c(12, "bold"),
  font.x = c(10),
  font.y = c(10),
  font.tickslab = c(9),
  risk.table.fontsize = 3,
  tables.theme = theme_cleantable()
)

# Combine into 4-panel plot
cat("Combining 3-group plots into 4-panel figure...\n")

combined_km_3group <- arrange_ggsurvplots(
  list(km1_3group, km2_3group, km3_3group, km4_3group),
  nrow = 2,
  ncol = 2,
  print = FALSE
)

print(combined_km_3group)

ggsave("Figure4_KM_Curves_3Group_JAMA.pdf", 
       plot = combined_km_3group, 
       width = 14, height = 12, bg = "white")
ggsave("Figure4_KM_Curves_3Group_JAMA.png", 
       plot = combined_km_3group, 
       width = 14, height = 12, dpi = 300, bg = "white")

cat("✓ Figure 4 saved\n\n")

# ============================================================================
# Summary
# ============================================================================

cat("\n=== KAPLAN-MEIER PLOTS WITH PANEL LABELS COMPLETE ===\n\n")

cat("Files saved:\n")
cat("  Figure 3: Figure3_KM_Curves_2Group_JAMA.pdf/.png\n")
cat("  Figure 4: Figure4_KM_Curves_3Group_JAMA.pdf/.png\n\n")

cat("Panel labels integrated into titles:\n")
cat("  A. Chronic Kidney Disease\n")
cat("  B. End-Stage Kidney Disease\n")
cat("  C. Major Adverse Cardiovascular Events\n")
cat("  D. All-Cause Mortality\n\n")

cat("✓ All figures complete with standardized colors and panel labels\n")
```


